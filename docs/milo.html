<!DOCTYPE html>

<html>
<head>
  <title>milo.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>milo.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>A minimalist browser framework that binds HTML elements to JS components and components to models.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="main-modules">Main Modules</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <ul>
<li>.<a href="#loader">loader</a> - loading subviews into page</li>
<li>.<a href="#binder">binder</a> - components instantiation and binding of DOM elements to them</li>
<li>.<a href="#minder">minder</a> - data reactivity, one or two way, shallow or deep, as you like it</li>
<li>.<a href="#mail">mail</a> - applicaiton level messenger</li>
<li>.<a href="#config">config</a> - milo configuration</li>
<li>.<a href="#utils">utils</a> - logger, request, check, etc.</li>
<li>.<a href="#classes">classes</a> - foundation classes and class registries</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> milo = {
	loader: require(<span class="string">'./loader'</span>),
	binder: require(<span class="string">'./binder'</span>),
	mail: require(<span class="string">'./mail'</span>),
	config: require(<span class="string">'./config'</span>),
	util: require(<span class="string">'./util'</span>),
	classes: require(<span class="string">'./classes'</span>)
}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>included facets</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>require(<span class="string">'./components/c_facets/Dom'</span>);
require(<span class="string">'./components/c_facets/Data'</span>);
require(<span class="string">'./components/c_facets/Frame'</span>);
require(<span class="string">'./components/c_facets/Events'</span>);
require(<span class="string">'./components/c_facets/Template'</span>);
require(<span class="string">'./components/c_facets/Container'</span>);
require(<span class="string">'./components/c_facets/ModelFacet'</span>);
require(<span class="string">'./components/c_facets/Drag'</span>);
require(<span class="string">'./components/c_facets/Drop'</span>);
require(<span class="string">'./components/c_facets/Editable'</span>);
require(<span class="string">'./components/c_facets/Split'</span>);
require(<span class="string">'./components/c_facets/List'</span>);
require(<span class="string">'./components/c_facets/Item'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>included components</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>require(<span class="string">'./components/classes/View'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>export for node/browserify</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">if</span> (<span class="keyword">typeof</span> module == <span class="string">'object'</span> &amp;&amp; module.exports)	
	module.exports = milo;</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>global milo for browser</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">if</span> (<span class="keyword">typeof</span> window == <span class="string">'object'</span>)
	window.milo = milo;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p><a name="loader"></a></p>
<h2 id="milo-loader">milo.loader</h2>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>milo.loader loads subviews into the page. It scans the document inside rootElement looking for ml-load attribute that should contain URL of HTML fragment that will be loaded inside the element with this attribute.</p>
<p>milo.loader returns the map of references to elements with their IDs used as keys.</p>
<h3 id="example">Example</h3>
<p>html</p>
<pre><code class="lang-html">&lt;body&gt;
    &lt;div id=&quot;view1&quot; ml-load=&quot;view1.html&quot;&gt;&lt;/div&gt;
    &lt;div&gt;
        &lt;div id=&quot;view2&quot; ml-load=&quot;view3.html&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;</code></pre>
<p>javascript</p>
<pre><code class="lang-javascript">var views = milo.loader(); // document.body is used by default
log(views);
// {
//     view1: div with id=&quot;view1&quot;
//     view2: div with id=&quot;view2&quot;
// }</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> miloMail = require(<span class="string">'./mail'</span>)
	, request = require(<span class="string">'./util/request'</span>)
	, logger = require(<span class="string">'./util/logger'</span>)
	, utilDom = require(<span class="string">'./util/dom'</span>)
	, config = require(<span class="string">'./config'</span>)
	, LoadAttribute = require(<span class="string">'./attribute/a_load'</span>)
	, LoaderError = require(<span class="string">'./util/error'</span>).Loader;


module.exports = loader;


<span class="function"><span class="keyword">function</span> <span class="title">loader</span><span class="params">(rootEl, callback)</span> {</span>	
	miloMail.onMessage(<span class="string">'domready'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
		<span class="keyword">if</span> (<span class="keyword">typeof</span> rootEl == <span class="string">'function'</span>) {
			callback = rootEl;
			rootEl = <span class="literal">undefined</span>;
		}

		rootEl = rootEl || document.body;

		miloMail.postMessage(<span class="string">'loader'</span>, { state: <span class="string">'started'</span> });
		_loader(rootEl, <span class="function"><span class="keyword">function</span><span class="params">(views)</span> {</span>
			miloMail.postMessage(<span class="string">'loader'</span>, { 
				state: <span class="string">'finished'</span>,
				views: views
			});
			callback(views);
		});
	});
}


<span class="function"><span class="keyword">function</span> <span class="title">_loader</span><span class="params">(rootEl, callback)</span> {</span>
	<span class="keyword">var</span> loadElements = rootEl.querySelectorAll(<span class="string">'['</span> + config.attrs.load + <span class="string">']'</span>);

	<span class="keyword">var</span> views = {}
		, totalCount = loadElements.length
		, loadedCount = <span class="number">0</span>;

	Array.prototype.forEach.call(loadElements, <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
		loadView(el, <span class="function"><span class="keyword">function</span><span class="params">(err)</span> {</span>
			views[el.id] = err || el;
			loadedCount++;
			<span class="keyword">if</span> (loadedCount == totalCount)
				callback(views);
		});
	});
};


<span class="function"><span class="keyword">function</span> <span class="title">loadView</span><span class="params">(el, callback)</span> {</span>
	<span class="keyword">if</span> (utilDom.filterNodeListByType(el.childNodes, <span class="number">1</span>).length)
		<span class="keyword">throw</span> <span class="keyword">new</span> LoaderError(<span class="string">'can\'t load html into element that is not empty'</span>);

	<span class="keyword">var</span> attr = <span class="keyword">new</span> LoadAttribute(el);

	attr.parse().validate();

	request.get(attr.loadUrl, <span class="function"><span class="keyword">function</span><span class="params">(err, html)</span> {</span>
		<span class="keyword">if</span> (err) {
			err.message = err.message || <span class="string">'can\'t load file '</span> + attr.loadUrl;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>logger.error(err.message);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			callback(err);
			<span class="keyword">return</span>;
		}

		el.innerHTML = html;
		callback(<span class="literal">null</span>);
	});
}</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p><a name="binder"></a></p>
<h2 id="milo-binder">milo.binder</h2>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>milo.binder recursively scans the document tree inside scopeElement
(document.body by default) looking for <strong>ml-bind</strong> attribute that should
contain the class, additional facets and the name of the component
that should be created and bound to the element.</p>
<p>Possible values of <strong>ml-bind</strong> attribute:</p>
<ul>
<li>:myView - only component name. An instance of Component class will be
created without any facets.</li>
<li>View:myView - class and component name. An instance of View class will be
created.</li>
<li>[Events, Data]:myView - facets and component name. An instance of Component
class will be created with the addition of facets Events and Data.</li>
<li>View[Events, Data]:myView - class, facet(s) and component name. An instance of
View class will be created with the addition of facets Events and Data.</li>
</ul>
<p>Created components will be returned as map with their names used as keys.
Names within the scope should be therefore unique.</p>
<p>If the component has <em>Scope</em> facet, children of this element will be stored on the <em>Scope</em> facet of this element as properties. Names of components within
the scope whould be unique, but they can be the same as the names of components
in outer scope (or some other).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> miloMail = require(<span class="string">'./mail'</span>)
	, componentsRegistry = require(<span class="string">'./components/c_registry'</span>)
	, facetsRegistry = require(<span class="string">'./components/c_facets/cf_registry'</span>)
	, Component = componentsRegistry.get(<span class="string">'Component'</span>)
	, ComponentInfo = require(<span class="string">'./components/c_info'</span>)
	, Scope = require(<span class="string">'./components/scope'</span>)
	, BindAttribute = require(<span class="string">'./attribute/a_bind'</span>)
	, BinderError = require(<span class="string">'./util/error'</span>).Binder
	, _ = require(<span class="string">'mol-proto'</span>)
	, check = require(<span class="string">'./util/check'</span>)
	, utilDom = require(<span class="string">'./util/dom'</span>)
	, Match =  check.Match;


binder.scan = scan;
binder.create = create;
binder.twoPass = twoPass;


module.exports = binder;


<span class="function"><span class="keyword">function</span> <span class="title">binder</span><span class="params">(scopeEl)</span> {</span>
	<span class="keyword">return</span> createBinderScope(scopeEl, <span class="function"><span class="keyword">function</span><span class="params">(scope, el, attr)</span> {</span>
		<span class="keyword">var</span> info = <span class="keyword">new</span> ComponentInfo(scope, el, attr);
		<span class="keyword">return</span> Component.create(info);
	});
}</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>bind in two passes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">twoPass</span><span class="params">(scopeEl)</span> {</span>
	<span class="keyword">var</span> scopeEl = scopeEl || document.body;
	<span class="keyword">var</span> scanScope = binder.scan(scopeEl);
	<span class="keyword">return</span> binder.create(scanScope);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>scan DOM for BindAttribute</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">scan</span><span class="params">(scopeEl)</span> {</span>
	<span class="keyword">return</span> createBinderScope(scopeEl, <span class="function"><span class="keyword">function</span><span class="params">(scope, el, attr)</span> {</span>
		<span class="keyword">return</span> <span class="keyword">new</span> ComponentInfo(scope, el, attr);
	});
}</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>create bound components</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">(scanScope)</span> {</span>
	<span class="keyword">var</span> scope = <span class="keyword">new</span> Scope(scanScope._rootEl);

	scanScope._each(<span class="function"><span class="keyword">function</span><span class="params">(compInfo)</span> {</span>
		<span class="keyword">var</span> aComponent = Component.create(compInfo);

		scope._add(aComponent, aComponent.name);
		<span class="keyword">if</span> (aComponent.container)
			aComponent.container.scope = create(compInfo.container.scope);
	});

	<span class="keyword">return</span> scope;
}


<span class="function"><span class="keyword">function</span> <span class="title">createBinderScope</span><span class="params">(scopeEl, scopeObjectFactory)</span> {</span>
	<span class="keyword">var</span> scopeEl = scopeEl || document.body
		, scope = <span class="keyword">new</span> Scope(scopeEl);

	createScopeForElement(scope, scopeEl);
	
	<span class="keyword">return</span> scope;


	<span class="function"><span class="keyword">function</span> <span class="title">createScopeForElement</span><span class="params">(scope, el)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>get element&#39;s binding attribute (ml-bind by default)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="keyword">var</span> attr = <span class="keyword">new</span> BindAttribute(el);

		<span class="keyword">if</span> (attr.node) {
			<span class="keyword">var</span> scopeObject = scopeObjectFactory(scope, el, attr)
				, isContainer = <span class="keyword">typeof</span> scopeObject != <span class="string">'undefined'</span> &amp;&amp; scopeObject.container;
		}

		<span class="keyword">if</span> (el.childNodes &amp;&amp; el.childNodes.length) {
			<span class="keyword">var</span> innerScope = createScopeForChildren(el);

			<span class="keyword">if</span> (innerScope._length()) {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>attach inner attributes to the current one (create a new scope) ...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="keyword">if</span> (isContainer) {
					scopeObject.container.scope = innerScope;
					innerScope._hostObject = scopeObject.container;
				} <span class="keyword">else</span> <span class="comment">// or keep them in the current scope</span>
					scope._copy(innerScope);;
			}
		}

		<span class="keyword">if</span> (isContainer &amp;&amp; ! scopeObject.container.scope)
			scopeObject.container.scope = <span class="keyword">new</span> Scope(el);

		<span class="keyword">if</span> (scopeObject)
			scope._add(scopeObject, attr.compName);

		postChildrenBoundMessage(el);

		<span class="keyword">return</span> scopeObject;


		<span class="function"><span class="keyword">function</span> <span class="title">postChildrenBoundMessage</span><span class="params">(el)</span> {</span>
			<span class="keyword">var</span> elComp = Component.getComponent(el);
			<span class="keyword">if</span> (elComp)
				elComp.postMessage(<span class="string">'childrenbound'</span>);
		}
	}


	<span class="function"><span class="keyword">function</span> <span class="title">createScopeForChildren</span><span class="params">(containerEl)</span> {</span>
		<span class="keyword">var</span> scope = <span class="keyword">new</span> Scope(containerEl);
		Array.prototype.forEach.call(utilDom.filterNodeListByType(containerEl.childNodes, <span class="number">1</span>), <span class="function"><span class="keyword">function</span><span class="params">(node)</span> {</span>
			createScopeForElement(scope, node);
		});
		<span class="keyword">return</span> scope;
	}
}</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p><a name="classes"></a></p>
<h2 id="milo-classes">milo.classes</h2>

            </div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>This module contains foundation classes and class registries.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> classes = {
	Facet: require(<span class="string">'./facets/f_class'</span>),
	Component: require(<span class="string">'./components/c_class'</span>),
	ComponentFacet: require(<span class="string">'./components/c_facet'</span>),
	ClassRegistry: require(<span class="string">'./abstract/registry'</span>),
	facetsRegistry: require(<span class="string">'./components/c_facets/cf_registry'</span>),
	componentsRegistry: require(<span class="string">'./components/c_registry'</span>),
	Model: require(<span class="string">'./model'</span>)
};

module.exports = classes;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p><a name="config"></a></p>
<h2 id="milo-config">milo.config</h2>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>It is the function that allows to change milo configurations and also
access them on config&#39;s properties.</p>
<pre><code class="lang-javascript">milo.config({
    attrs: {
        bind: &#39;ml-bind&#39;,
        load: &#39;ml-load&#39;
    }
});</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> _ = require(<span class="string">'mol-proto'</span>);


module.exports = config;

<span class="function"><span class="keyword">function</span> <span class="title">config</span><span class="params">(options)</span> {</span>
	_.deepExtend(config, options);
}

config({
	attrs: {
		bind: <span class="string">'ml-bind'</span>,
		load: <span class="string">'ml-load'</span>
	},
	componentRef: <span class="string">'___milo_component'</span>
});</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p><a name="minder"></a></p>
<h2 id="milo-minder">milo.minder</h2>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>This module will be used to create and manage reactive connections between 
components and models (and, potentially, other models).</p>
<p>It is not developed yet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> Connector = require(<span class="string">'./model/connector'</span>);


model.exports = minder;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>can accept array pf arrays to set up many</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">minder</span><span class="params">(ds1, mode, ds2, options)</span> {</span>
	<span class="keyword">if</span> (Array.isArray(ds1)) {
		<span class="keyword">var</span> connDescriptions = ds1;
		<span class="keyword">var</span> connectors = connDescriptions.map(<span class="function"><span class="keyword">function</span><span class="params">(descr)</span> {</span>
			<span class="keyword">return</span> <span class="keyword">new</span> Connector(descr[<span class="number">0</span>], descr[<span class="number">1</span>], descr[<span class="number">2</span>], descr[<span class="number">3</span>]);
		});
	} <span class="keyword">else</span>
		<span class="keyword">return</span> <span class="keyword">new</span> Connector(ds1, mode, ds2, options);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p><a name="mail"></a></p>
<h2 id="milo-mail">milo.mail</h2>

            </div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>It is an application level messenger that is an instance of Messenger class.</p>
<p>At the moment, in addition to application messages that you define, you can subscribe to <strong>domready</strong> message that is guaranteed to fire once,
even if DOM was ready at the time of the subscription.</p>
<p>Messaging between frames is likely to be exposed via milo.mail.</p>
<p>See Messenger.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> Messenger = require(<span class="string">'../messenger'</span>)
	, MailMessageSource = require(<span class="string">'./mail_source'</span>);


<span class="keyword">var</span> mailMsgSource = <span class="keyword">new</span> MailMessageSource();

<span class="keyword">var</span> miloMail = <span class="keyword">new</span> Messenger(<span class="literal">undefined</span>, <span class="literal">undefined</span>, mailMsgSource);

module.exports = miloMail;</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p><a name="utils"></a></p>
<h2 id="milo-utils">milo.utils</h2>

            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> util = {
	logger: require(<span class="string">'./logger'</span>),
	request: require(<span class="string">'./request'</span>),
	check: require(<span class="string">'./check'</span>),
	error: require(<span class="string">'./error'</span>),
	count: require(<span class="string">'./count'</span>),
	dom: require(<span class="string">'./dom'</span>)
};

module.exports = util;</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p><a name="utils-logger"></a></p>
<h2 id="milo-utils-logger">milo.utils.logger</h2>

            </div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Application logger that has error, warn, info and debug
methods, that can be suppressed by setting log level.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> Logger = require(<span class="string">'./logger_class'</span>);

<span class="keyword">var</span> logger = <span class="keyword">new</span> Logger({ level: <span class="number">3</span> });

module.exports = logger;</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <h3 id="logger-class">Logger Class</h3>
<p>Properties:</p>
<ul>
<li><p>level</p>
<ul>
<li>0 - error</li>
<li>1 - warn</li>
<li>2 - info</li>
<li>3 - debug (default)</li>
</ul>
</li>
<li><p>enabled</p>
<p>true by default. Set to false to disable all logging in browser console.</p>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> _ = require(<span class="string">'mol-proto'</span>);


<span class="comment">/**
 * Log levels.
 */</span>

<span class="keyword">var</span> levels = [
    <span class="string">'error'</span>,
    <span class="string">'warn'</span>,
    <span class="string">'info'</span>,
    <span class="string">'debug'</span>
];

<span class="keyword">var</span> maxLevelLength = Math.max.apply(Math, levels.map(<span class="function"><span class="keyword">function</span><span class="params">(level)</span> {</span> <span class="keyword">return</span> level.length; }));

<span class="comment">/**
 * Colors for log levels.
 */</span>

<span class="keyword">var</span> colors = [
    <span class="number">31</span>,
    <span class="number">33</span>,
    <span class="number">36</span>,
    <span class="number">90</span>
];

<span class="comment">/**
 * Pads the nice output to the longest log level.
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">pad</span> <span class="params">(str)</span> {</span>
    <span class="keyword">if</span> (str.length &lt; maxLevelLength)
        <span class="keyword">return</span> str + <span class="keyword">new</span> Array(maxLevelLength - str.length + <span class="number">1</span>).join(<span class="string">' '</span>);

    <span class="keyword">return</span> str;
};

<span class="comment">/**
 * Logger (console).
 *
 * @api public
 */</span>

<span class="keyword">var</span> Logger = <span class="function"><span class="keyword">function</span> <span class="params">(opts)</span> {</span>
    opts = opts || {}
    <span class="keyword">this</span>.colors = opts.colors;
    <span class="keyword">this</span>.level = opts.level || <span class="number">3</span>;
    <span class="keyword">this</span>.enabled = opts.enabled || <span class="literal">true</span>;
    <span class="keyword">this</span>.logPrefix = opts.logPrefix || <span class="string">''</span>;
    <span class="keyword">this</span>.logPrefixColor = opts.logPrefixColor;
};


<span class="comment">/**
 * Log method.
 *
 * @api public
 */</span>

Logger.prototype.log = <span class="function"><span class="keyword">function</span> <span class="params">(type)</span> {</span>
    <span class="keyword">var</span> index = levels.indexOf(type);

    <span class="keyword">if</span> (index &gt; <span class="keyword">this</span>.level || ! <span class="keyword">this</span>.enabled)
        <span class="keyword">return</span> <span class="keyword">this</span>;

    console.log.apply(
          console
        , [<span class="keyword">this</span>.logPrefixColor
             ? <span class="string">'   \x1B['</span> + <span class="keyword">this</span>.logPrefixColor + <span class="string">'m'</span> + <span class="keyword">this</span>.logPrefix + <span class="string">'  -\x1B[39m'</span>
             : <span class="keyword">this</span>.logPrefix
          ,<span class="keyword">this</span>.colors
             ? <span class="string">' \x1B['</span> + colors[index] + <span class="string">'m'</span> + pad(type) + <span class="string">' -\x1B[39m'</span>
             : type + <span class="string">':'</span>
          ].concat(_.toArray(arguments).slice(<span class="number">1</span>))
    );

    <span class="keyword">return</span> <span class="keyword">this</span>;
};

<span class="comment">/**
 * Generate methods.
 */</span>

levels.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(name)</span> {</span>
    Logger.prototype[name] = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">this</span>.log.apply(<span class="keyword">this</span>, [name].concat(_.toArray(arguments)));
    };
});


module.exports = Logger;</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p><a name="utils-count"></a></p>
<h2 id="milo-utils-count">milo.utils.count</h2>

            </div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> count = <span class="number">0</span>;

<span class="function"><span class="keyword">function</span> <span class="title">componentCount</span><span class="params">()</span> {</span>
	count++;
	<span class="keyword">return</span> count;
}

componentCount.get = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
	<span class="keyword">return</span> count;
}

module.exports = componentCount;</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p><a name="utils-dom"></a></p>
<h2 id="milo-utils-dom">milo.utils.dom</h2>

            </div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;


module.exports = {
	filterNodeListByType: filterNodeListByType
};</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>type 1: html element, type 3: text</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">filterNodeListByType</span><span class="params">(nodeList, type)</span> {</span>
	<span class="keyword">var</span> filteredNodes = [];
	Array.prototype.forEach.call(nodeList, <span class="function"><span class="keyword">function</span> <span class="params">(node)</span> {</span>
		<span class="keyword">if</span> (node.nodeType == type)
			filteredNodes.push(node);
	});
	<span class="keyword">return</span> filteredNodes;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p><a name="utils-error"></a></p>
<h2 id="milo-utils-error">milo.utils.error</h2>

            </div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> _ = require(<span class="string">'mol-proto'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>module exports error classes for all names defined in this array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> errorClassNames = [<span class="string">'AbstractClass'</span>, <span class="string">'Mixin'</span>, <span class="string">'Messenger'</span>, <span class="string">'ComponentDataSource'</span>,
					   <span class="string">'Attribute'</span>, <span class="string">'Binder'</span>, <span class="string">'Loader'</span>, <span class="string">'MailMessageSource'</span>, <span class="string">'Facet'</span>,
					   <span class="string">'Scope'</span>, <span class="string">'EditableEventsSource'</span>, <span class="string">'Model'</span>, <span class="string">'DomFacet'</span>, <span class="string">'EditableFacet'</span>,
					   <span class="string">'List'</span>, <span class="string">'Connector'</span>];

<span class="keyword">var</span> error = {
	toBeImplemented: toBeImplemented,
	createClass: createErrorClass
};

errorClassNames.forEach(<span class="function"><span class="keyword">function</span><span class="params">(name)</span> {</span>
	error[name] = createErrorClass(name + <span class="string">'Error'</span>);
});

module.exports = error;


<span class="function"><span class="keyword">function</span> <span class="title">createErrorClass</span><span class="params">(errorClassName)</span> {</span>
	<span class="keyword">var</span> ErrorClass;
	eval(<span class="string">'ErrorClass = function '</span> + errorClassName + <span class="string">'(message) { \
			this.name = "'</span> + errorClassName + <span class="string">'"; \
			this.message = message || "There was an error"; \
		}'</span>);
	_.makeSubclass(ErrorClass, Error);

	<span class="keyword">return</span> ErrorClass;
}


<span class="function"><span class="keyword">function</span> <span class="title">toBeImplemented</span><span class="params">()</span> {</span>
	<span class="keyword">throw</span> <span class="keyword">new</span> error.AbstractClass(<span class="string">'calling the method of an absctract class MessageSource'</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p><a name="utils-check"></a></p>
<h2 id="milo-utils-check">milo.utils.check</h2>

            </div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Check is a module for parameters checking extracted from Meteor framework.</p>
<p>It allows to both document and to check parameter types in your function
making code both readable and stable.</p>
<h3 id="usage">Usage</h3>
<pre><code>var check = milo.check
    , Match = check.Match;

function My(name, obj, cb) {
    // if any of checks fail an error will be thrown
    check(name, String);
    check(obj, Match.ObjectIncluding({ options: Object }));
    check(cb, Function);

    // ... your code
}</code></pre>
<p>See <a href="http://docs.meteor.com/#match">Meteor docs</a> to see how it works</p>
<h3 id="patterns">Patterns</h3>
<p>All patterns and functions described in Meteor docs work.</p>
<p>Unlike in Meteor, Object pattern matches instance of any class,
not only plain object.</p>
<p>In addition to patterns described in Meteor docs the following patterns are implemented</p>
<ul>
<li><p>Match.<strong>ObjectHash</strong>(<em>pattern</em>)</p>
<p>Matches an object where all properties match a given pattern</p>
</li>
<li><p>Match.<strong>Subclass</strong>(<em>constructor</em> [, <em>matchThisClassToo</em>])</p>
<p>Matches a class that is a subclass of a given class. If the second parameter
is true, it will also match the class itself.</p>
<p>Without this pattern to check if <em>MySubclass</em> is a subclass of <em>MyClass</em>
you would have to use</p>
<pre><code>check(MySubclass, Match.Where(function() {
    return MySubclass.prototype instanceof MyClass;
});</code></pre>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Things we explicitly do NOT support:</p>
<ul>
<li>heterogenous arrays</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> _ = require(<span class="string">'mol-proto'</span>);

<span class="keyword">var</span> check = <span class="function"><span class="keyword">function</span> <span class="params">(value, pattern)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Record that check got called, if somebody cared.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">try</span> {
    checkSubtree(value, pattern);
  } <span class="keyword">catch</span> (err) {
    <span class="keyword">if</span> ((err <span class="keyword">instanceof</span> Match.Error) &amp;&amp; err.path)
      err.message += <span class="string">" in field "</span> + err.path;
    <span class="keyword">throw</span> err;
  }
};
module.exports = check;

<span class="keyword">var</span> Match = check.Match = {
  Optional: <span class="function"><span class="keyword">function</span> <span class="params">(pattern)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">new</span> Optional(pattern);
  },
  OneOf: <span class="function"><span class="keyword">function</span> <span class="params">(<span class="comment">/*arguments*/</span>)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">new</span> OneOf(arguments);
  },
  Any: [<span class="string">'__any__'</span>],
  Where: <span class="function"><span class="keyword">function</span> <span class="params">(condition)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">new</span> Where(condition);
  },
  ObjectIncluding: <span class="function"><span class="keyword">function</span> <span class="params">(pattern)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">new</span> ObjectIncluding(pattern);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Matches only signed 32-bit integers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Integer: [<span class="string">'__integer__'</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Matches hash (object) with values matching pattern</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ObjectHash: <span class="function"><span class="keyword">function</span><span class="params">(pattern)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">new</span> ObjectHash(pattern);
  },

  Subclass: <span class="function"><span class="keyword">function</span><span class="params">(Superclass, matchSuperclassToo)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">new</span> Subclass(Superclass, matchSuperclassToo);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>XXX matchers should know how to describe themselves for errors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Error: TypeError,</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Meteor.makeErrorType(&quot;Match.Error&quot;, function (msg) {
this.message = &quot;Match error: &quot; + msg;
The path of the value that failed to match. Initially empty, this gets
populated by catching and rethrowing the exception as it goes back up the
stack.
E.g.: &quot;vals[3].entity.created&quot;
this.path = &quot;&quot;;
If this gets sent over DDP, don&#39;t give full internal details but at least
provide something better than 500 Internal server error.
  this.sanitizedError = new Meteor.Error(400, &quot;Match failed&quot;);
}),</p>
<p>Tests to see if value matches pattern. Unlike check, it merely returns true
or false (unless an error other than Match.Error was thrown).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  test: <span class="function"><span class="keyword">function</span> <span class="params">(value, pattern)</span> {</span>
    <span class="keyword">try</span> {
      checkSubtree(value, pattern);
      <span class="keyword">return</span> <span class="literal">true</span>;
    } <span class="keyword">catch</span> (e) {
      <span class="keyword">if</span> (e <span class="keyword">instanceof</span> Match.Error)
        <span class="keyword">return</span> <span class="literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Rethrow other errors.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">throw</span> e;
    }
  }
};

<span class="function"><span class="keyword">function</span> <span class="title">Optional</span><span class="params">(pattern)</span> {</span>
  <span class="keyword">this</span>.pattern = pattern;
};

<span class="function"><span class="keyword">function</span> <span class="title">OneOf</span><span class="params">(choices)</span> {</span>
  <span class="keyword">if</span> (choices.length == <span class="number">0</span>)
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Must provide at least one choice to Match.OneOf"</span>);
  <span class="keyword">this</span>.choices = choices;
};

<span class="function"><span class="keyword">function</span> <span class="title">Where</span><span class="params">(condition)</span> {</span>
  <span class="keyword">this</span>.condition = condition;
};

<span class="function"><span class="keyword">function</span> <span class="title">ObjectIncluding</span><span class="params">(pattern)</span> {</span>
  <span class="keyword">this</span>.pattern = pattern;
};

<span class="function"><span class="keyword">function</span> <span class="title">ObjectHash</span><span class="params">(pattern)</span> {</span>
  <span class="keyword">this</span>.pattern = pattern;
};

<span class="function"><span class="keyword">function</span> <span class="title">Subclass</span><span class="params">(Superclass, matchSuperclassToo)</span> {</span>
  <span class="keyword">this</span>.Superclass = Superclass;
  <span class="keyword">this</span>.matchSuperclass = matchSuperclassToo;
};

<span class="keyword">var</span> typeofChecks = [
  [String, <span class="string">"string"</span>],
  [Number, <span class="string">"number"</span>],
  [Boolean, <span class="string">"boolean"</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>While we don&#39;t allow undefined in JSON, this is good for optional
arguments with OneOf.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  [<span class="literal">undefined</span>, <span class="string">"undefined"</span>]
];

<span class="function"><span class="keyword">function</span> <span class="title">checkSubtree</span><span class="params">(value, pattern)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Match anything!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> (pattern === Match.Any)
    <span class="keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Basic atomic types.
Do not match boxed objects (e.g. String, Boolean)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; typeofChecks.length; ++i) {
    <span class="keyword">if</span> (pattern === typeofChecks[i][<span class="number">0</span>]) {
      <span class="keyword">if</span> (<span class="keyword">typeof</span> value === typeofChecks[i][<span class="number">1</span>])
        <span class="keyword">return</span>;
      <span class="keyword">throw</span> <span class="keyword">new</span> Match.Error(<span class="string">"Expected "</span> + typeofChecks[i][<span class="number">1</span>] + <span class="string">", got "</span> +
                            <span class="keyword">typeof</span> value);
    }
  }
  <span class="keyword">if</span> (pattern === <span class="literal">null</span>) {
    <span class="keyword">if</span> (value === <span class="literal">null</span>)
      <span class="keyword">return</span>;
    <span class="keyword">throw</span> <span class="keyword">new</span> Match.Error(<span class="string">"Expected null, got "</span> + JSON.stringify(value));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Match.Integer is special type encoded with array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> (pattern === Match.Integer) {</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>There is no consistent and reliable way to check if variable is a 64-bit
integer. One of the popular solutions is to get reminder of division by 1
but this method fails on really large floats with big precision.
E.g.: 1.348192308491824e+23 % 1 === 0 in V8
Bitwise operators work consistantly but always cast variable to 32-bit
signed integer according to JavaScript specs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">"number"</span> &amp;&amp; (value | <span class="number">0</span>) === value)
      <span class="keyword">return</span>
    <span class="keyword">throw</span> <span class="keyword">new</span> Match.Error(<span class="string">"Expected Integer, got "</span>
                + (value <span class="keyword">instanceof</span> Object ? JSON.stringify(value) : value));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>&quot;Object&quot; is shorthand for Match.ObjectIncluding({});</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> (pattern === Object)
    pattern = Match.ObjectIncluding({});</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Array (checked AFTER Any, which is implemented as an Array).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> (pattern <span class="keyword">instanceof</span> Array) {
    <span class="keyword">if</span> (pattern.length !== <span class="number">1</span>)
      <span class="keyword">throw</span> Error(<span class="string">"Bad pattern: arrays must have one type element"</span> +
                  JSON.stringify(pattern));
    <span class="keyword">if</span> (!Array.isArray(value)) {
      <span class="keyword">throw</span> <span class="keyword">new</span> Match.Error(<span class="string">"Expected array, got "</span> + JSON.stringify(value));
    }

    value.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(valueElement, index)</span> {</span>
      <span class="keyword">try</span> {
        checkSubtree(valueElement, pattern[<span class="number">0</span>]);
      } <span class="keyword">catch</span> (err) {
        <span class="keyword">if</span> (err <span class="keyword">instanceof</span> Match.Error) {
          err.path = _prependPath(index, err.path);
        }
        <span class="keyword">throw</span> err;
      }
    });
    <span class="keyword">return</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Arbitrary validation checks. The condition can return false or throw a
Match.Error (ie, it can internally use check()) to fail.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> (pattern <span class="keyword">instanceof</span> Where) {
    <span class="keyword">if</span> (pattern.condition(value))
      <span class="keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>XXX this error is terrible</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">throw</span> <span class="keyword">new</span> Match.Error(<span class="string">"Failed Match.Where validation"</span>);
  }


  <span class="keyword">if</span> (pattern <span class="keyword">instanceof</span> Optional)
    pattern = Match.OneOf(<span class="literal">undefined</span>, pattern.pattern);

  <span class="keyword">if</span> (pattern <span class="keyword">instanceof</span> OneOf) {
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; pattern.choices.length; ++i) {
      <span class="keyword">try</span> {
        checkSubtree(value, pattern.choices[i]);</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>No error? Yay, return.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span>;
      } <span class="keyword">catch</span> (err) {</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Other errors should be thrown. Match errors just mean try another
choice.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (!(err <span class="keyword">instanceof</span> Match.Error))
          <span class="keyword">throw</span> err;
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>XXX this error is terrible</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">throw</span> <span class="keyword">new</span> Match.Error(<span class="string">"Failed Match.OneOf or Match.Optional validation"</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>A function that isn&#39;t something we special-case is assumed to be a
constructor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> (pattern <span class="keyword">instanceof</span> Function) {
    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> pattern)
      <span class="keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>XXX what if .name isn&#39;t defined</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">throw</span> <span class="keyword">new</span> Match.Error(<span class="string">"Expected "</span> + pattern.constructor.name);
  }

  <span class="keyword">var</span> unknownKeysAllowed = <span class="literal">false</span>;
  <span class="keyword">if</span> (pattern <span class="keyword">instanceof</span> ObjectIncluding) {
    unknownKeysAllowed = <span class="literal">true</span>;
    pattern = pattern.pattern;
  }

  <span class="keyword">if</span> (pattern <span class="keyword">instanceof</span> ObjectHash) {
    <span class="keyword">var</span> keyPattern = pattern.pattern;
    <span class="keyword">var</span> emptyHash = <span class="literal">true</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> value) {
      emptyHash = <span class="literal">false</span>;
      check(value[key], keyPattern);
    }
    <span class="keyword">if</span> (emptyHash)
      <span class="keyword">throw</span> <span class="keyword">new</span> Match.Error(<span class="string">"Expected "</span> + pattern.constructor.name);
    <span class="keyword">return</span>;
  }

  <span class="keyword">if</span> (pattern <span class="keyword">instanceof</span> Subclass) {
    <span class="keyword">var</span> Superclass = pattern.Superclass;
    <span class="keyword">if</span> (pattern.matchSuperclass &amp;&amp; value == Superclass) 
      <span class="keyword">return</span>;
    <span class="keyword">if</span> (! (value.prototype <span class="keyword">instanceof</span> Superclass))
      <span class="keyword">throw</span> <span class="keyword">new</span> Match.Error(<span class="string">"Expected "</span> + pattern.constructor.name + <span class="string">" of "</span> + Superclass.name);
    <span class="keyword">return</span>;
  }

  <span class="keyword">if</span> (<span class="keyword">typeof</span> pattern !== <span class="string">"object"</span>)
    <span class="keyword">throw</span> Error(<span class="string">"Bad pattern: unknown pattern type"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>An object, with required and optional keys. Note that this does NOT do
structural matches against objects of special types that happen to match
the pattern: this really needs to be a plain old {Object}!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> (<span class="keyword">typeof</span> value !== <span class="string">'object'</span>)
    <span class="keyword">throw</span> <span class="keyword">new</span> Match.Error(<span class="string">"Expected object, got "</span> + <span class="keyword">typeof</span> value);
  <span class="keyword">if</span> (value === <span class="literal">null</span>)
    <span class="keyword">throw</span> <span class="keyword">new</span> Match.Error(<span class="string">"Expected object, got null"</span>);

  <span class="keyword">var</span> requiredPatterns = {};
  <span class="keyword">var</span> optionalPatterns = {};

  _.eachKey(pattern, <span class="function"><span class="keyword">function</span><span class="params">(subPattern, key)</span> {</span>
    <span class="keyword">if</span> (pattern[key] <span class="keyword">instanceof</span> Optional)
      optionalPatterns[key] = pattern[key].pattern;
    <span class="keyword">else</span>
      requiredPatterns[key] = pattern[key];
  }, <span class="keyword">this</span>, <span class="literal">true</span>);

  _.eachKey(value, <span class="function"><span class="keyword">function</span><span class="params">(subValue, key)</span> {</span>
    <span class="keyword">var</span> subValue = value[key];
    <span class="keyword">try</span> {
      <span class="keyword">if</span> (requiredPatterns.hasOwnProperty(key)) {
        checkSubtree(subValue, requiredPatterns[key]);
        <span class="keyword">delete</span> requiredPatterns[key];
      } <span class="keyword">else</span> <span class="keyword">if</span> (optionalPatterns.hasOwnProperty(key)) {
        checkSubtree(subValue, optionalPatterns[key]);
      } <span class="keyword">else</span> {
        <span class="keyword">if</span> (!unknownKeysAllowed)
          <span class="keyword">throw</span> <span class="keyword">new</span> Match.Error(<span class="string">"Unknown key"</span>);
      }
    } <span class="keyword">catch</span> (err) {
      <span class="keyword">if</span> (err <span class="keyword">instanceof</span> Match.Error)
        err.path = _prependPath(key, err.path);
      <span class="keyword">throw</span> err;
    }
  }, <span class="keyword">this</span>, <span class="literal">true</span>);

  _.eachKey(requiredPatterns, <span class="function"><span class="keyword">function</span><span class="params">(value, key)</span> {</span>
    <span class="keyword">throw</span> <span class="keyword">new</span> Match.Error(<span class="string">"Missing key '"</span> + key + <span class="string">"'"</span>);
  }, <span class="keyword">this</span>, <span class="literal">true</span>);
};


<span class="keyword">var</span> _jsKeywords = [<span class="string">"do"</span>, <span class="string">"if"</span>, <span class="string">"in"</span>, <span class="string">"for"</span>, <span class="string">"let"</span>, <span class="string">"new"</span>, <span class="string">"try"</span>, <span class="string">"var"</span>, <span class="string">"case"</span>,
  <span class="string">"else"</span>, <span class="string">"enum"</span>, <span class="string">"eval"</span>, <span class="string">"false"</span>, <span class="string">"null"</span>, <span class="string">"this"</span>, <span class="string">"true"</span>, <span class="string">"void"</span>, <span class="string">"with"</span>,
  <span class="string">"break"</span>, <span class="string">"catch"</span>, <span class="string">"class"</span>, <span class="string">"const"</span>, <span class="string">"super"</span>, <span class="string">"throw"</span>, <span class="string">"while"</span>, <span class="string">"yield"</span>,
  <span class="string">"delete"</span>, <span class="string">"export"</span>, <span class="string">"import"</span>, <span class="string">"public"</span>, <span class="string">"return"</span>, <span class="string">"static"</span>, <span class="string">"switch"</span>,
  <span class="string">"typeof"</span>, <span class="string">"default"</span>, <span class="string">"extends"</span>, <span class="string">"finally"</span>, <span class="string">"package"</span>, <span class="string">"private"</span>, <span class="string">"continue"</span>,
  <span class="string">"debugger"</span>, <span class="string">"function"</span>, <span class="string">"arguments"</span>, <span class="string">"interface"</span>, <span class="string">"protected"</span>, <span class="string">"implements"</span>,
  <span class="string">"instanceof"</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Assumes the base of path is already escaped properly
returns key + base</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">_prependPath</span><span class="params">(key, base)</span> {</span>
  <span class="keyword">if</span> ((<span class="keyword">typeof</span> key) === <span class="string">"number"</span> || key.match(<span class="regexp">/^[0-9]+$/</span>))
    key = <span class="string">"["</span> + key + <span class="string">"]"</span>;
  <span class="keyword">else</span> <span class="keyword">if</span> (!key.match(<span class="regexp">/^[a-z_$][0-9a-z_$]*$/i</span>) || _jsKeywords.indexOf(key) != -<span class="number">1</span>)
    key = JSON.stringify([key]);

  <span class="keyword">if</span> (base &amp;&amp; base[<span class="number">0</span>] !== <span class="string">"["</span>)
    <span class="keyword">return</span> key + <span class="string">'.'</span> + base;
  <span class="keyword">return</span> key + base;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p><a name="utils-request"></a></p>
<h2 id="milo-utils-request">milo.utils.request</h2>

            </div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>example</p>
<pre><code class="lang-javascript">var request = milo.utils.request
    , opts: { method: &#39;GET&#39; };

request(url, opts, function(err, data) {
    log(data);
});

request.get(url, function(err, data) {
    log(data);
});</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> _ = require(<span class="string">'mol-proto'</span>);

module.exports = request;</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>TODO add error statuses</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> okStatuses = [<span class="string">'200'</span>, <span class="string">'304'</span>];


<span class="function"><span class="keyword">function</span> <span class="title">request</span><span class="params">(url, opts, callback)</span> {</span>
	<span class="keyword">var</span> req = <span class="keyword">new</span> XMLHttpRequest();
	req.open(opts.method, url, <span class="literal">true</span>); <span class="comment">// what true means?</span>
	req.onreadystatechange = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
		<span class="keyword">if</span> (req.readyState == <span class="number">4</span> &amp;&amp; req.statusText.toUpperCase() == <span class="string">'OK'</span> )
			callback(<span class="literal">null</span>, req.responseText, req);</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>else
    callback(req.status, req.responseText, req);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	};
	req.send(<span class="literal">null</span>);
}

_.extend(request, {
	get: get
});


<span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">(url, callback)</span> {</span>
	request(url, { method: <span class="string">'GET'</span> }, callback);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p><a name="facet-c"></a></p>
<h2 id="facet-class">facet class</h2>

            </div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> _ = require(<span class="string">'mol-proto'</span>);

module.exports = Facet;

<span class="function"><span class="keyword">function</span> <span class="title">Facet</span><span class="params">(owner, config)</span> {</span>
	<span class="keyword">this</span>.owner = owner;
	<span class="keyword">this</span>.config = config || {};
	<span class="keyword">this</span>.init.apply(<span class="keyword">this</span>, arguments);
}

_.extendProto(Facet, {
	init: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>}
});</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p><a name="facet-o"></a></p>
<h2 id="facetted-object-class">facetted object class</h2>

            </div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Component class is based on an abstract <code>FacetedObject</code> class that can be
applied to any domain where objects can be represented via collection of facets
(a facet is an object of a certain class, it holds its own configuration,
data and methods).</p>
<p>In a way, facets pattern is an inversion of adapter pattern - while the latter
allows finding a class/methods that has specific functionality, faceted object
is simply constructed to have these functionalities. In this way it is possible
to create a virtually unlimited number of component classes with a very limited
number of building blocks without having any hierarchy of classes - all components
inherit directly from Component class.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> Facet = require(<span class="string">'./f_class'</span>)
	, _ = require(<span class="string">'mol-proto'</span>)
	, check = require(<span class="string">'../util/check'</span>)
	, Match = check.Match
	, FacetError = require(<span class="string">'../util/error'</span>).Facet;

module.exports = FacetedObject;</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>abstract class for faceted object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">FacetedObject</span><span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>TODO write a test to check that facets are created if configuration isn&#39;t passed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">var</span> facetsConfig = <span class="keyword">this</span>.facetsConfig || {};

	<span class="keyword">var</span> facetsDescriptors = {}
		, facets = {};

	<span class="keyword">if</span> (<span class="keyword">this</span>.constructor == FacetedObject)		
		<span class="keyword">throw</span> <span class="keyword">new</span> FacetError(<span class="string">'FacetedObject is an abstract class, can\'t be instantiated'</span>);

	<span class="keyword">if</span> (<span class="keyword">this</span>.facetsClasses)
		_.eachKey(<span class="keyword">this</span>.facetsClasses, instantiateFacet, <span class="keyword">this</span>, <span class="literal">true</span>);

	Object.defineProperties(<span class="keyword">this</span>, facetsDescriptors);
	Object.defineProperty(<span class="keyword">this</span>, <span class="string">'facets'</span>, { value: facets });</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>calling init if it is defined in the class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">if</span> (<span class="keyword">this</span>.init)
		<span class="keyword">this</span>.init.apply(<span class="keyword">this</span>, arguments);

	<span class="function"><span class="keyword">function</span> <span class="title">instantiateFacet</span><span class="params">(FacetClass, fct)</span> {</span>
		<span class="keyword">var</span> facetOpts = facetsConfig[fct];

		facets[fct] = <span class="keyword">new</span> FacetClass(<span class="keyword">this</span>, facetOpts);

		facetsDescriptors[fct] = {
			enumerable: <span class="literal">true</span>,
			value: facets[fct]
		};
	}
}

_.extendProto(FacetedObject, {
	addFacet: addFacet
});


<span class="function"><span class="keyword">function</span> <span class="title">addFacet</span><span class="params">(FacetClass, facetOpts, facetName)</span> {</span>
	check(FacetClass, Function);
	check(facetName, Match.Optional(String));

	facetName = _.firstLowerCase(facetName || FacetClass.name);

	<span class="keyword">var</span> protoFacets = <span class="keyword">this</span>.constructor.prototype.facetsClasses;

	<span class="keyword">if</span> (protoFacets &amp;&amp; protoFacets[facetName])
		<span class="keyword">throw</span> <span class="keyword">new</span> FacetError(<span class="string">'facet '</span> + facetName + <span class="string">' is already part of the class '</span> + <span class="keyword">this</span>.constructor.name);

	<span class="keyword">if</span> (<span class="keyword">this</span>[facetName])
		<span class="keyword">throw</span> <span class="keyword">new</span> FacetError(<span class="string">'facet '</span> + facetName + <span class="string">' is already present in object'</span>);

	<span class="keyword">var</span> newFacet = <span class="keyword">this</span>.facets[facetName] = <span class="keyword">new</span> FacetClass(<span class="keyword">this</span>, facetOpts);

	Object.defineProperty(<span class="keyword">this</span>, facetName, {
		enumerable: <span class="literal">true</span>,
		value: newFacet
	});

	<span class="keyword">return</span> newFacet;
}


FacetedObject.hasFacet = <span class="function"><span class="keyword">function</span> <span class="title">hasFacet</span><span class="params">(facetName)</span> {</span>
	<span class="keyword">var</span> protoFacets = <span class="keyword">this</span>.prototype.facetsClasses;
	<span class="keyword">return</span> protoFacets &amp;&amp; protoFacets[facetName];
}</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>factory that creates classes (constructors) from the map of facets
these classes inherit from FacetedObject</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>FacetedObject.createFacetedClass = <span class="function"><span class="keyword">function</span> <span class="params">(name, facetsClasses, facetsConfig)</span> {</span>
	check(name, String);
	check(facetsClasses, Match.ObjectHash(Match.Subclass(Facet, <span class="literal">true</span>)));
	check(facetsConfig, Match.Optional(Object));

	<span class="keyword">if</span> (facetsConfig)
		_.eachKey(facetsConfig, <span class="function"><span class="keyword">function</span><span class="params">(fctConfig, fctName)</span> {</span>
			<span class="keyword">if</span> (! facetsClasses.hasOwnProperty(fctName))
				<span class="keyword">throw</span> <span class="keyword">new</span> FacetError(<span class="string">'configuration for facet ('</span> + fctName + <span class="string">') passed that is not in class'</span>);
		});

	<span class="keyword">var</span> FacetedClass = _.createSubclass(<span class="keyword">this</span>, name, <span class="literal">true</span>);

	_.extendProto(FacetedClass, {
		facetsClasses: facetsClasses,
		facetsConfig: facetsConfig
	});
	<span class="keyword">return</span> FacetedClass;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p><a name="components-facet-registry"></a></p>
<h3 id="component-facet-registry">component facet registry</h3>
<p>An instance of ClassRegistry class that is used by milo to register and find facets.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> ClassRegistry = require(<span class="string">'../../abstract/registry'</span>)
	, ComponentFacet = require(<span class="string">'../c_facet'</span>);

<span class="keyword">var</span> facetsRegistry = <span class="keyword">new</span> ClassRegistry(ComponentFacet);

facetsRegistry.add(ComponentFacet);

module.exports = facetsRegistry;</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>TODO - refactor components registry test into a function
that tests a registry with a given foundation class
Make test for this registry based on this function</p>
<p><a name="components-facets-container"></a></p>
<h3 id="container-facet">container facet</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> ComponentFacet = require(<span class="string">'../c_facet'</span>)
	, binder = require(<span class="string">'../../binder'</span>)
	, _ = require(<span class="string">'mol-proto'</span>)
	, facetsRegistry = require(<span class="string">'./cf_registry'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>container facet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Container = _.createSubclass(ComponentFacet, <span class="string">'Container'</span>);

_.extendProto(Container, {
	init: initContainer,
	_bind: _bindComponents,</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>add: addChildComponents</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>});

facetsRegistry.add(Container);

module.exports = Container;


<span class="function"><span class="keyword">function</span> <span class="title">initContainer</span><span class="params">()</span> {</span>
	ComponentFacet.prototype.init.apply(<span class="keyword">this</span>, arguments);
	<span class="keyword">this</span>.scope = {};
}


<span class="function"><span class="keyword">function</span> <span class="title">_bindComponents</span><span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>TODO
this function should re-bind rather than bind all internal elements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">this</span>.scope = binder(<span class="keyword">this</span>.owner.el);
}


<span class="function"><span class="keyword">function</span> <span class="title">addChildComponents</span><span class="params">(childComponents)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>TODO
this function should intelligently re-bind existing components to
new elements (if they changed) and re-bind previously bound events to the same
event handlers
or maybe not, if this function is only used by binder to add new elements...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	_.extend(<span class="keyword">this</span>.scope, childComponents);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p><a name="components-facets-data"></a></p>
<h3 id="data-facet">data facet</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> ComponentFacet = require(<span class="string">'../c_facet'</span>)
	, facetsRegistry = require(<span class="string">'./cf_registry'</span>)

	, Messenger = require(<span class="string">'../../messenger'</span>)
	, ComponentDataSource = require(<span class="string">'../c_message_sources/component_data_source'</span>)
	, pathUtils = require(<span class="string">'../../model/path_utils'</span>)

	, _ = require(<span class="string">'mol-proto'</span>)
	, logger = require(<span class="string">'../../util/logger'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>data model connection facet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Data = _.createSubclass(ComponentFacet, <span class="string">'Data'</span>);

_.extendProto(Data, {
	init: init,
	get: get,
	set: set,
	path: path,
	_setScalarValue: _setScalarValue,
	_getScalarValue: _getScalarValue,
	_postDataChanged: _postDataChanged,
	_wrapMessengerMethods: pathUtils.wrapMessengerMethods
});

facetsRegistry.add(Data);

module.exports = Data;</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>these methods will be wrapped to support &quot;*&quot; pattern subscriptions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> dataFacetMethodsToWrap = [<span class="string">'on'</span>, <span class="string">'off'</span>, <span class="string">'onMessages'</span>, <span class="string">'offMessages'</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Initialize Data Facet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span> {</span>
	ComponentFacet.prototype.init.apply(<span class="keyword">this</span>, arguments);

	<span class="keyword">var</span> proxyCompDataSourceMethods = {
		value: <span class="string">'value'</span>,
		trigger: <span class="string">'trigger'</span>
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>instead of this.owner should pass model? Where it is set?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">var</span> compDataSource = <span class="keyword">new</span> ComponentDataSource(<span class="keyword">this</span>, proxyCompDataSourceMethods, <span class="keyword">this</span>.owner);
	<span class="keyword">this</span>._setMessageSource(compDataSource);

	_.defineProperty(<span class="keyword">this</span>, <span class="string">'_compDataSource'</span>, compDataSource);

	<span class="keyword">this</span>._path = <span class="string">'.'</span> + <span class="keyword">this</span>.owner.name;

	<span class="keyword">this</span>._wrapMessengerMethods(dataFacetMethodsToWrap);

	<span class="keyword">this</span>.on(<span class="string">'childdata'</span>, onChildData);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Set component DOM value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">(value)</span> {</span>
	<span class="keyword">if</span> (value == <span class="keyword">this</span>._value)
		<span class="keyword">return</span> value;

	<span class="keyword">var</span> valueSet;
	<span class="keyword">if</span> (<span class="keyword">typeof</span> value == <span class="string">'object'</span>) {
		<span class="keyword">if</span> (Array.isArray(value)) {
			valueSet = [];
			value.forEach(<span class="function"><span class="keyword">function</span><span class="params">(item, index)</span> {</span>
				<span class="keyword">var</span> childDataFacet = <span class="keyword">this</span>.path(<span class="string">'['</span> + index + <span class="string">']'</span>, <span class="literal">true</span>); <span class="comment">// true will create item in list</span>
				<span class="keyword">if</span> (childDataFacet) {
					valueSet[index] = childDataFacet.set(item);
				} <span class="keyword">else</span>
					logger.warn(<span class="string">'attempt to set data on path that does not exist: '</span> + <span class="string">'['</span> + index + <span class="string">']'</span>);
			}, <span class="keyword">this</span>);
		} <span class="keyword">else</span> {
			valueSet = {};
			_.eachKey(value, <span class="function"><span class="keyword">function</span><span class="params">(item, key)</span> {</span>
				<span class="keyword">var</span> childDataFacet = <span class="keyword">this</span>.path(<span class="string">'.'</span> + key);
				<span class="keyword">if</span> (childDataFacet) {
					valueSet[key] = childDataFacet.set(item);
				} <span class="keyword">else</span>
					logger.warn(<span class="string">'attempt to set data on path that does not exist: '</span> + <span class="string">'.'</span> + key);
			}, <span class="keyword">this</span>);
		}
	} <span class="keyword">else</span>
		valueSet = <span class="keyword">this</span>._setScalarValue(value);

	<span class="keyword">var</span> oldValue = <span class="keyword">this</span>._value;
	<span class="keyword">this</span>._value = valueSet;
	<span class="keyword">this</span>._postDataChanged({ path: <span class="string">''</span>, type: <span class="string">'changed'</span>,
							newValue: valueSet, oldValue: oldValue });
	
	<span class="keyword">return</span> valueSet;
}


<span class="function"><span class="keyword">function</span> <span class="title">_setScalarValue</span><span class="params">(value)</span> {</span>
	<span class="keyword">var</span> el = <span class="keyword">this</span>.owner.el
		, setter = tags[el.tagName.toLowerCase()];
	<span class="keyword">return</span> setter
			? setter(el, value)
			: (el.innerHTML = value);
}


<span class="function"><span class="keyword">function</span> <span class="title">_postDataChanged</span><span class="params">(message)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>TODO compare with old value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">this</span>.postMessage(message.path, message);

	<span class="keyword">var</span> thisComp = <span class="keyword">this</span>.owner
		, parentContainer = thisComp.scope._hostObject
		, parentData = parentContainer &amp;&amp; parentContainer.owner.data;
	
	<span class="keyword">if</span> (parentData) {
		<span class="keyword">var</span> parentMsg = _.clone(message);
		parentMsg.path = (<span class="keyword">this</span>._path || (<span class="string">'.'</span> + thisComp.name))  + parentMsg.path;
		parentData.postMessage(<span class="string">'childdata'</span>, parentMsg);
	}
}


<span class="function"><span class="keyword">function</span> <span class="title">onChildData</span><span class="params">(msgType, message)</span> {</span>
	<span class="keyword">this</span>._postDataChanged(message);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>get structured data from scope hierarchy</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">()</span> {</span>
	<span class="keyword">var</span> comp = <span class="keyword">this</span>.owner
		, scopeData;

	<span class="keyword">if</span> (comp.list) {
		scopeData = [];
		comp.list.each(<span class="function"><span class="keyword">function</span><span class="params">(listItem, index)</span> {</span>
			scopeData[index] = listItem.data.get();
		});

		<span class="keyword">if</span> (comp.container)
			comp.container.scope._each(<span class="function"><span class="keyword">function</span><span class="params">(scopeItem, name)</span> {</span>
				<span class="keyword">if</span> (! comp.list.contains(scopeItem) &amp;&amp; scopeItem.data)
					scopeData[name] = scopeItem.data.get();
			});
	} <span class="keyword">else</span> <span class="keyword">if</span> (comp.container) {
		scopeData = {};
		comp.container.scope._each(<span class="function"><span class="keyword">function</span><span class="params">(scopeItem, name)</span> {</span>
			scopeData[name] = scopeItem.data.get();
		});
	} <span class="keyword">else</span>
		<span class="keyword">return</span> <span class="keyword">this</span>._getScalarValue();

	<span class="keyword">return</span> scopeData;
}


<span class="function"><span class="keyword">function</span> <span class="title">_getScalarValue</span><span class="params">()</span> {</span>
	<span class="keyword">var</span> el = <span class="keyword">this</span>.owner.el
		, getter = tags[el.tagName.toLowerCase()];
	<span class="keyword">return</span> getter
			 ? getter(el)
			 : el.innerHTML;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>returns data facet of a child component (by scopes) corresponding to the path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">path</span><span class="params">(accessPath, createItem)</span> {</span>
	<span class="keyword">var</span> parsedPath = pathUtils.parseAccessPath(accessPath)
		, currentComponent = <span class="keyword">this</span>.owner;

	<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = parsedPath.length; i &lt; len; i++) {
		<span class="keyword">var</span> pathNode = parsedPath[i]
			, nodeKey = pathUtils.getPathNodeKey(pathNode);
		<span class="keyword">if</span> (pathNode.syntax == <span class="string">'array'</span> &amp;&amp; currentComponent.list) {
			<span class="keyword">var</span> itemComponent = currentComponent.list.item(nodeKey);
			<span class="keyword">if</span> (! itemComponent &amp;&amp; createItem) {
				itemComponent = currentComponent.list.addItem(nodeKey);
				itemComponent.data._path = pathNode.property;
			}
			<span class="keyword">if</span> (itemComponent)
				currentComponent = itemComponent;
		} <span class="keyword">else</span> <span class="keyword">if</span> (currentComponent.container)
			currentComponent = currentComponent.container.scope[nodeKey];

		<span class="keyword">if</span> (! currentComponent || ! currentComponent.data)
			<span class="keyword">break</span>;
	}

	<span class="keyword">return</span> currentComponent &amp;&amp; currentComponent.data;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Set value rules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> tags = {
	<span class="string">'input'</span>: inputValue
}</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Set and get value of input</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">inputValue</span><span class="params">(el, value)</span> {</span>
	<span class="keyword">if</span> (value)
		<span class="keyword">return</span> (el.value = value);
	<span class="keyword">else</span>
		<span class="keyword">return</span> el.value;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p><a name="components-facets-dom"></a></p>
<h3 id="dom-facet">dom facet</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> ComponentFacet = require(<span class="string">'../c_facet'</span>)
	, facetsRegistry = require(<span class="string">'./cf_registry'</span>)	
	, _ = require(<span class="string">'mol-proto'</span>)
	, check = require(<span class="string">'../../util/check'</span>)
	, Match = check.Match
	, binder = require(<span class="string">'../../binder'</span>)
	, BindAttribute = require(<span class="string">'../../attribute/a_bind'</span>)
	, DomFacetError = require(<span class="string">'../../util/error'</span>).DomFacet;</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>data model connection facet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Dom = _.createSubclass(ComponentFacet, <span class="string">'Dom'</span>);

_.extendProto(Dom, {
	init: init,
	start: start,

	show: show,
	hide: hide,
	remove: remove,
	append: append,
	prepend: prepend,
	appendChildren: appendChildren,
	prependChildren: prependChildren,
	insertAfter: insertAfter,
	insertBefore: insertBefore,
	setStyle: setStyle,
	copy: copy,

	find: find,
	hasTextBeforeSelection: hasTextBeforeSelection</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>_reattach: _reattachEventsOnElementChange</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>});

facetsRegistry.add(Dom);

module.exports = Dom;</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>initialize Dom facet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span> {</span>
	ComponentFacet.prototype.init.apply(<span class="keyword">this</span>, arguments);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>start Dom facet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">start</span><span class="params">()</span> {</span>
	<span class="keyword">if</span> (<span class="keyword">this</span>.config.cls)
		<span class="keyword">this</span>.owner.el.classList.add(<span class="keyword">this</span>.config.cls);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>show HTML element of component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">show</span><span class="params">()</span> {</span>
	<span class="keyword">this</span>.owner.el.style.display = <span class="string">'block'</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>hide HTML element of component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">hide</span><span class="params">()</span> {</span>
	<span class="keyword">this</span>.owner.el.style.display = <span class="string">'none'</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">setStyle</span><span class="params">(property, value)</span> {</span>
	<span class="keyword">this</span>.owner.el.style[property] = value;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>create a copy of DOM element using facet config if set</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">copy</span><span class="params">(isDeep)</span> {</span>
	<span class="keyword">var</span> tagName = <span class="keyword">this</span>.config.tagName;
	<span class="keyword">if</span> (! <span class="keyword">this</span>.config.tagName)
		<span class="keyword">return</span> <span class="keyword">this</span>.owner.el.cloneNode(isDeep);

	<span class="keyword">var</span> newEl = document.createElement(tagName);

	<span class="keyword">var</span> attributes = <span class="keyword">this</span>.config.attributes;
	<span class="keyword">if</span> (attributes)
		_.eachKey(attributes, <span class="function"><span class="keyword">function</span><span class="params">(attrValue, attrName)</span> {</span>
			newEl.setAttribute(attrName, attrValue);
		});

	<span class="keyword">return</span> newEl;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>remove HTML element of component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">remove</span><span class="params">()</span> {</span>
	<span class="keyword">var</span> thisEl = <span class="keyword">this</span>.owner.el;
	thisEl.parentNode.removeChild(thisEl);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>append inside HTML element of component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">append</span><span class="params">(el)</span> {</span>
	<span class="keyword">this</span>.owner.el.appendChild(el)
}</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>prepend inside HTML element of component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">prepend</span><span class="params">(el)</span> {</span>
	<span class="keyword">var</span> thisEl = <span class="keyword">this</span>.owner.el
		, firstChild = thisEl.firstChild;
	<span class="keyword">if</span> (firstChild)
		thisEl.insertBefore(el, firstChild);
	<span class="keyword">else</span>
		thisEl.appendChild(el);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>appends children of element inside this component&#39;s element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">appendChildren</span><span class="params">(el)</span> {</span>
	<span class="keyword">while</span>(el.childNodes.length)
		<span class="keyword">this</span>.append(el.childNodes[<span class="number">0</span>]);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>prepends children of element inside this component&#39;s element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">prependChildren</span><span class="params">(el)</span> {</span>
	<span class="keyword">while</span>(el.childNodes.length)
		<span class="keyword">this</span>.prepend(el.childNodes[el.childNodes.length - <span class="number">1</span>]);
}

<span class="function"><span class="keyword">function</span> <span class="title">insertAfter</span><span class="params">(el)</span> {</span>
	<span class="keyword">var</span> thisEl = <span class="keyword">this</span>.owner.el
		, parent = thisEl.parentNode;
	parent.insertBefore(el, thisEl.nextSibling);
}

<span class="function"><span class="keyword">function</span> <span class="title">insertBefore</span><span class="params">(el)</span> {</span>
	<span class="keyword">var</span> thisEl = <span class="keyword">this</span>.owner.el
		, parent = thisEl.parentNode;
	parent.insertBefore(el, thisEl);
}

<span class="keyword">var</span> findDirections = {
	<span class="string">'up'</span>: <span class="string">'previousNode'</span>,
	<span class="string">'down'</span>: <span class="string">'nextNode'</span>
};</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>Finds component passing optional iterator&#39;s test
in the same scope as the current component (this)
by traversing DOM tree upwards (direction = &quot;up&quot;)
or downwards (direction = &quot;down&quot;)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">find</span><span class="params">(direction, iterator)</span> {</span>
	<span class="keyword">if</span> (! findDirections.hasOwnProperty(direction))
		<span class="keyword">throw</span> <span class="keyword">new</span> DomFacetError(<span class="string">'incorrect find direction: '</span> + direction);

	<span class="keyword">var</span> el = <span class="keyword">this</span>.owner.el
		, scope = <span class="keyword">this</span>.owner.scope
		, treeWalker = document.createTreeWalker(scope._rootEl, NodeFilter.SHOW_ELEMENT);

	treeWalker.currentNode = el;
	<span class="keyword">var</span> nextNode = treeWalker[findDirections[direction]]()
		, componentsNames = Object.keys(scope)
		, found = <span class="literal">false</span>;

	<span class="keyword">while</span> (nextNode) {
		<span class="keyword">var</span> attr = <span class="keyword">new</span> BindAttribute(nextNode);
		<span class="keyword">if</span> (attr.node) {
			attr.parse().validate();
			<span class="keyword">if</span> (scope.hasOwnProperty(attr.compName)) {
				<span class="keyword">var</span> component = scope[attr.compName];
				<span class="keyword">if</span> (! iterator || iterator(component)) {
					found = <span class="literal">true</span>;
					<span class="keyword">break</span>;
				}
			}
		}
		treeWalker.currentNode = nextNode;
		nextNode = treeWalker[findDirections[direction]]();
	}

	<span class="keyword">if</span> (found) <span class="keyword">return</span> component;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>returns true if the element has text before selection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">hasTextBeforeSelection</span><span class="params">()</span> {</span>
	<span class="keyword">var</span> selection = window.getSelection();
	<span class="keyword">if</span> (! selection.isCollapsed) <span class="keyword">return</span> <span class="literal">true</span>;
	<span class="keyword">if</span> (selection.anchorOffset &gt; <span class="number">1</span>) <span class="keyword">return</span> <span class="literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>walk up the DOM tree to check if there are text nodes before cursor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">var</span> treeWalker = document.createTreeWalker(<span class="keyword">this</span>.owner.el, NodeFilter.SHOW_TEXT);
	<span class="keyword">return</span> treeWalker.previousNode();
}</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p><a name="components-facets-drag"></a></p>
<h3 id="drag-facet">drag facet</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> ComponentFacet = require(<span class="string">'../c_facet'</span>)
	, facetsRegistry = require(<span class="string">'./cf_registry'</span>)
	, DOMEventsSource = require(<span class="string">'../c_message_sources/dom_events_source'</span>)

	, _ = require(<span class="string">'mol-proto'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>generic drag handler, should be overridden</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Drag = _.createSubclass(ComponentFacet, <span class="string">'Drag'</span>);

_.extendProto(Drag, {
	init: initDragFacet,
	start: startDragFacet,

	setHandle: setDragHandle,
	setDragData: setDragData</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>_reattach: _reattachEventsOnElementChange</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>});

facetsRegistry.add(Drag);

module.exports = Drag;


<span class="function"><span class="keyword">function</span> <span class="title">initDragFacet</span><span class="params">()</span> {</span>
	ComponentFacet.prototype.init.apply(<span class="keyword">this</span>, arguments);	
	<span class="keyword">this</span>._createMessageSource(DOMEventsSource);
	<span class="keyword">this</span>._dragData = {};
}


<span class="function"><span class="keyword">function</span> <span class="title">setDragHandle</span><span class="params">(handleEl)</span> {</span>
	<span class="keyword">if</span> (! <span class="keyword">this</span>.owner.el.contains(handleEl))
		<span class="keyword">return</span> logger.warn(<span class="string">'drag handle should be inside element to be dragged'</span>)
	<span class="keyword">this</span>._dragHandle = handleEl;
}

<span class="function"><span class="keyword">function</span> <span class="title">setDragData</span><span class="params">(data)</span> {</span>
	<span class="keyword">this</span>._dragData = data;
}


<span class="function"><span class="keyword">function</span> <span class="title">startDragFacet</span><span class="params">()</span> {</span>
	ComponentFacet.prototype.start.apply(<span class="keyword">this</span>, arguments);
	<span class="keyword">this</span>.owner.el.setAttribute(<span class="string">'draggable'</span>, <span class="literal">true</span>);

	<span class="keyword">this</span>.on(<span class="string">'mousedown'</span>, onMouseDown);
	<span class="keyword">this</span>.on(<span class="string">'mouseenter mouseleave mousemove'</span>, onMouseMovement);
	<span class="keyword">this</span>.on(<span class="string">'dragstart drag'</span>, onDragging);

	<span class="keyword">var</span> self = <span class="keyword">this</span>;

	<span class="function"><span class="keyword">function</span> <span class="title">onMouseDown</span><span class="params">(eventType, event)</span> {</span>
		self._target = event.target;
		<span class="keyword">if</span> (targetInDragHandle(event))
			window.getSelection().empty();
	}

	<span class="function"><span class="keyword">function</span> <span class="title">onMouseMovement</span><span class="params">(eventType, event)</span> {</span>
		<span class="keyword">var</span> shouldBeDraggable = targetInDragHandle(event);
		self.owner.el.setAttribute(<span class="string">'draggable'</span>, shouldBeDraggable);
	}

	<span class="function"><span class="keyword">function</span> <span class="title">onDragging</span><span class="params">(eventType, event)</span> {</span>
		<span class="keyword">if</span> (targetInDragHandle(event)) {
			<span class="keyword">var</span> dt = event.dataTransfer;
			dt.setData(<span class="string">'text/html'</span>, self.owner.el.outerHTML);
			dt.setData(<span class="string">'x-application/milo-component'</span>, JSON.stringify(self._dragData));
		} <span class="keyword">else</span>
			event.preventDefault();
	}

	<span class="function"><span class="keyword">function</span> <span class="title">targetInDragHandle</span><span class="params">(event)</span> {</span>
		<span class="keyword">return</span> ! self._dragHandle || self._dragHandle.contains(self._target);
	}
}</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p><a name="components-facets-drop"></a></p>
<h3 id="drop-facet">drop facet</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> ComponentFacet = require(<span class="string">'../c_facet'</span>)
	, facetsRegistry = require(<span class="string">'./cf_registry'</span>)
	, DOMEventsSource = require(<span class="string">'../c_message_sources/dom_events_source'</span>)

	, _ = require(<span class="string">'mol-proto'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>generic drop handler, should be overridden</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Drop = _.createSubclass(ComponentFacet, <span class="string">'Drop'</span>);

_.extendProto(Drop, {
	init: initDropFacet,
	start: startDropFacet</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>_reattach: _reattachEventsOnElementChange</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>});

facetsRegistry.add(Drop);

module.exports = Drop;


<span class="function"><span class="keyword">function</span> <span class="title">initDropFacet</span><span class="params">()</span> {</span>
	ComponentFacet.prototype.init.apply(<span class="keyword">this</span>, arguments);
	<span class="keyword">this</span>._createMessageSource(DOMEventsSource);
}


<span class="function"><span class="keyword">function</span> <span class="title">startDropFacet</span><span class="params">()</span> {</span>
	ComponentFacet.prototype.start.apply(<span class="keyword">this</span>, arguments);
	<span class="keyword">this</span>.on(<span class="string">'dragenter dragover'</span>, onDragging);

	<span class="function"><span class="keyword">function</span> <span class="title">onDragging</span><span class="params">(eventType, event)</span> {</span>
		<span class="keyword">var</span> dataTypes = event.dataTransfer.types;
		<span class="keyword">if</span> (dataTypes.indexOf(<span class="string">'text/html'</span>) &gt;= <span class="number">0</span>
				|| dataTypes.indexOf(<span class="string">'x-application/milo-component'</span>) &gt;= <span class="number">0</span>) {
			event.dataTransfer.dropEffect = <span class="string">'move'</span>;
			event.preventDefault();
		}
	}
}</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p><a name="components-facets-editable"></a></p>
<h3 id="editable-facet">editable facet</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> ComponentFacet = require(<span class="string">'../c_facet'</span>)
	, Component = require(<span class="string">'../c_class'</span>)
	, facetsRegistry = require(<span class="string">'./cf_registry'</span>)
	, EditableEventsSource = require(<span class="string">'../c_message_sources/editable_events_source'</span>)
	, logger = require(<span class="string">'../../util/logger'</span>)
	, _ = require(<span class="string">'mol-proto'</span>)
	, check = require(<span class="string">'../../util'</span>).check
	, Match = check.Match;


<span class="keyword">var</span> Editable = _.createSubclass(ComponentFacet, <span class="string">'Editable'</span>);

_.extendProto(Editable, {
	init: init,
	start: start,
	makeEditable: makeEditable</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>_reattach: _reattachEventsOnElementChange</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>});

facetsRegistry.add(Editable);

module.exports = Editable;</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>init Editable facets</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span> {</span>
	ComponentFacet.prototype.init.apply(<span class="keyword">this</span>, arguments);

	<span class="keyword">this</span>._createMessageSource(EditableEventsSource, {
		editableOnClick: <span class="keyword">this</span>.config.editableOnClick,
		moveToAdjacentEditable: <span class="keyword">this</span>.config.moveToAdjacentEditable,
		allowMerge: <span class="keyword">this</span>.config.allowMerge,
		acceptMerge: <span class="keyword">this</span>.config.acceptMerge
	});

	<span class="keyword">this</span>._editable = <span class="keyword">typeof</span> <span class="keyword">this</span>.config.editable != <span class="string">'undefined'</span>
						? <span class="keyword">this</span>.config.editable
						: <span class="literal">true</span>;
}


<span class="function"><span class="keyword">function</span> <span class="title">makeEditable</span><span class="params">(editable)</span> {</span>
	<span class="keyword">this</span>.owner.el.setAttribute(<span class="string">'contenteditable'</span>, editable);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>start Editable facet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">start</span><span class="params">()</span> {</span>
	ComponentFacet.prototype.start.apply(<span class="keyword">this</span>, arguments);
	
	<span class="keyword">if</span> (<span class="keyword">this</span>._editable) {
		<span class="keyword">this</span>.makeEditable(<span class="literal">true</span>);
		<span class="keyword">this</span>.postMessage(<span class="string">'editstart'</span>);
	}
	
	<span class="keyword">this</span>.onMessages({
		<span class="string">'editstart'</span>: onEditStart,
		<span class="string">'editend'</span>: onEditEnd,</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>arrow keys events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="string">'previouseditable'</span>: makePreviousComponentEditable,
		<span class="string">'nexteditable'</span>: makeNextComponentEditable,</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>merge events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="string">'previousmerge'</span>: mergeToPreviousEditable,
		<span class="string">'nextmerge'</span>: mergeToNextEditable,
		<span class="string">'requestmerge'</span>: onRequestMerge,
		<span class="string">'mergeaccepted'</span>: onMergeAccepted,
		<span class="string">'performmerge'</span>: onPerformMerge,
		<span class="string">'mergeremove'</span>: onMergeRemove,</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>split events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="string">'enterkey'</span>: onEnterSplit
	});
}


<span class="function"><span class="keyword">function</span> <span class="title">onEditStart</span><span class="params">(eventType, event)</span> {</span>
	<span class="keyword">this</span>.makeEditable(<span class="literal">true</span>);
}


<span class="function"><span class="keyword">function</span> <span class="title">onEditEnd</span><span class="params">(eventType, event)</span> {</span>
	<span class="keyword">this</span>.makeEditable(<span class="literal">false</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p>Move caret to another editable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">makePreviousComponentEditable</span><span class="params">(eventType, event)</span> {</span>
	event.preventDefault();
	makeAdjacentComponentEditable(<span class="keyword">this</span>.owner, <span class="string">'up'</span>);
}

<span class="function"><span class="keyword">function</span> <span class="title">makeNextComponentEditable</span><span class="params">(eventType, event)</span> {</span>
	event.preventDefault();
	makeAdjacentComponentEditable(<span class="keyword">this</span>.owner, <span class="string">'down'</span>);
}

<span class="function"><span class="keyword">function</span> <span class="title">makeAdjacentComponentEditable</span><span class="params">(component, direction)</span> {</span>
	<span class="keyword">var</span> adjacentComp = component.dom.find(direction, <span class="function"><span class="keyword">function</span><span class="params">(comp)</span> {</span>
		<span class="keyword">return</span> comp.editable;
	});

	<span class="keyword">if</span> (adjacentComp) {
		adjacentComp.editable.postMessage(<span class="string">'editstart'</span>);
		adjacentComp.el.focus();
		
		<span class="keyword">var</span> windowSelection = window.getSelection()
			, selectionRange = document.createRange();
		selectionRange.selectNodeContents(adjacentComp.el);
		<span class="keyword">if</span> (direction == <span class="string">'up'</span>)
			selectionRange.collapse(<span class="literal">false</span>);
		<span class="keyword">else</span>
			selectionRange.collapse(<span class="literal">true</span>);
        windowSelection.removeAllRanges();
        windowSelection.addRange(selectionRange);
	}
}</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <p>merge functionality</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">mergeToPreviousEditable</span><span class="params">(eventType, event)</span> {</span>
	event.preventDefault();
	mergeToAdjacentEditable(<span class="keyword">this</span>.owner, <span class="string">'up'</span>);
}

<span class="function"><span class="keyword">function</span> <span class="title">mergeToNextEditable</span><span class="params">(eventType, event)</span> {</span>
	mergeToAdjacentEditable(<span class="keyword">this</span>.owner, <span class="string">'down'</span>);
}

<span class="function"><span class="keyword">function</span> <span class="title">mergeToAdjacentEditable</span><span class="params">(component, direction)</span> {</span>
	<span class="keyword">var</span> adjacentComp = component.dom.find(direction, <span class="function"><span class="keyword">function</span><span class="params">(comp)</span> {</span>
		<span class="keyword">return</span> comp.editable;
	});

	<span class="keyword">if</span> (adjacentComp)
		adjacentComp.editable.postMessage(<span class="string">'requestmerge'</span>, { sender: component });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>merge messages</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">onRequestMerge</span><span class="params">(message, data)</span> {</span>
	check(data, Match.ObjectIncluding({ sender: Component }));

	<span class="keyword">var</span> mergeComponent = data.sender;
	<span class="keyword">if</span> (<span class="keyword">this</span>.config.acceptMerge)
		mergeComponent.editable.postMessage(<span class="string">'mergeaccepted'</span>, { sender: <span class="keyword">this</span>.owner });
}

<span class="function"><span class="keyword">function</span> <span class="title">onMergeAccepted</span><span class="params">(message, data)</span> {</span>
	check(data, Match.ObjectIncluding({ sender: Component }));

	<span class="keyword">var</span> targetComponent = data.sender;

	<span class="keyword">this</span>.owner.allFacets(<span class="string">'clean'</span>);
	
	targetComponent.editable.postMessage(<span class="string">'performmerge'</span>, { sender: <span class="keyword">this</span>.owner });
}

<span class="function"><span class="keyword">function</span> <span class="title">onPerformMerge</span><span class="params">(message, data)</span> {</span>
	check(data, Match.ObjectIncluding({ sender: Component }));
	<span class="keyword">if</span> (! <span class="keyword">this</span>.config.acceptMerge) {
		logger.error(<span class="string">'performmerge message received by component that doesn\'t accept merge'</span>);
		<span class="keyword">return</span>;
	}

	<span class="keyword">var</span> mergeComponent = data.sender
		, windowSelection = window.getSelection()
		, selectionRange = document.createRange();</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>merge scopes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">this</span>.owner.container.scope._merge(mergeComponent.container.scope);</pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>Reference first element to be merged</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">var</span> firstMergeEl = mergeComponent.el.childNodes[<span class="number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>merge DOM</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">this</span>.owner.dom.appendChildren(mergeComponent.el);</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>Make the interface editable again like expected</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">this</span>.makeEditable(<span class="literal">true</span>);
	<span class="keyword">this</span>.owner.el.focus();</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>Set the selection where it should be</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	selectionRange.setStart(firstMergeEl);
	selectionRange.setEnd(firstMergeEl);
	windowSelection.removeAllRanges();
	windowSelection.addRange(selectionRange);</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>send remove message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	mergeComponent.editable.postMessage(<span class="string">'mergeremove'</span>);
}


<span class="function"><span class="keyword">function</span> <span class="title">onMergeRemove</span><span class="params">(message, data)</span> {</span>
	<span class="keyword">if</span> (! <span class="keyword">this</span>.config.allowMerge) {
		logger.error(<span class="string">'mergeremove message received by component that doesn\'t allow merge'</span>);
		<span class="keyword">return</span>;
	}

	<span class="keyword">this</span>.owner.dom.remove();
	<span class="keyword">this</span>.owner.remove();
}


<span class="function"><span class="keyword">function</span> <span class="title">onEnterSplit</span><span class="params">(message, event)</span> {</span>
	<span class="keyword">var</span> splitFacet = <span class="keyword">this</span>.owner.split;
	<span class="keyword">if</span> (splitFacet) {
		<span class="keyword">var</span> newComp = splitFacet.make();
		event.preventDefault();
		newComp.editable.postMessage(<span class="string">'editstart'</span>);
		newComp.el.focus();
	}
}</pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p><a name="components-facets-events"></a></p>
<h3 id="events-facet">events facet</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> ComponentFacet = require(<span class="string">'../c_facet'</span>)
	, facetsRegistry = require(<span class="string">'./cf_registry'</span>)

	, Messenger = require(<span class="string">'../../messenger'</span>)
	, DOMEventsSource = require(<span class="string">'../c_message_sources/dom_events_source'</span>)

	, _ = require(<span class="string">'mol-proto'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>events facet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Events = _.createSubclass(ComponentFacet, <span class="string">'Events'</span>);

_.extendProto(Events, {
	init: init,</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p>_reattach: _reattachEventsOnElementChange</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>});

facetsRegistry.add(Events);

module.exports = Events;</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p>init Events facet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span> {</span>
	ComponentFacet.prototype.init.apply(<span class="keyword">this</span>, arguments);

	<span class="keyword">var</span> domEventsSource = <span class="keyword">new</span> DOMEventsSource(<span class="keyword">this</span>, { trigger: <span class="string">'trigger'</span> }, <span class="keyword">this</span>.owner);

	<span class="keyword">this</span>._setMessageSource(domEventsSource)

	Object.defineProperties(<span class="keyword">this</span>, {
		_domEventsSource: { value: domEventsSource }
	});
}</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p><a name="components-facets-frame"></a></p>
<h3 id="frame-facet">frame facet</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> ComponentFacet = require(<span class="string">'../c_facet'</span>)
	, facetsRegistry = require(<span class="string">'./cf_registry'</span>)

	, Messenger = require(<span class="string">'../../messenger'</span>)
	, iFrameMessageSource = require(<span class="string">'../c_message_sources/iframe_message_source'</span>)

	, _ = require(<span class="string">'mol-proto'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>data model connection facet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Frame = _.createSubclass(ComponentFacet, <span class="string">'Frame'</span>);

_.extendProto(Frame, {
	init: initFrameFacet</pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p>_reattach: _reattachEventsOnElementChange</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>});


facetsRegistry.add(Frame);

module.exports = Frame;


<span class="function"><span class="keyword">function</span> <span class="title">initFrameFacet</span><span class="params">()</span> {</span>
	ComponentFacet.prototype.init.apply(<span class="keyword">this</span>, arguments);
	
	<span class="keyword">var</span> iFrameMessageSourceProxy = {
		post: <span class="string">'post'</span>
	};
	<span class="keyword">var</span> messageSource = <span class="keyword">new</span> iFrameMessageSource(<span class="keyword">this</span>, iFrameMessageSourceProxy);

	<span class="keyword">this</span>._setMessageSource(messageSource);

	Object.defineProperties(<span class="keyword">this</span>, {
		_messageSource: { value: messageSource }
	});
}</pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p><a name="components-facets-item"></a></p>
<h3 id="item-facet">item facet</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> ComponentFacet = require(<span class="string">'../c_facet'</span>)
    , facetsRegistry = require(<span class="string">'./cf_registry'</span>)
    , Model = require(<span class="string">'../../model'</span>)
    , _ = require(<span class="string">'mol-proto'</span>)
    , miloMail = require(<span class="string">'../../mail'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p>data model connection facet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> ItemFacet = _.createSubclass(ComponentFacet, <span class="string">'Item'</span>);

_.extendProto(ItemFacet, {
    require: [<span class="string">'Container'</span>, <span class="string">'Dom'</span>, <span class="string">'Data'</span>]
});

facetsRegistry.add(ItemFacet);

module.exports = ItemFacet;</pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p><a name="components-facets-list"></a></p>
<h3 id="list-facet">list facet</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> ComponentFacet = require(<span class="string">'../c_facet'</span>)
    , Component = require(<span class="string">'../c_class'</span>)
    , facetsRegistry = require(<span class="string">'./cf_registry'</span>)
    , Model = require(<span class="string">'../../model'</span>)
    , _ = require(<span class="string">'mol-proto'</span>)
    , miloMail = require(<span class="string">'../../mail'</span>)
    , binder = require(<span class="string">'../../binder'</span>)
    , ListError = require(<span class="string">'../../util/error'</span>).List
    , logger = require(<span class="string">'../../util/logger'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <p>Data model connection facet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> List = _.createSubclass(ComponentFacet, <span class="string">'List'</span>);

_.extendProto(List, {
    init: init,
    <span class="comment">/* update: update, */</span>
    require: [<span class="string">'Container'</span>, <span class="string">'Dom'</span>, <span class="string">'Data'</span>],
    _itemPreviousComponent: _itemPreviousComponent,

    item: item,
    count: count,
    _setItem: _setItem,
    contains: contains,
    addItem: addItem,
    removeItem: removeItem,
    each: each
    <span class="comment">/* _reattach: _reattachEventsOnElementChange */</span>
});

facetsRegistry.add(List);

module.exports = List;</pre></div></div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <p>Initialize List facet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span> {</span>
    ComponentFacet.prototype.init.apply(<span class="keyword">this</span>, arguments);
    <span class="keyword">var</span> model = <span class="keyword">new</span> Model()
        , self = <span class="keyword">this</span>;

    _.defineProperties(<span class="keyword">this</span>, {
        _listItems: [],
        _listItemsHash: {}
    });
    _.defineProperty(<span class="keyword">this</span>, <span class="string">'itemSample'</span>, <span class="literal">null</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">true</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <p>Fired by <strong>binder</strong> when all children of component are bound</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">this</span>.owner.on(<span class="string">'childrenbound'</span>, onChildrenBound);
}


<span class="function"><span class="keyword">function</span> <span class="title">onChildrenBound</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> foundItem;</pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p><code>this</code> is a component here, as the message was dispatched on a component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">this</span>.container.scope._each(<span class="function"><span class="keyword">function</span><span class="params">(childComp, name)</span> {</span>
        <span class="keyword">if</span> (childComp.item) {
            <span class="keyword">if</span> (foundItem) <span class="keyword">throw</span> <span class="keyword">new</span> ListError(<span class="string">'More than one child component has ListItem Facet'</span>)
            foundItem = childComp;
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>Component must have one and only one child with a List facet </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (! foundItem) <span class="keyword">throw</span> <span class="keyword">new</span> ListError(<span class="string">'No child component has ListItem Facet'</span>);

    <span class="keyword">this</span>.list.itemSample = foundItem;</pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p>After keeping a reference to the item sample, it must be hidden and removed from scope</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">this</span>.list.itemSample.dom.hide();
    <span class="keyword">this</span>.list.itemSample.remove();
}</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>Return a list item by it&#39;s index</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">item</span><span class="params">(index)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>._listItems[index];
}</pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>Get total number of list items</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">count</span><span class="params">()</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>._listItems.length
}


<span class="function"><span class="keyword">function</span> <span class="title">_setItem</span><span class="params">(index, component)</span> {</span>
    <span class="keyword">this</span>._listItems[index] = component;
    <span class="keyword">this</span>._listItemsHash[component.name] = component
}</pre></div></div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <p>Does the list contain a particular list item component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">contains</span><span class="params">(component)</span>{</span>
    <span class="keyword">return</span> <span class="keyword">this</span>._listItemsHash[component.name] == component;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-151">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              <p>Add a new list item at a particular index</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">addItem</span><span class="params">(index)</span> {</span>
    index = index || <span class="keyword">this</span>.count();
    <span class="keyword">if</span> (<span class="keyword">this</span>.item(index))
        <span class="keyword">throw</span> ListError(<span class="string">'attempt to create item with ID of existing item'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-152">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-152">&#182;</a>
              </div>
              <p>Copy component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> component = Component.copy(<span class="keyword">this</span>.itemSample, <span class="literal">true</span>);

    <span class="keyword">var</span> tempComp = binder(component.el)[component.name]
        , innerScope = tempComp.container.scope;</pre></div></div>
            
        </li>
        
        
        <li id="section-153">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-153">&#182;</a>
              </div>
              <p>Set reference to component container facet on scope</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    innerScope._hostObject = component.container;</pre></div></div>
            
        </li>
        
        
        <li id="section-154">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-154">&#182;</a>
              </div>
              <p>Copy bound scope to component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    component.container.scope = innerScope;</pre></div></div>
            
        </li>
        
        
        <li id="section-155">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-155">&#182;</a>
              </div>
              <p>Add it to the DOM</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">this</span>._itemPreviousComponent(index).dom.insertAfter(component.el)</pre></div></div>
            
        </li>
        
        
        <li id="section-156">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              <p>Add to list items</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">this</span>._setItem(index, component);</pre></div></div>
            
        </li>
        
        
        <li id="section-157">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-157">&#182;</a>
              </div>
              <p>Show the list item component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    component.dom.show();

    <span class="keyword">return</span> component;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-158">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-158">&#182;</a>
              </div>
              <p>Remove item from a particular index,
<code>doSplice</code> determines if the empty space should be removed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">removeItem</span><span class="params">(index, doSplice)</span> {</span>
    <span class="keyword">var</span> comp = <span class="keyword">this</span>.item(index);

    <span class="keyword">if</span> (! comp)
        logger.warn(<span class="string">'attempt to remove list item with id that does not exist'</span>);

    <span class="keyword">this</span>._listItems[index] = <span class="literal">undefined</span>;
    <span class="keyword">delete</span> <span class="keyword">this</span>._listItemsHash[comp.name];
    comp.dom.remove();
    comp.remove();

    <span class="keyword">if</span> (doSplice)
        <span class="keyword">this</span>._listItems.splice(index, <span class="number">1</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-159">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-159">&#182;</a>
              </div>
              <p>Returns the previous item component given an index</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">_itemPreviousComponent</span><span class="params">(index)</span> {</span>
    <span class="keyword">while</span> (index &gt;= <span class="number">0</span> &amp;&amp; ! <span class="keyword">this</span>._listItems[index])
        index--;

    <span class="keyword">return</span> index &gt;= <span class="number">0</span>
                ? <span class="keyword">this</span>._listItems[index]
                : <span class="keyword">this</span>.itemSample;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-160">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-160">&#182;</a>
              </div>
              <p>Performs a callback on each list item</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">each</span><span class="params">(callback, thisArg)</span> {</span>
    <span class="keyword">this</span>._listItems.forEach(<span class="function"><span class="keyword">function</span><span class="params">(item)</span> {</span>
        <span class="keyword">if</span> (item) callback.apply(<span class="keyword">this</span>, arguments);
    }, thisArg || <span class="keyword">this</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-161">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              <p><a name="components-facets-model"></a></p>
<h3 id="model-facet">model facet</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> ComponentFacet = require(<span class="string">'../c_facet'</span>)
	, facetsRegistry = require(<span class="string">'./cf_registry'</span>)
	, Model = require(<span class="string">'../../model'</span>)

	, _ = require(<span class="string">'mol-proto'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-162">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-162">&#182;</a>
              </div>
              <p>generic drag handler, should be overridden</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> ModelFacet = _.createSubclass(ComponentFacet, <span class="string">'Model'</span>);

_.extendProto(ModelFacet, {
	init: initModelFacet,
	_createMessenger: _createMessenger</pre></div></div>
            
        </li>
        
        
        <li id="section-163">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-163">&#182;</a>
              </div>
              <p>_reattach: _reattachEventsOnElementChange</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>});

facetsRegistry.add(ModelFacet);

module.exports = ModelFacet;


<span class="function"><span class="keyword">function</span> <span class="title">initModelFacet</span><span class="params">()</span> {</span>
	<span class="keyword">this</span>.m = <span class="keyword">new</span> Model(<span class="keyword">this</span>);

	ComponentFacet.prototype.init.apply(<span class="keyword">this</span>, arguments);
}

<span class="function"><span class="keyword">function</span> <span class="title">_createMessenger</span><span class="params">()</span> {</span> <span class="comment">// Called by inherited init</span>
	<span class="keyword">this</span>.m.proxyMessenger(<span class="keyword">this</span>); <span class="comment">// Creates messenger's methods directly on facet</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-164">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-164">&#182;</a>
              </div>
              <p><a name="components-facets-split"></a></p>
<h3 id="split-facet">split facet</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> ComponentFacet = require(<span class="string">'../c_facet'</span>)
	, Component = require(<span class="string">'../c_class'</span>)
	, facetsRegistry = require(<span class="string">'./cf_registry'</span>);

<span class="keyword">var</span> Split = _.createSubclass(ComponentFacet, <span class="string">'Split'</span>);

_.extendProto(Split, {
	init: init,
	start: start,
	make: make,

	isSplittable: isSplittable,
	_makeSplit: _makeSplit,

	require: [<span class="string">'Dom'</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-165">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-165">&#182;</a>
              </div>
              <p>_reattach: _reattachEventsOnElementChange</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>});

facetsRegistry.add(Split);

module.exports = Split;</pre></div></div>
            
        </li>
        
        
        <li id="section-166">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-166">&#182;</a>
              </div>
              <p>init Split facet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span> {</span>
	ComponentFacet.prototype.init.apply(<span class="keyword">this</span>, arguments);

	<span class="keyword">this</span>._splitSender = <span class="literal">undefined</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-167">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-167">&#182;</a>
              </div>
              <p>start Split facet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">start</span><span class="params">()</span> {</span>
	ComponentFacet.prototype.start.apply(<span class="keyword">this</span>, arguments);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-168">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-168">&#182;</a>
              </div>
              <p>performs the split on selection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">()</span> {</span>
	<span class="keyword">if</span> (! <span class="keyword">this</span>.isSplittable())
		<span class="keyword">return</span>;

	<span class="keyword">if</span> (! <span class="keyword">this</span>.owner.dom.hasTextBeforeSelection())
		<span class="keyword">return</span>; <span class="comment">// should simply create empty component before</span>

	<span class="keyword">return</span> <span class="keyword">this</span>._makeSplit();
}


<span class="function"><span class="keyword">function</span> <span class="title">_makeSplit</span><span class="params">()</span> {</span>
	<span class="keyword">var</span> thisComp = <span class="keyword">this</span>.owner;</pre></div></div>
            
        </li>
        
        
        <li id="section-169">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-169">&#182;</a>
              </div>
              <p>clone itself</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">var</span> newComp = Component.copy(thisComp);
	thisComp.dom.insertAfter(newComp.el);

	splitElement(thisComp.el, newComp.el);

	<span class="keyword">return</span> newComp;
}


<span class="function"><span class="keyword">function</span> <span class="title">splitElement</span><span class="params">(thisEl, newEl)</span> {</span>
	<span class="keyword">var</span> selection = window.getSelection()
		, selNode = selection.anchorNode
		, selFound = <span class="literal">false</span>;

	Array.prototype.forEach.call(thisEl.childNodes, <span class="function"><span class="keyword">function</span><span class="params">(childNode)</span> {</span>
		<span class="keyword">if</span> (childNode.contains(selNode) || childNode == selNode) {
			<span class="keyword">var</span> comp = Component.getComponent(childNode);
			<span class="keyword">if</span> (comp)
				comp.split._makeSplit();
			<span class="keyword">else</span> {
				<span class="keyword">if</span> (childNode.nodeType == Node.TEXT_NODE) {
					<span class="keyword">var</span> selPos = selection.anchorOffset;
					<span class="keyword">var</span> newText = childNode.splitText(selPos);
					newEl.appendChild(newText);
				} <span class="keyword">else</span> {
					<span class="keyword">var</span> newChildEl = childNode.cloneNode(<span class="literal">false</span>);
					newEl.appendChild(newChildEl);
					splitElement(childNode, newChildEl);
				}
			}

			selFound = <span class="literal">true</span>;
		} <span class="keyword">else</span> <span class="keyword">if</span> (selFound)
			newEl.appendChild(childNode);
	});
}


<span class="function"><span class="keyword">function</span> <span class="title">isSplittable</span><span class="params">()</span> {</span>
	<span class="keyword">var</span> selection = window.getSelection()
		, el = selection.anchorNode;

	<span class="keyword">if</span> (! <span class="keyword">this</span>.owner.el.contains(el)) {
		logger.warn(<span class="string">'selection is outside this component'</span>);
		<span class="keyword">return</span> <span class="literal">false</span>;
	}

	<span class="keyword">while</span> (el != <span class="keyword">this</span>.owner.el) {
		<span class="keyword">var</span> comp = Component.getComponent(el);
		<span class="keyword">if</span> (comp &amp;&amp; ! comp.split)
			<span class="keyword">return</span> <span class="literal">false</span>;
		el = el.parentNode;
	}

	<span class="keyword">return</span> <span class="literal">true</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-170">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-170">&#182;</a>
              </div>
              <p><a name="components-facets-template"></a></p>
<h3 id="template-facet">template facet</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> ComponentFacet = require(<span class="string">'../c_facet'</span>)
	, facetsRegistry = require(<span class="string">'./cf_registry'</span>)	
	, _ = require(<span class="string">'mol-proto'</span>)
	, check = require(<span class="string">'../../util/check'</span>)
	, Match = check.Match
	, binder = require(<span class="string">'../../binder'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-171">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-171">&#182;</a>
              </div>
              <p>data model connection facet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Template = _.createSubclass(ComponentFacet, <span class="string">'Template'</span>);

_.extendProto(Template, {
	init: initTemplateFacet,
	set: setTemplate,
	render: renderTemplate,
	binder: bindInnerComponents,
	require: [<span class="string">'Container'</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-172">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-172">&#182;</a>
              </div>
              <p>_reattach: _reattachEventsOnElementChange</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>});

facetsRegistry.add(Template);

module.exports = Template;


<span class="function"><span class="keyword">function</span> <span class="title">initTemplateFacet</span><span class="params">()</span> {</span>
	ComponentFacet.prototype.init.apply(<span class="keyword">this</span>, arguments);

	<span class="keyword">this</span>._templateStr = <span class="keyword">this</span>.config.template;
}


<span class="function"><span class="keyword">function</span> <span class="title">setTemplate</span><span class="params">(templateStr, compile)</span> {</span>
	check(templateStr, String);
	check(compile, Match.Optional(Function));

	<span class="keyword">this</span>._templateStr = templateStr;
	<span class="keyword">if</span> (compile)
		<span class="keyword">this</span>._compile = compile

	compile = compile || <span class="keyword">this</span>._compile; <span class="comment">// || milo.config.template.compile;</span>

	<span class="keyword">if</span> (compile)
		<span class="keyword">this</span>._template = compile(templateStr);

	<span class="keyword">return</span> <span class="keyword">this</span>;
}


<span class="function"><span class="keyword">function</span> <span class="title">renderTemplate</span><span class="params">(data)</span> {</span> <span class="comment">// we need data only if use templating engine</span>
	<span class="keyword">this</span>.owner.el.innerHTML = <span class="keyword">this</span>._template
								? <span class="keyword">this</span>._template(data)
								: <span class="keyword">this</span>._templateStr;

	<span class="keyword">return</span> <span class="keyword">this</span>;
}


<span class="function"><span class="keyword">function</span> <span class="title">bindInnerComponents</span><span class="params">()</span> {</span>
	<span class="keyword">var</span> thisScope = binder(<span class="keyword">this</span>.owner.el);</pre></div></div>
            
        </li>
        
        
        <li id="section-173">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-173">&#182;</a>
              </div>
              <p>TODO should be changed to reconcillation of existing children with new</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">this</span>.owner.container.scope = thisScope[<span class="keyword">this</span>.owner.name].container.scope;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-174">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-174">&#182;</a>
              </div>
              <p><a name="components"></a></p>
<h2 id="component-class">component class</h2>

            </div>
            
        </li>
        
        
        <li id="section-175">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-175">&#182;</a>
              </div>
              <p>Basic component class.</p>
<p>It&#39;s constructor accepts DOM element and component name as paramenters.</p>
<p>You do not need to use its constructor directly as binder module creates
components when it scans DOM tree.</p>
<p>You should use Component.createComponentClass method when you want to create
a new component class from facets and their configuration.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> FacetedObject = require(<span class="string">'../facets/f_object'</span>)
	, facetsRegistry = require(<span class="string">'./c_facets/cf_registry'</span>)
	, ComponentFacet = require(<span class="string">'./c_facet'</span>)
	, Messenger = require(<span class="string">'../messenger'</span>)
	, _ = require(<span class="string">'mol-proto'</span>)
	, check = require(<span class="string">'../util/check'</span>)
	, Match = check.Match
	, config = require(<span class="string">'../config'</span>)
	, miloCount = require(<span class="string">'../util/count'</span>);


<span class="keyword">var</span> Component = _.createSubclass(FacetedObject, <span class="string">'Component'</span>, <span class="literal">true</span>);

module.exports = Component;


Component.createComponentClass = createComponentClass;
<span class="keyword">delete</span> Component.createFacetedClass;</pre></div></div>
            
        </li>
        
        
        <li id="section-176">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-176">&#182;</a>
              </div>
              <p>class methods</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>_.extend(Component, {
	create: create,
	copy: copy,
	isComponent: isComponent,
	getComponent: getComponent,
	getContainingComponent: getContainingComponent
});</pre></div></div>
            
        </li>
        
        
        <li id="section-177">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-177">&#182;</a>
              </div>
              <p>instance methods</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>_.extendProto(Component, {
	init: init,
	addFacet: addFacet,
	allFacets: allFacets,
	remove: remove
});</pre></div></div>
            
        </li>
        
        
        <li id="section-178">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-178">&#182;</a>
              </div>
              <p>class methods</p>
<p>create component from ComponentInfo</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">(info)</span> {</span>
	<span class="keyword">var</span> ComponentClass = info.ComponentClass;
	<span class="keyword">var</span> aComponent = <span class="keyword">new</span> ComponentClass(info.scope, info.el, info.name, info);

	<span class="keyword">if</span> (info.extraFacetsClasses)
		_.eachKey(info.extraFacetsClasses, <span class="function"><span class="keyword">function</span><span class="params">(FacetClass)</span> {</span>
			aComponent.addFacet(FacetClass);
		});

	<span class="keyword">return</span> aComponent;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-179">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-179">&#182;</a>
              </div>
              <p>creates a new instance with the same state but different element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">copy</span><span class="params">(component, deepCopyDOM)</span> {</span>
	<span class="keyword">var</span> ComponentClass = component.constructor
		, newName = <span class="string">'milo_'</span> + miloCount()
		, newEl = component.dom 
					? component.dom.copy(deepCopyDOM)
					: component.el.cloneNode(deepCopyDOM)
		, newInfo = _.clone(component.componentInfo)
		, attr = _.clone(newInfo.attr);

	_.extend(attr, {
		el: newEl,
		compName: newName
	});

	attr.decorate();

	_.extend(newInfo, {
		el: newEl,
		name: newName,
		attr: attr
	});

	<span class="keyword">var</span> aComponent = Component.create(newInfo);
	component.scope._add(aComponent, aComponent.name);

	<span class="keyword">return</span> aComponent;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-180">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-180">&#182;</a>
              </div>
              <p>checks if element is bound to a component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">isComponent</span><span class="params">(element)</span> {</span>
	<span class="keyword">return</span> config.componentRef <span class="keyword">in</span> element;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-181">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-181">&#182;</a>
              </div>
              <p>gets the element bound the component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">getComponent</span><span class="params">(element)</span> {</span>
	<span class="keyword">return</span> element &amp;&amp; element[config.componentRef];
}

<span class="comment">/**
 * Returns the closest component which contains the specified node
 *
 * This will return the current component of the node if it is a component.
 * 
 * @param {Node} node DOM Node
 * @return {Component|null}
 */</span>
<span class="function"><span class="keyword">function</span> <span class="title">getContainingComponent</span><span class="params">(node)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-182">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-182">&#182;</a>
              </div>
              <p>Where the current node is a component it&#39;s component should be returned</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">if</span> (isComponent(node)) {
		<span class="keyword">return</span> getComponent(node);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-183">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-183">&#182;</a>
              </div>
              <p>Where there is no parent node, this function will return null</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">if</span> (! node.parentNode) {
		<span class="keyword">return</span> <span class="literal">null</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-184">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-184">&#182;</a>
              </div>
              <p>The parent node is checked recursively</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">return</span> getContainingComponent(node.parentNode);
}

<span class="function"><span class="keyword">function</span> <span class="title">createComponentClass</span><span class="params">(name, facetsConfig)</span> {</span>
	<span class="keyword">var</span> facetsClasses = {};

	<span class="keyword">if</span> (Array.isArray(facetsConfig)) {
		<span class="keyword">var</span> configMap = {};
		facetsConfig.forEach(<span class="function"><span class="keyword">function</span><span class="params">(fct)</span> {</span>
			<span class="keyword">var</span> fctName = _.firstLowerCase(fct);
			configMap[fctName] = {};
		});
		facetsConfig = configMap;
	}

	_.eachKey(facetsConfig, <span class="function"><span class="keyword">function</span><span class="params">(fctConfig, fct)</span> {</span>
		<span class="keyword">var</span> fctName = _.firstLowerCase(fct);
		<span class="keyword">var</span> fctClassName = _.firstUpperCase(fct);
		facetsClasses[fctName] = facetsRegistry.get(fctClassName);
	});

	<span class="keyword">var</span> ComponentClass = FacetedObject.createFacetedClass.call(<span class="keyword">this</span>, name, facetsClasses, facetsConfig);
	
	<span class="keyword">return</span> ComponentClass;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-185">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-185">&#182;</a>
              </div>
              <p>instance methods</p>
<p>initializes component
Automatically called by inherited constructor of FacetedObject
Subclasses should call inherited init methods:
Component.prototype.init.apply(this, arguments)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">(scope, element, name, componentInfo)</span> {</span>
	<span class="keyword">this</span>.el = element;
	<span class="keyword">if</span> (element)
		element[config.componentRef] = <span class="keyword">this</span>;

	_.defineProperties(<span class="keyword">this</span>, {
		name: name,
		scope: scope,
		componentInfo: componentInfo
	}, <span class="literal">true</span>);

	<span class="keyword">var</span> messenger = <span class="keyword">new</span> Messenger(<span class="keyword">this</span>, Messenger.defaultMethods, <span class="literal">undefined</span> <span class="comment">/* no messageSource */</span>);

	_.defineProperty(<span class="keyword">this</span>, <span class="string">'_messenger'</span>, messenger);</pre></div></div>
            
        </li>
        
        
        <li id="section-186">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-186">&#182;</a>
              </div>
              <p>start all facets</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">this</span>.allFacets(<span class="string">'check'</span>);
	<span class="keyword">this</span>.allFacets(<span class="string">'start'</span>);
}


<span class="function"><span class="keyword">function</span> <span class="title">addFacet</span><span class="params">(facetNameOrClass, facetOpts, facetName)</span> {</span>
	check(facetNameOrClass, Match.OneOf(String, Match.Subclass(ComponentFacet)));
	check(facetOpts, Match.Optional(Object));
	check(facetName, Match.Optional(String));

	<span class="keyword">if</span> (<span class="keyword">typeof</span> facetNameOrClass == <span class="string">'string'</span>) {
		<span class="keyword">var</span> facetClassName = _.firstUpperCase(facetNameOrClass);
		<span class="keyword">var</span> FacetClass = facetsRegistry.get(facetClassName);
	} <span class="keyword">else</span> 
		FacetClass = facetNameOrClass;

	facetName = facetName || _.firstLowerCase(FacetClass.name);

	<span class="keyword">var</span> newFacet = FacetedObject.prototype.addFacet.call(<span class="keyword">this</span>, FacetClass, facetOpts, facetName);</pre></div></div>
            
        </li>
        
        
        <li id="section-187">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-187">&#182;</a>
              </div>
              <p>start facet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	newFacet.check &amp;&amp; newFacet.check();
	newFacet.start &amp;&amp; newFacet.start();
}</pre></div></div>
            
        </li>
        
        
        <li id="section-188">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-188">&#182;</a>
              </div>
              <p>envoke given method with optional parameters on all facets</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">allFacets</span><span class="params">(method <span class="comment">/* , ... */</span>)</span> {</span>
	<span class="keyword">var</span> args = Array.prototype.slice.call(arguments, <span class="number">1</span>);

	_.eachKey(<span class="keyword">this</span>.facets, <span class="function"><span class="keyword">function</span><span class="params">(facet, fctName)</span> {</span>
		<span class="keyword">if</span> (facet &amp;&amp; <span class="keyword">typeof</span> facet[method] == <span class="string">'function'</span>)
			facet[method].apply(facet, args);
	});
}</pre></div></div>
            
        </li>
        
        
        <li id="section-189">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-189">&#182;</a>
              </div>
              <p>remove component from it&#39;s scope</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">remove</span><span class="params">()</span> {</span>
	<span class="keyword">if</span> (<span class="keyword">this</span>.scope)
		<span class="keyword">delete</span> <span class="keyword">this</span>.scope[<span class="keyword">this</span>.name];
}</pre></div></div>
            
        </li>
        
        
        <li id="section-190">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-190">&#182;</a>
              </div>
              <p><a name="components-facet"></a></p>
<h3 id="component-facet-class">component facet class</h3>
<p>The class fot the facet of component. When a component is created, it
creates all its facets.</p>
<p>See Facets section on information about available facets and on 
how to create new facets classes.</p>
<ul>
<li>Component - basic compponent class</li>
<li>ComponentFacet - basic </li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> Facet = require(<span class="string">'../facets/f_class'</span>)
	, Messenger = require(<span class="string">'../messenger'</span>)
	, FacetError = require(<span class="string">'../util/error'</span>).Facet
	, _ = require(<span class="string">'mol-proto'</span>);

<span class="keyword">var</span> ComponentFacet = _.createSubclass(Facet, <span class="string">'ComponentFacet'</span>);

module.exports = ComponentFacet;


_.extendProto(ComponentFacet, {
	init: initComponentFacet,
	start: startComponentFacet,
	check: checkDependencies,
	_createMessenger: _createMessenger,
	_setMessageSource: _setMessageSource,
	_createMessageSource: _createMessageSource
});


<span class="function"><span class="keyword">function</span> <span class="title">initComponentFacet</span><span class="params">()</span> {</span>
	<span class="keyword">this</span>._createMessenger();
}


<span class="function"><span class="keyword">function</span> <span class="title">_createMessenger</span><span class="params">()</span>{</span>
	<span class="keyword">var</span> messenger = <span class="keyword">new</span> Messenger(<span class="keyword">this</span>, Messenger.defaultMethods, <span class="literal">undefined</span> <span class="comment">/* no messageSource */</span>);

	_.defineProperties(<span class="keyword">this</span>, {
		_messenger: messenger
	});
}


<span class="function"><span class="keyword">function</span> <span class="title">startComponentFacet</span><span class="params">()</span> {</span>
	<span class="keyword">if</span> (<span class="keyword">this</span>.config.messages)
		<span class="keyword">this</span>.onMessages(<span class="keyword">this</span>.config.messages);
}


<span class="function"><span class="keyword">function</span> <span class="title">checkDependencies</span><span class="params">()</span> {</span>
	<span class="keyword">if</span> (<span class="keyword">this</span>.require) {
		<span class="keyword">this</span>.require.forEach(<span class="function"><span class="keyword">function</span><span class="params">(reqFacet)</span> {</span>
			<span class="keyword">var</span> facetName = _.firstLowerCase(reqFacet);
			<span class="keyword">if</span> (! (<span class="keyword">this</span>.owner[facetName] <span class="keyword">instanceof</span> ComponentFacet))
				<span class="keyword">throw</span> <span class="keyword">new</span> FacetError(<span class="string">'facet '</span> + <span class="keyword">this</span>.constructor.name + <span class="string">' requires facet '</span> + reqFacet);
		}, <span class="keyword">this</span>);
	}
}


<span class="function"><span class="keyword">function</span> <span class="title">_setMessageSource</span><span class="params">(messageSource)</span> {</span>
	<span class="keyword">this</span>._messenger._setMessageSource(messageSource);
}


<span class="function"><span class="keyword">function</span> <span class="title">_createMessageSource</span><span class="params">(MessageSourceClass, options)</span> {</span>
	<span class="keyword">var</span> messageSource = <span class="keyword">new</span> MessageSourceClass(<span class="keyword">this</span>, <span class="literal">undefined</span>, <span class="keyword">this</span>.owner, options);
	<span class="keyword">this</span>._setMessageSource(messageSource)

	_.defineProperty(<span class="keyword">this</span>, <span class="string">'_messageSource'</span>, messageSource);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-191">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-191">&#182;</a>
              </div>
              <p><a name="components-info"></a></p>
<h3 id="component-info-class">component info class</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> componentsRegistry = require(<span class="string">'./c_registry'</span>)
	, facetsRegistry = require(<span class="string">'./c_facets/cf_registry'</span>)
	, BinderError = require(<span class="string">'../util/error'</span>).Binder;


module.exports = ComponentInfo;</pre></div></div>
            
        </li>
        
        
        <li id="section-192">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-192">&#182;</a>
              </div>
              <p>Component information class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">ComponentInfo</span><span class="params">(scope, el, attr)</span> {</span>
	attr.parse().validate();

	<span class="keyword">this</span>.scope = scope;
	<span class="keyword">this</span>.el = el;
	<span class="keyword">this</span>.attr = attr;
	<span class="keyword">this</span>.name = attr.compName;
	<span class="keyword">this</span>.ComponentClass = getComponentClass(attr);
	<span class="keyword">this</span>.extraFacetsClasses = getComponentExtraFacets(<span class="keyword">this</span>.ComponentClass, attr);

	<span class="keyword">if</span> (hasContainerFacet(<span class="keyword">this</span>.ComponentClass, attr))
		<span class="keyword">this</span>.container = {};


	<span class="function"><span class="keyword">function</span> <span class="title">getComponentClass</span><span class="params">(attr)</span> {</span>
		<span class="keyword">var</span> ComponentClass = componentsRegistry.get(attr.compClass);
		<span class="keyword">if</span> (! ComponentClass)
			<span class="keyword">throw</span> <span class="keyword">new</span> BinderError(<span class="string">'class '</span> + attr.compClass + <span class="string">' is not registered'</span>);
		<span class="keyword">return</span> ComponentClass;
	}

	<span class="function"><span class="keyword">function</span> <span class="title">getComponentExtraFacets</span><span class="params">(ComponentClass, attr)</span> {</span>
		<span class="keyword">var</span> facets = attr.compFacets
			, extraFacetsClasses = {};

		<span class="keyword">if</span> (Array.isArray(facets))
			facets.forEach(<span class="function"><span class="keyword">function</span><span class="params">(fctName)</span> {</span>
				<span class="keyword">if</span> (ComponentClass.hasFacet(fctName))
					<span class="keyword">throw</span> <span class="keyword">new</span> BinderError(<span class="string">'class '</span> + ComponentClass.name
										  + <span class="string">' already has facet '</span> + fctName);
				<span class="keyword">if</span> (extraFacetsClasses[fctName])
					<span class="keyword">throw</span> <span class="keyword">new</span> BinderError(<span class="string">'component '</span> + attr.compName
										  + <span class="string">' already has facet '</span> + fctName);
				<span class="keyword">var</span> FacetClass = facetsRegistry.get(fctName);
				extraFacetsClasses[fctName] = FacetClass;
			});

		<span class="keyword">return</span> extraFacetsClasses;
	}

	<span class="function"><span class="keyword">function</span> <span class="title">hasContainerFacet</span><span class="params">(ComponentClass, attr)</span> {</span>
		<span class="keyword">return</span> (ComponentClass.hasFacet(<span class="string">'container'</span>)
			|| (Array.isArray(attr.compFacets) &amp;&amp; attr.compFacets.indexOf(<span class="string">'Container'</span>) &gt;= <span class="number">0</span>));
	}
}</pre></div></div>
            
        </li>
        
        
        <li id="section-193">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-193">&#182;</a>
              </div>
              <p><a name="components-registry"></a></p>
<h3 id="component-registry-class">component registry class</h3>
<p>An instance of ClassRegistry class that is used by milo to register and find components.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> ClassRegistry = require(<span class="string">'../abstract/registry'</span>)
	, Component = require(<span class="string">'./c_class'</span>);

<span class="keyword">var</span> componentsRegistry = <span class="keyword">new</span> ClassRegistry(Component);

componentsRegistry.add(Component);

module.exports = componentsRegistry;</pre></div></div>
            
        </li>
        
        
        <li id="section-194">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-194">&#182;</a>
              </div>
              <p><a name="scope"></a></p>
<h2 id="scope-class">scope class</h2>

            </div>
            
        </li>
        
        
        <li id="section-195">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-195">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> _ = require(<span class="string">'mol-proto'</span>)
	, check = require(<span class="string">'../util/check'</span>)
	, Match = check.Match
	, ScopeError = require(<span class="string">'../util/error'</span>).Scope;</pre></div></div>
            
        </li>
        
        
        <li id="section-196">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-196">&#182;</a>
              </div>
              <p>Scope class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">Scope</span><span class="params">(rootEl, hostObject)</span> {</span>
	_.defineProperties(<span class="keyword">this</span>, {
		_rootEl: rootEl,
		_hostObject: hostObject
	}, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">true</span>); <span class="comment">// writable</span>
};

_.extendProto(Scope, {
	_add: _add,
	_copy: _copy,
	_each: _each,
	_addNew: _addNew,
	_merge: _merge,
	_length: _length
});

module.exports = Scope;


<span class="keyword">var</span> allowedNamePattern = <span class="regexp">/^[A-Za-z][A-Za-z0-9\_\$]*$/</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-197">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-197">&#182;</a>
              </div>
              <p>adds object to scope throwing if name is notyunique</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">_add</span><span class="params">(object, name)</span> {</span>
	<span class="keyword">if</span> (<span class="keyword">this</span>[name])
		<span class="keyword">throw</span> <span class="keyword">new</span> ScopeError(<span class="string">'duplicate object name: '</span> + name);

	checkName(name);

	<span class="keyword">this</span>[name] = object;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-198">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-198">&#182;</a>
              </div>
              <p>copies all objects from one scope to another,
throwing if some object is not unique</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">_copy</span><span class="params">(aScope)</span> {</span>
	check(aScope, Scope);

	aScope._each(_add, <span class="keyword">this</span>);
}


<span class="function"><span class="keyword">function</span> <span class="title">_addNew</span><span class="params">(object, name)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-199">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-199">&#182;</a>
              </div>
              <p>TODO</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>}


<span class="function"><span class="keyword">function</span> <span class="title">_merge</span><span class="params">(scope)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-200">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-200">&#182;</a>
              </div>
              <p>TODO</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>}


<span class="function"><span class="keyword">function</span> <span class="title">_each</span><span class="params">(callback, thisArg)</span> {</span>
	_.eachKey(<span class="keyword">this</span>, callback, thisArg || <span class="keyword">this</span>, <span class="literal">true</span>); <span class="comment">// enumerates enumerable properties only</span>
}


<span class="function"><span class="keyword">function</span> <span class="title">checkName</span><span class="params">(name)</span> {</span>
	<span class="keyword">if</span> (! allowedNamePattern.test(name))
		<span class="keyword">throw</span> <span class="keyword">new</span> ScopeError(<span class="string">'name should start from letter, this name is not allowed: '</span> + name);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-201">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-201">&#182;</a>
              </div>
              <p>returns the number of objects in scope</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">_length</span><span class="params">()</span> {</span>
	<span class="keyword">return</span> Object.keys(<span class="keyword">this</span>).length;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-202">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-202">&#182;</a>
              </div>
              <p><a name="components-source-data"></a></p>
<h3 id="component-data-source">component data source</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> DOMEventsSource = require(<span class="string">'./dom_events_source'</span>)
	, Component = require(<span class="string">'../c_class'</span>)
	, ComponentDataSourceError = require(<span class="string">'../../util/error'</span>).ComponentDataSource
	, _ = require(<span class="string">'mol-proto'</span>)
	, check = require(<span class="string">'../../util/check'</span>)
	, Match = check.Match;</pre></div></div>
            
        </li>
        
        
        <li id="section-203">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-203">&#182;</a>
              </div>
              <p>class to handle subscribtions to changes in DOM for UI (maybe also content editable) elements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> ComponentDataSource = _.createSubclass(DOMEventsSource, <span class="string">'ComponentDataSource'</span>, <span class="literal">true</span>);


_.extendProto(ComponentDataSource, {</pre></div></div>
            
        </li>
        
        
        <li id="section-204">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-204">&#182;</a>
              </div>
              <p>implementing MessageSource interface</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	init: initComponentDataSource,
	translateToSourceMessage: translateToDomEvent,
 	addSourceListener: addDomEventListener,
 	removeSourceListener: removeDomEventListener,
 	filterSourceMessage: filterDataMessage,</pre></div></div>
            
        </li>
        
        
        <li id="section-205">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-205">&#182;</a>
              </div>
              <p>class specific methods
dom: implemented in DOMEventsSource</p>

            </div>
            
            <div class="content"><div class='highlight'><pre> 	value: getDomElementDataValue,
 	handleEvent: handleEvent,  <span class="comment">// event dispatcher - as defined by Event DOM API</span>
 	trigger: triggerDataMessage <span class="comment">// redefines method of superclass DOMEventsSource</span>
});

module.exports = ComponentDataSource;


<span class="function"><span class="keyword">function</span> <span class="title">initComponentDataSource</span><span class="params">()</span> {</span>
	DOMEventsSource.prototype.init.apply(<span class="keyword">this</span>, arguments);

	<span class="keyword">this</span>.value(); <span class="comment">// stores current component data value in this._value</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-206">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-206">&#182;</a>
              </div>
              <p>TODO: should return value dependent on element tag</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">getDomElementDataValue</span><span class="params">()</span> {</span> <span class="comment">// value method</span>
	<span class="keyword">var</span> newValue = <span class="keyword">this</span>.component.el.value;

	Object.defineProperty(<span class="keyword">this</span>, <span class="string">'_value'</span>, {
		configurable: <span class="literal">true</span>,
		value: newValue
	});

	<span class="keyword">return</span> newValue;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-207">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-207">&#182;</a>
              </div>
              <p>TODO: this function should return relevant DOM event dependent on element tag
Can also implement beforedatachanged event to allow preventing the change</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">translateToDomEvent</span><span class="params">(message)</span> {</span>
	<span class="keyword">if</span> (message == <span class="string">'datachanged'</span>)
		<span class="keyword">return</span> <span class="string">'input'</span>;
	<span class="keyword">else</span>
		<span class="keyword">return</span> <span class="string">''</span>;
}


<span class="function"><span class="keyword">function</span> <span class="title">addDomEventListener</span><span class="params">(eventType)</span> {</span>
	<span class="keyword">if</span> (eventType)
		<span class="keyword">this</span>.dom().addEventListener(eventType, <span class="keyword">this</span>, <span class="literal">false</span>); <span class="comment">// no capturing</span>
}


<span class="function"><span class="keyword">function</span> <span class="title">removeDomEventListener</span><span class="params">(eventType)</span> {</span>
	<span class="keyword">if</span> (eventType)
		<span class="keyword">this</span>.dom().removeEventListener(eventType, <span class="keyword">this</span>, <span class="literal">false</span>); <span class="comment">// no capturing</span>
}


<span class="function"><span class="keyword">function</span> <span class="title">filterDataMessage</span><span class="params">(eventType, message, data)</span> {</span>
	<span class="keyword">return</span> data.newValue != data.oldValue;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-208">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-208">&#182;</a>
              </div>
              <p>event dispatcher - as defined by Event DOM API</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">handleEvent</span><span class="params">(event)</span> {</span>
	<span class="keyword">var</span> oldValue = <span class="keyword">this</span>._value;

	<span class="keyword">this</span>.dispatchMessage(event.type, {
		oldValue: oldValue,
		newValue: <span class="keyword">this</span>.value()
	});
}


<span class="function"><span class="keyword">function</span> <span class="title">triggerDataMessage</span><span class="params">(message, data)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-209">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-209">&#182;</a>
              </div>
              <p>TODO - opposite translation + event trigger </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>}</pre></div></div>
            
        </li>
        
        
        <li id="section-210">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-210">&#182;</a>
              </div>
              <p><a name="components-source-dom"></a></p>
<h3 id="component-dom-events-source">component dom events source</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> MessageSource = require(<span class="string">'../../messenger/message_source'</span>)
	, Component = require(<span class="string">'../c_class'</span>)
	, domEventsConstructors = require(<span class="string">'./dom_events_constructors'</span>) <span class="comment">// TODO merge with DOMEventSource ??</span>
	, _ = require(<span class="string">'mol-proto'</span>)
	, check = require(<span class="string">'../../util/check'</span>)
	, Match = check.Match;

<span class="keyword">var</span> DOMEventsSource = _.createSubclass(MessageSource, <span class="string">'DOMMessageSource'</span>, <span class="literal">true</span>);


_.extendProto(DOMEventsSource, {</pre></div></div>
            
        </li>
        
        
        <li id="section-211">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-211">&#182;</a>
              </div>
              <p>implementing MessageSource interface</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	init: init,
	translateToSourceMessage: translateToSourceMessage,
 	addSourceListener: addSourceListener,
 	removeSourceListener: removeSourceListener,
 	filterSourceMessage: filterCapturedDomEvent,</pre></div></div>
            
        </li>
        
        
        <li id="section-212">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-212">&#182;</a>
              </div>
              <p>class specific methods</p>

            </div>
            
            <div class="content"><div class='highlight'><pre> 	dom: dom,
 	handleEvent: handleEvent,  <span class="comment">// event dispatcher - as defined by Event DOM API</span>
 	trigger: triggerDomEvent
});

module.exports = DOMEventsSource;


<span class="keyword">var</span> useCapturePattern = <span class="regexp">/__capture$/</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-213">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-213">&#182;</a>
              </div>
              <p>init DOM event source</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">(hostObject, proxyMethods, component)</span> {</span>
	check(component, Component);
	MessageSource.prototype.init.apply(<span class="keyword">this</span>, arguments);

	<span class="keyword">this</span>.component = component;</pre></div></div>
            
        </li>
        
        
        <li id="section-214">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-214">&#182;</a>
              </div>
              <p>this.messenger is set by Messenger class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>}</pre></div></div>
            
        </li>
        
        
        <li id="section-215">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-215">&#182;</a>
              </div>
              <p>get DOM element of component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">dom</span><span class="params">()</span> {</span>
	<span class="keyword">return</span> <span class="keyword">this</span>.component.el;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-216">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-216">&#182;</a>
              </div>
              <p>translate to DOM event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">translateToSourceMessage</span><span class="params">(message)</span> {</span>
	<span class="keyword">if</span> (useCapturePattern.test(message))
		message = message.replace(useCapturePattern, <span class="string">''</span>);
	<span class="keyword">return</span> message;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-217">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-217">&#182;</a>
              </div>
              <p>add listener to DOM event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">addSourceListener</span><span class="params">(eventType)</span> {</span>
	<span class="keyword">this</span>.dom().addEventListener(eventType, <span class="keyword">this</span>, <span class="literal">false</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-218">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-218">&#182;</a>
              </div>
              <p>remove listener from DOM event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">removeSourceListener</span><span class="params">(eventType)</span> {</span>
	<span class="keyword">this</span>.dom().removeEventListener(eventType, <span class="keyword">this</span>, <span class="literal">false</span>);
}


<span class="function"><span class="keyword">function</span> <span class="title">filterCapturedDomEvent</span><span class="params">(eventType, message, event)</span> {</span>
	<span class="keyword">var</span> isCapturePhase;
	<span class="keyword">if</span> (<span class="keyword">typeof</span> window != <span class="string">'undefined'</span>)
		isCapturePhase = event.eventPhase == window.Event.CAPTURING_PHASE;

	<span class="keyword">return</span> (! isCapturePhase || (isCapturePhase &amp;&amp; useCapturePattern.test(message)));
}</pre></div></div>
            
        </li>
        
        
        <li id="section-219">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-219">&#182;</a>
              </div>
              <p>event dispatcher - as defined by Event DOM API</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">handleEvent</span><span class="params">(event)</span> {</span>
	<span class="keyword">this</span>.dispatchMessage(event.type, event);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-220">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-220">&#182;</a>
              </div>
              <p>TODO make work with messages (with _capture)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">triggerDomEvent</span><span class="params">(eventType, properties)</span> {</span>
	check(eventType, String);
	check(properties, Match.Optional(Object));

	<span class="keyword">var</span> EventConstructor = domEventsConstructors[eventType];

	<span class="keyword">if</span> (<span class="keyword">typeof</span> eventConstructor != <span class="string">'function'</span>)
		<span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'unsupported event type'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-221">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-221">&#182;</a>
              </div>
              <p>check if it is correct</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">if</span> (<span class="keyword">typeof</span> properties != <span class="string">'undefined'</span>)
		properties.type = eventType;

	<span class="keyword">var</span> domEvent = EventConstructor(eventType, properties);

	<span class="keyword">var</span> notCancelled = <span class="keyword">this</span>.dom().dispatchEvent(domEvent);

	<span class="keyword">return</span> notCancelled;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-222">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-222">&#182;</a>
              </div>
              <p><a name="components-dom-constructors"></a></p>
<h3 id="dom-events-constructors">dom events constructors</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> _ = require(<span class="string">'mol-proto'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-223">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-223">&#182;</a>
              </div>
              <p><a href="https://developer.mozilla.org/en-US/docs/Web/Reference/Events">https://developer.mozilla.org/en-US/docs/Web/Reference/Events</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> eventTypes = {
	ClipboardEvent: [<span class="string">'copy'</span>, <span class="string">'cut'</span>, <span class="string">'paste'</span>, <span class="string">'beforecopy'</span>, <span class="string">'beforecut'</span>, <span class="string">'beforepaste'</span>],
	Event: [<span class="string">'input'</span>, <span class="string">'readystatechange'</span>],
	FocusEvent: [<span class="string">'focus'</span>, <span class="string">'blur'</span>, <span class="string">'focusin'</span>, <span class="string">'focusout'</span>],
	KeyboardEvent: [<span class="string">'keydown'</span>, <span class="string">'keypress'</span>,  <span class="string">'keyup'</span>],
	MouseEvent: [<span class="string">'click'</span>, <span class="string">'contextmenu'</span>, <span class="string">'dblclick'</span>, <span class="string">'mousedown'</span>, <span class="string">'mouseup'</span>,
				 <span class="string">'mouseenter'</span>, <span class="string">'mouseleave'</span>, <span class="string">'mousemove'</span>, <span class="string">'mouseout'</span>, <span class="string">'mouseover'</span>,
				 <span class="string">'show'</span> <span class="comment">/* context menu */</span>],
	TouchEvent: [<span class="string">'touchstart'</span>, <span class="string">'touchend'</span>, <span class="string">'touchmove'</span>, <span class="string">'touchenter'</span>, <span class="string">'touchleave'</span>, <span class="string">'touchcancel'</span>],
};</pre></div></div>
            
        </li>
        
        
        <li id="section-224">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-224">&#182;</a>
              </div>
              <p>mock window and event constructors for testing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">if</span> (<span class="keyword">typeof</span> window != <span class="string">'undefined'</span>)
	<span class="keyword">var</span> global = window;
<span class="keyword">else</span> {
	global = {};
	_.eachKey(eventTypes, <span class="function"><span class="keyword">function</span><span class="params">(eTypes, eventConstructorName)</span> {</span>
		<span class="keyword">var</span> eventsConstructor;
		eval(
			<span class="string">'eventsConstructor = function '</span> + eventConstructorName + <span class="string">'(type, properties) { \
				this.type = type; \
				_.extend(this, properties); \
			};'</span>
		);
		global[eventConstructorName] = eventsConstructor;
	});
}


<span class="keyword">var</span> domEventsConstructors = {};

_.eachKey(eventTypes, <span class="function"><span class="keyword">function</span><span class="params">(eTypes, eventConstructorName)</span> {</span>
	eTypes.forEach(<span class="function"><span class="keyword">function</span><span class="params">(type)</span> {</span>
		<span class="keyword">if</span> (Object.hasOwnProperty(domEventsConstructors, type))
			<span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'duplicate event type '</span> + type);

		domEventsConstructors[type] = global[eventConstructorName];
	});
});


module.exports = domEventsConstructors;</pre></div></div>
            
        </li>
        
        
        <li id="section-225">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-225">&#182;</a>
              </div>
              <p><a name="components-source-editable"></a></p>
<h3 id="component-editable-events-source">component editable events source</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> DOMEventsSource = require(<span class="string">'./dom_events_source'</span>)
	, Component = require(<span class="string">'../c_class'</span>)
	, EditableEventsSourceError = require(<span class="string">'../../util/error'</span>).EditableEventsSource
	, _ = require(<span class="string">'mol-proto'</span>)
	, check = require(<span class="string">'../../util/check'</span>)
	, Match = check.Match;</pre></div></div>
            
        </li>
        
        
        <li id="section-226">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-226">&#182;</a>
              </div>
              <p>class to handle subscribtions to changes in DOM for UI (maybe also content editable) elements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> EditableEventsSource = _.createSubclass(DOMEventsSource, <span class="string">'EditableEventsSource'</span>, <span class="literal">true</span>);


_.extendProto(EditableEventsSource, {</pre></div></div>
            
        </li>
        
        
        <li id="section-227">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-227">&#182;</a>
              </div>
              <p>implementing MessageSource interface</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	init: initEditableEventsSource,
	translateToSourceMessage: translateToDomEvent,
 	addSourceListener: addDomEventListener,
 	removeSourceListener: removeDomEventListener,
 	filterSourceMessage: filterEditableMessage,</pre></div></div>
            
        </li>
        
        
        <li id="section-228">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-228">&#182;</a>
              </div>
              <p>class specific methods
dom: implemented in DOMEventsSource</p>

            </div>
            
            <div class="content"><div class='highlight'><pre> 	handleEvent: handleEvent,  <span class="comment">// event dispatcher - as defined by Event DOM API</span>
 	trigger: triggerEditableEvent <span class="comment">// redefines method of superclass DOMEventsSource</span>
});

module.exports = EditableEventsSource;


<span class="function"><span class="keyword">function</span> <span class="title">initEditableEventsSource</span><span class="params">(hostObject, proxyMethods, component, options)</span> {</span>
	DOMEventsSource.prototype.init.apply(<span class="keyword">this</span>, arguments);
	<span class="keyword">this</span>.options = options;
}


<span class="keyword">var</span> editableEventsMap = {
	<span class="string">'enterkey'</span>: <span class="string">'keypress'</span>,
	<span class="string">'editstart'</span>: <span class="string">'mousedown'</span>,
	<span class="string">'editend'</span>: <span class="string">'blur'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-229">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-229">&#182;</a>
              </div>
              <p>move events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="string">'nexteditable'</span>: <span class="string">'keydown'</span>,
	<span class="string">'previouseditable'</span>: <span class="string">'keydown'</span>,	
	<span class="string">'adjacenteditable'</span>: <span class="string">'keydown'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-230">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-230">&#182;</a>
              </div>
              <p>merge events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="string">'nextmerge'</span>: <span class="string">'keydown'</span>,
	<span class="string">'previousmerge'</span>: <span class="string">'keydown'</span>,
	<span class="string">'adjacentmerge'</span>: <span class="string">'keydown'</span>,
};</pre></div></div>
            
        </li>
        
        
        <li id="section-231">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-231">&#182;</a>
              </div>
              <p>TODO: this function should return relevant DOM event dependent on element tag
Can also implement beforedatachanged event to allow preventing the change</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">translateToDomEvent</span><span class="params">(message)</span> {</span>
	<span class="keyword">if</span> (editableEventsMap.hasOwnProperty(message))
		<span class="keyword">return</span> editableEventsMap[message];
	<span class="keyword">else</span>
		<span class="keyword">return</span> DOMEventsSource.prototype.translateToSourceMessage.call(<span class="keyword">this</span>, message);
}


<span class="function"><span class="keyword">function</span> <span class="title">addDomEventListener</span><span class="params">(eventType)</span> {</span>
	<span class="keyword">this</span>.dom().addEventListener(eventType, <span class="keyword">this</span>, <span class="literal">false</span>); <span class="comment">// no capturing</span>
}


<span class="function"><span class="keyword">function</span> <span class="title">removeDomEventListener</span><span class="params">(eventType)</span> {</span>
	<span class="keyword">this</span>.dom().removeEventListener(eventType, <span class="keyword">this</span>, <span class="literal">false</span>); <span class="comment">// no capturing</span>
}


<span class="function"><span class="keyword">function</span> <span class="title">filterEditableMessage</span><span class="params">(eventType, message, data)</span> {</span>
	<span class="keyword">var</span> self = <span class="keyword">this</span>;

	<span class="keyword">switch</span> (message) {
		<span class="keyword">case</span> <span class="string">'enterkey'</span>:
		 	<span class="keyword">return</span> data.keyCode == <span class="number">13</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-232">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-232">&#182;</a>
              </div>
              <p>move to adjacent editable events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="keyword">case</span> <span class="string">'previouseditable'</span>:
			<span class="keyword">return</span> <span class="keyword">this</span>.options.moveToAdjacentEditable
				&amp;&amp; movedToPrevious(data);
		<span class="keyword">case</span> <span class="string">'nexteditable'</span>:
			<span class="keyword">return</span> <span class="keyword">this</span>.options.moveToAdjacentEditable
				&amp;&amp; movedToNext(data);
		<span class="keyword">case</span> <span class="string">'adjacenteditable'</span>:
			<span class="keyword">return</span> <span class="keyword">this</span>.options.moveToAdjacentEditable
				&amp;&amp; (movedToPrevious(data) || movedToNext(data));</pre></div></div>
            
        </li>
        
        
        <li id="section-233">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-233">&#182;</a>
              </div>
              <p>merge adjacent editable events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="keyword">case</span> <span class="string">'previousmerge'</span>: <span class="comment">// merge current one into previous on backspace key</span>
			<span class="keyword">return</span> <span class="keyword">this</span>.options.allowMerge &amp;&amp; mergeToPrevious(data)
		<span class="keyword">case</span> <span class="string">'nextmerge'</span>: <span class="comment">// merge current one into previous on backspace key</span>
			<span class="keyword">return</span> <span class="keyword">this</span>.options.allowMerge &amp;&amp; mergeToNext(data)
		<span class="keyword">case</span> <span class="string">'adjacentmerge'</span>:
			<span class="keyword">return</span> <span class="keyword">this</span>.options.allowMerge
				&amp;&amp; (mergeToPrevious(data) || mergeToNext(data));

		<span class="keyword">case</span> <span class="string">'editstart'</span>:
		<span class="keyword">case</span> <span class="string">'editend'</span>:
			<span class="keyword">return</span> <span class="keyword">this</span>.options.editableOnClick;
		<span class="keyword">default</span>:
			<span class="keyword">return</span> <span class="literal">true</span>;
	}

	<span class="function"><span class="keyword">function</span> <span class="title">movedToPrevious</span><span class="params">(data)</span> {</span>
		<span class="keyword">return</span> (data.keyCode == <span class="number">37</span> || data.keyCode == <span class="number">38</span>) <span class="comment">// up and left</span>
			&amp;&amp; noTextBeforeSelection(self.component);
	}

	<span class="function"><span class="keyword">function</span> <span class="title">movedToNext</span><span class="params">(data)</span> {</span>
		<span class="keyword">return</span> (data.keyCode == <span class="number">39</span> || data.keyCode == <span class="number">40</span>) <span class="comment">// down and right</span>
			&amp;&amp; noTextAfterSelection(self.component);
	} 

	<span class="function"><span class="keyword">function</span> <span class="title">mergeToPrevious</span><span class="params">(data)</span> {</span>
		<span class="keyword">return</span> data.keyCode == <span class="number">8</span> <span class="comment">// backspace</span>
			&amp;&amp; noTextBeforeSelection(self.component);
	}

	<span class="function"><span class="keyword">function</span> <span class="title">mergeToNext</span><span class="params">(data)</span> {</span>
		<span class="keyword">return</span> data.keyCode == <span class="number">46</span> <span class="comment">// delete</span>
			&amp;&amp; noTextAfterSelection(self.component);
	}

	<span class="function"><span class="keyword">function</span> <span class="title">noTextBeforeSelection</span><span class="params">(component)</span> {</span>
		<span class="keyword">return</span> ! component.dom.hasTextBeforeSelection();
	};

	<span class="function"><span class="keyword">function</span> <span class="title">noTextAfterSelection</span><span class="params">(component)</span> {</span>
		<span class="keyword">var</span> sel = window.getSelection();
		<span class="keyword">if</span> (sel.anchorOffset == sel.anchorNode.length) {
			<span class="keyword">if</span> (sel.anchorNode.nextSibling) {
				<span class="keyword">return</span> <span class="literal">false</span>;
			} <span class="keyword">else</span> {
				<span class="keyword">return</span> <span class="literal">true</span>;
			}
		}
	}
}</pre></div></div>
            
        </li>
        
        
        <li id="section-234">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-234">&#182;</a>
              </div>
              <p>event dispatcher - as defined by Event DOM API</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">handleEvent</span><span class="params">(event)</span> {</span>
	<span class="keyword">this</span>.dispatchMessage(event.type, event);
}


<span class="function"><span class="keyword">function</span> <span class="title">triggerEditableEvent</span><span class="params">(message, data)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-235">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-235">&#182;</a>
              </div>
              <p>TODO - opposite translation + event trigger </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>}</pre></div></div>
            
        </li>
        
        
        <li id="section-236">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-236">&#182;</a>
              </div>
              <p><a name="components-source-iframe"></a></p>
<h3 id="component-iframe-source">component iframe source</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> MessageSource = require(<span class="string">'../../messenger/message_source'</span>)
	, _ = require(<span class="string">'mol-proto'</span>)
	, check = require(<span class="string">'../../util/check'</span>)
	, Match = check.Match;

<span class="keyword">var</span> iFrameMessageSource = _.createSubclass(MessageSource, <span class="string">'iFrameMessageSource'</span>, <span class="literal">true</span>);


_.extendProto(iFrameMessageSource, {</pre></div></div>
            
        </li>
        
        
        <li id="section-237">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-237">&#182;</a>
              </div>
              <p>implementing MessageSource interface</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	init: initIFrameMessageSource,
	translateToSourceMessage: translateToIFrameMessage,
 	addSourceListener: addIFrameMessageListener,
 	removeSourceListener: removeIFrameMessageListener,
 	filterSourceMessage: filterRecievedIFrameMessage,</pre></div></div>
            
        </li>
        
        
        <li id="section-238">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-238">&#182;</a>
              </div>
              <p>class specific methods</p>

            </div>
            
            <div class="content"><div class='highlight'><pre> 	post: postToOtherWindow,
 	handleEvent: handleEvent  <span class="comment">// event dispatcher - as defined by Event DOM API</span>
});

module.exports = iFrameMessageSource;


<span class="function"><span class="keyword">function</span> <span class="title">initIFrameMessageSource</span><span class="params">(hostObject, proxyMethods)</span> {</span>
	check(hostObject, Object);
	MessageSource.prototype.init.apply(<span class="keyword">this</span>, arguments);

	<span class="keyword">if</span> (hostObject.owner.el.nodeName == <span class="string">'IFRAME'</span>)
		<span class="keyword">this</span>._postTo = hostObject.owner.el.contentWindow;
	<span class="keyword">else</span>
		<span class="keyword">this</span>._postTo = window.parent;

	<span class="keyword">this</span>._listenTo = window;
}


<span class="function"><span class="keyword">function</span> <span class="title">translateToIFrameMessage</span><span class="params">(message)</span> {</span>
	<span class="keyword">return</span> <span class="string">'message'</span>; <span class="comment">// sourceMessage</span>
}


<span class="function"><span class="keyword">function</span> <span class="title">addIFrameMessageListener</span><span class="params">(eventType)</span> {</span>
	<span class="keyword">this</span>._listenTo.addEventListener(eventType, <span class="keyword">this</span>, <span class="literal">false</span>);
}


<span class="function"><span class="keyword">function</span> <span class="title">removeIFrameMessageListener</span><span class="params">(eventType)</span> {</span>
	<span class="keyword">this</span>._listenTo.removeEventListener(eventType, <span class="keyword">this</span>, <span class="literal">false</span>);
}


<span class="function"><span class="keyword">function</span> <span class="title">filterRecievedIFrameMessage</span><span class="params">(eventType, message, event)</span> {</span>
	<span class="keyword">return</span> <span class="literal">true</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">postToOtherWindow</span><span class="params">(eventType, message)</span> {</span>
	message.type = eventType;
	<span class="keyword">this</span>._postTo.postMessage(message, <span class="string">'*'</span>);
}

<span class="function"><span class="keyword">function</span> <span class="title">handleEvent</span><span class="params">(event)</span> {</span>
	<span class="keyword">this</span>.dispatchMessage(event.type, event);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-239">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-239">&#182;</a>
              </div>
              <p><a name="model"></a></p>
<h2 id="milo-model">milo model</h2>

            </div>
            
        </li>
        
        
        <li id="section-240">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-240">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> pathUtils = require(<span class="string">'./path_utils'</span>)
	, Messenger = require(<span class="string">'../messenger'</span>)
	, ModelError = require(<span class="string">'../util/error'</span>).Model
	, Mixin = require(<span class="string">'../abstract/mixin'</span>)
	, doT = require(<span class="string">'dot'</span>)
	, _ = require(<span class="string">'mol-proto'</span>)
	, check = require(<span class="string">'../util/check'</span>)
	, Match = check.Match
	, fs = require(<span class="string">'fs'</span>);

module.exports = Model;


<span class="function"><span class="keyword">function</span> <span class="title">Model</span><span class="params">(scope, schema, name, data)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-241">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-241">&#182;</a>
              </div>
              <p>modelPath should return a ModelPath object with &quot;compiled&quot; methods
to get/set model properties, to subscribe to property changes, etc.
&quot;it&quot; parameter is the object which properties can be referenced in path.
These references will be evaluated at run rather than at compile time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">var</span> model = <span class="function"><span class="keyword">function</span> <span class="title">modelPath</span><span class="params">(path, it)</span> {</span>
		<span class="keyword">return</span> <span class="keyword">new</span> ModelPath(model, path, it);
	}
	model.__proto__ = Model.prototype;

	<span class="keyword">var</span> messenger = <span class="keyword">new</span> Messenger(model, Messenger.defaultMethods);

	_.defineProperties(model, {
		scope: scope,
		name: name,
		_schema: schema,
		_messenger: messenger,
		__pathsCache: {}
	});

	model._wrapMessengerMethods(modelMethodsToWrap);

	model._data = data;

	<span class="keyword">return</span> model;
}

Model.prototype.__proto__ = Model.__proto__;</pre></div></div>
            
        </li>
        
        
        <li id="section-242">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-242">&#182;</a>
              </div>
              <p>these methods will be wrapped to support &quot;*&quot; pattern subscriptions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> modelMethodsToWrap = [<span class="string">'on'</span>, <span class="string">'off'</span>, <span class="string">'onMessages'</span>, <span class="string">'offMessages'</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-243">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-243">&#182;</a>
              </div>
              <p>cache of compiled ModelPath methods</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> __synthesizedPathsMethods = {};

<span class="keyword">var</span> dotDef = {
	modelAccessPrefix: <span class="string">'this._model._data'</span>,
	modelPostMessageCode: <span class="string">'this._model.postMessage'</span>,
	getPathNodeKey: pathUtils.getPathNodeKey
};

<span class="keyword">var</span> modelSetterDotDef = {
	modelAccessPrefix: <span class="string">'this._data'</span>,
	modelPostMessageCode: <span class="string">'this.postMessage'</span>,
	getPathNodeKey: pathUtils.getPathNodeKey
};

<span class="keyword">var</span> getterTemplate = fs.readFileSync(__dirname + <span class="string">'/getter_template.js'</span>)
	, setterTemplate = fs.readFileSync(__dirname + <span class="string">'/setter_template.js'</span>);

doT.templateSettings.strip = <span class="literal">false</span>;

<span class="keyword">var</span> getterSynthesizer = doT.compile(getterTemplate, dotDef)
	, setterSynthesizer = doT.compile(setterTemplate, dotDef)
	, modelSetterSynthesizer = doT.compile(setterTemplate, modelSetterDotDef);


_.extendProto(Model, {
	get: get,
	set: synthesizeMethod(modelSetterSynthesizer, <span class="string">''</span>, []),
	path: path,
	proxyMessenger: proxyMessenger,
	_wrapMessengerMethods: pathUtils.wrapMessengerMethods
});

<span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">()</span> {</span>
	<span class="keyword">return</span> <span class="keyword">this</span>._data;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-244">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-244">&#182;</a>
              </div>
              <p>returns ModelPath object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">path</span><span class="params">(accessPath)</span> {</span>
	<span class="keyword">return</span> <span class="keyword">this</span>(accessPath);
}


<span class="function"><span class="keyword">function</span> <span class="title">proxyMessenger</span><span class="params">(modelHostObject)</span> {</span>
	Mixin.prototype._createProxyMethods.call(<span class="keyword">this</span>._messenger, Messenger.defaultMethods, modelHostObject);
}


_.extend(Model, {
	Path: ModelPath
});

<span class="function"><span class="keyword">function</span> <span class="title">ModelPath</span><span class="params">(model, path, it)</span> {</span>
	check(model, Model);
	check(path, String);
	check(it, Match.Optional(Object));

	_.defineProperties(<span class="keyword">this</span>, {
		_model: model,
		_path: path,
		_it: it
	});</pre></div></div>
            
        </li>
        
        
        <li id="section-245">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-245">&#182;</a>
              </div>
              <p>compiling getter and setter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">var</span> methods = synthesizePathMethods(path);</pre></div></div>
            
        </li>
        
        
        <li id="section-246">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-246">&#182;</a>
              </div>
              <p>adding methods to model path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	_.defineProperties(<span class="keyword">this</span>, methods);

	Object.freeze(<span class="keyword">this</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-247">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-247">&#182;</a>
              </div>
              <p>adding messaging methods to ModelPath prototype</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> modelPathMethodsMap = {};

modelMethodsToWrap.forEach(<span class="function"><span class="keyword">function</span><span class="params">(methodName)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-248">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-248">&#182;</a>
              </div>
              <p>creating subscribe/unsubscribe/etc. methods for ModelPath class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	modelPathMethodsMap[methodName] = <span class="function"><span class="keyword">function</span><span class="params">(path, subscriber)</span> {</span>
		<span class="keyword">this</span>._model[methodName](<span class="keyword">this</span>._path + path, subscriber);
	};
})

_.extendProto(ModelPath, modelPathMethodsMap);


<span class="function"><span class="keyword">function</span> <span class="title">synthesizePathMethods</span><span class="params">(path)</span> {</span>
	<span class="keyword">if</span> (__synthesizedPathsMethods.hasOwnProperty(path))
		<span class="keyword">return</span> __synthesizedPathsMethods[path];

	<span class="keyword">var</span> parsedPath = pathUtils.parseAccessPath(path);

	<span class="keyword">var</span> methods = {
		get: synthesizeMethod(getterSynthesizer, path, parsedPath),
		set: synthesizeMethod(setterSynthesizer, path, parsedPath)
	};

	__synthesizedPathsMethods[path] = methods;

	<span class="keyword">return</span> methods;
}


<span class="function"><span class="keyword">function</span> <span class="title">synthesizeMethod</span><span class="params">(synthesizer, path, parsedPath)</span> {</span>
	<span class="keyword">var</span> method
		, methodCode = synthesizer({ parsedPath: parsedPath });

	<span class="keyword">try</span> {
		eval(methodCode);
	} <span class="keyword">catch</span> (e) {
		<span class="keyword">throw</span> ModelError(<span class="string">'ModelPath method compilation error; path: '</span> + path + <span class="string">', code: '</span> + methodCode);
	}

	<span class="keyword">return</span> method;</pre></div></div>
            
        </li>
        
        
        <li id="section-249">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-249">&#182;</a>
              </div>
              <p>functions used by ModelPath setter (synthesized by template)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="function"><span class="keyword">function</span> <span class="title">addChangeMessage</span><span class="params">(messages, messagesHash, msg)</span> {</span>
		messages.push(msg);
		messagesHash[msg.path] = msg;
	}

	<span class="function"><span class="keyword">function</span> <span class="title">addTreeChangesMessages</span><span class="params">(messages, messagesHash, rootPath, oldValue, newValue)</span> {</span>
		<span class="keyword">var</span> oldIsTree = valueIsTree(oldValue)
			, newIsTree = valueIsTree(newValue);

		<span class="keyword">if</span> (newIsTree)
			addMessages(rootPath, newValue, <span class="string">'added'</span>, <span class="string">'newValue'</span>);
		
		<span class="keyword">if</span> (oldIsTree)
			addMessages(rootPath, oldValue, <span class="string">'removed'</span>, <span class="string">'oldValue'</span>);


		<span class="function"><span class="keyword">function</span> <span class="title">addMessages</span><span class="params">(rootPath, obj, msgType, valueProp)</span> {</span>
			<span class="keyword">if</span> (Array.isArray(obj)) {
				<span class="keyword">var</span> pathSyntax = rootPath + <span class="string">'[$$]'</span>;
				obj.forEach(<span class="function"><span class="keyword">function</span><span class="params">(value, index)</span> {</span>
					addMessage(value, index, pathSyntax);
				});
			} <span class="keyword">else</span> {
				<span class="keyword">var</span> pathSyntax = rootPath + <span class="string">'.$$'</span>;
				_.eachKey(obj, <span class="function"><span class="keyword">function</span><span class="params">(value, key)</span> {</span>
					addMessage(value, key, pathSyntax);
				});
			}


			<span class="function"><span class="keyword">function</span> <span class="title">addMessage</span><span class="params">(value, key, pathSyntax)</span> {</span>
				<span class="keyword">var</span> path = pathSyntax.replace(<span class="string">'$$'</span>, key)
					, existingMsg = messagesHash[path];

				<span class="keyword">if</span> (existingMsg) {
					<span class="keyword">if</span> (existingMsg.type == msgType)
						logger.error(<span class="string">'setter error: same message type posted on the same path'</span>)
					<span class="keyword">else</span> {
						existingMsg.type = <span class="string">'changed'</span>;
						existingMsg[valueProp] = value;
					}
				} <span class="keyword">else</span> {
					<span class="keyword">var</span> msg = { path: path, type: msgType };
					msg[valueProp] = value;
					addChangeMessage(messages, messagesHash, msg)
				}

				<span class="keyword">if</span> (valueIsTree(value))
					addMessages(path, value, msgType, valueProp);
			}
		}
	}

	<span class="function"><span class="keyword">function</span> <span class="title">valueIsTree</span><span class="params">(value)</span> {</span>
		<span class="keyword">return</span> <span class="keyword">typeof</span> value == <span class="string">"object"</span> &amp;&amp; Object.keys(value).length;
	}
}</pre></div></div>
            
        </li>
        
        
        <li id="section-250">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-250">&#182;</a>
              </div>
              <p><a name="model-connector"></a></p>
<h3 id="model-connector">model connector</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> ConnectorError = require(<span class="string">'../util/error'</span>).Connector
	, _ = require(<span class="string">'mol-proto'</span>)
	, logger = require(<span class="string">'../util/logger'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-251">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-251">&#182;</a>
              </div>
              <p>Class that creates connector object for data connection between
two data-sources
Data-sources should implement the following API:
get() - get value
set(value) - set value
on(path, subscriber) - subscription to data changes with &quot;*&quot; support
off(path, subscriber)
path(accessPath) - to return the object that complies with that api too</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> modePattern = <span class="regexp">/^(\&lt;*)\-+(\&gt;*)$/</span>;

<span class="function"><span class="keyword">function</span> <span class="title">Connector</span><span class="params">(ds1, mode, ds2, options)</span> {</span>
	<span class="keyword">var</span> parsedMode = mode.match(modePattern);

	<span class="keyword">if</span> (! parsedMode)
		modeParseError();

	<span class="keyword">var</span> depth1 = parsedMode[<span class="number">1</span>].length
		, depth2 = parsedMode[<span class="number">2</span>].length;

	<span class="keyword">if</span> (depth1 &amp;&amp; depth2 &amp;&amp; depth1 != depth2)
		modeParseError();

	<span class="keyword">if</span> (! depth1 &amp;&amp; ! depth2)
		modeParseError();

	_.extend(<span class="keyword">this</span>, {
		ds1: ds1,
		ds2: ds2,
		mode: mode,
		depth1: depth1,
		depth2: depth2,
		isOn: <span class="literal">false</span>	
	});

	<span class="keyword">this</span>.on();

	<span class="function"><span class="keyword">function</span> <span class="title">modeParseError</span><span class="params">()</span> {</span>
		<span class="keyword">throw</span> <span class="keyword">new</span> ConnectorError(<span class="string">'invalid Connector mode: '</span> + mode);
	}
}


_.extendProto(Connector, {
	on: on,
	off: off
});</pre></div></div>
            
        </li>
        
        
        <li id="section-252">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-252">&#182;</a>
              </div>
              <p>create connection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">on</span><span class="params">()</span> {</span>
	<span class="keyword">if</span> (<span class="keyword">this</span>.isOn)
		<span class="keyword">return</span> logger.warn(<span class="string">'data sources are already connected'</span>);

	<span class="keyword">var</span> subscriptionPath = <span class="keyword">this</span>._subscriptionPath =
		<span class="keyword">new</span> Array((<span class="keyword">this</span>.depth1 || <span class="keyword">this</span>.depth2) + <span class="number">1</span>).join(<span class="string">'*'</span>);

	<span class="keyword">if</span> (<span class="keyword">this</span>.depth1)
		<span class="keyword">this</span>._link1 = linkDataSource(<span class="keyword">this</span>.ds1, <span class="keyword">this</span>.ds2, subscriptionPath);
	<span class="keyword">if</span> (<span class="keyword">this</span>.depth2)
		<span class="keyword">this</span>._link2 = linkDataSource(<span class="keyword">this</span>.ds2, <span class="keyword">this</span>.ds1, subscriptionPath);

	<span class="keyword">this</span>.isOn = <span class="literal">true</span>;


	<span class="function"><span class="keyword">function</span> <span class="title">linkDataSource</span><span class="params">(linkTo, linked, subscriptionPath)</span> {</span>
		<span class="keyword">var</span> onData = <span class="function"><span class="keyword">function</span><span class="params">(path, data)</span> {</span>
			linkTo.path(path).set(data.newValue);
		};

		linked.on(subscriptionPath, onData);

		<span class="keyword">return</span> onData;
	}
}


<span class="function"><span class="keyword">function</span> <span class="title">off</span><span class="params">()</span> {</span>
	<span class="keyword">if</span> (! <span class="keyword">this</span>.isOn)
		<span class="keyword">return</span> logger.warn(<span class="string">'data sources are already connected'</span>);

	<span class="keyword">if</span> (<span class="keyword">this</span>._link1)
		<span class="keyword">this</span>.ds2.off(<span class="keyword">this</span>._subscriptionPath, <span class="keyword">this</span>._link1);

	<span class="keyword">if</span> (<span class="keyword">this</span>._link2)
		<span class="keyword">this</span>.ds2.off(<span class="keyword">this</span>._subscriptionPath, <span class="keyword">this</span>._link2);

	<span class="keyword">this</span>.isOn = <span class="literal">false</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-253">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-253">&#182;</a>
              </div>
              <p><a name="model-demo"></a></p>
<h3 id="model-demo">model demo</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;
<span class="keyword">var</span> Model = require(<span class="string">'./index'</span>);


<span class="keyword">var</span> m = <span class="keyword">new</span> Model;

<span class="keyword">var</span> year = m(<span class="string">'.info.DOB.year'</span>).get();</pre></div></div>
            
        </li>
        
        
        <li id="section-254">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-254">&#182;</a>
              </div>
              <p>undefined, but doesn&#39;t fail, like in Angular</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>m(<span class="string">'.info.DOB.year'</span>).set(<span class="number">1982</span>);

<span class="keyword">var</span> year = m(<span class="string">'.info.DOB.year'</span>).get();</pre></div></div>
            
        </li>
        
        
        <li id="section-255">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-255">&#182;</a>
              </div>
              <p>1982</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> data = m(<span class="string">'.info'</span>).get();</pre></div></div>
            
        </li>
        
        
        <li id="section-256">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-256">&#182;</a>
              </div>
              <p>{ DOB: { year: 1982 } }</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> mData = m.get();</pre></div></div>
            
        </li>
        
        
        <li id="section-257">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-257">&#182;</a>
              </div>
              <p>{ info: { DOB: { year: 1982 } } }</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> m = <span class="keyword">new</span> Model;

m.on(<span class="regexp">/.*/</span>, onChange);

<span class="function"><span class="keyword">function</span> <span class="title">onChange</span><span class="params">(msg, data)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-258">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-258">&#182;</a>
              </div>
              <p>should be replaced with console if this demo is used</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	logger.log(msg, <span class="string">' : '</span>, data);
}

m(<span class="string">'.list[0].info.name'</span>).set(<span class="string">'Clifton'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-259">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-259">&#182;</a>
              </div>
              <p>logged:
.list  :  { type: &#39;added&#39;, newValue: [] }
.list[0]  :  { type: &#39;added&#39;, newValue: {} }
.list[0].info  :  { type: &#39;added&#39;, newValue: {} }
.list[0].info.name  :  { type: &#39;added&#39;, newValue: &#39;Clifton&#39; }</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>m(<span class="string">'.list[0].info.name'</span>).set(<span class="string">'Clifton Cunnigham'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-260">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-260">&#182;</a>
              </div>
              <p>logged:
.list[0].info.name  :  { type: &#39;changed&#39;,
  oldValue: &#39;Clifton&#39;,
  newValue: &#39;Clifton Cunnigham&#39; }</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> name = m(<span class="string">'.list[0].info.name'</span>).get();</pre></div></div>
            
        </li>
        
        
        <li id="section-261">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-261">&#182;</a>
              </div>
              <p>&#39;Clifton Cunnigham&#39;</p>
<p>m(&#39;.list[0].info.name&#39;).get.toString() :</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">()</span> {</span>
	<span class="keyword">var</span> m = <span class="keyword">this</span>._model._data;
	<span class="keyword">return</span> m.list &amp;&amp; m.list[<span class="number">0</span>] &amp;&amp; m.list[<span class="number">0</span>].info &amp;&amp; m.list[<span class="number">0</span>].info.name;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-262">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-262">&#182;</a>
              </div>
              <p>m(&#39;.list[0].info.name&#39;).set.toString() :</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">(value)</span> {</span>
	<span class="keyword">var</span> m = <span class="keyword">this</span>._model._data;
	<span class="keyword">if</span> (! m.list) {
		m.list = [];
		<span class="keyword">this</span>._model.postMessage(<span class="string">".list"</span>, { type: <span class="string">"added"</span>, newValue: [] } );
	}
	<span class="keyword">if</span> (! m.list[<span class="number">0</span>]) {
		m.list[<span class="number">0</span>] = {};
		<span class="keyword">this</span>._model.postMessage( <span class="string">".list[0]"</span>, { type: <span class="string">"added"</span>, newValue: {} } );
	}
	<span class="keyword">if</span> (! m.list[<span class="number">0</span>].info) {
		m.list[<span class="number">0</span>].info = {};
		<span class="keyword">this</span>._model.postMessage(<span class="string">".list[0].info"</span>, { type: <span class="string">"added"</span>, newValue: {} } );
	} 
	<span class="keyword">var</span> wasDef = m.list[<span class="number">0</span>].info.hasOwnProperty(<span class="string">"name"</span>);
	<span class="keyword">var</span> old = m.list[<span class="number">0</span>].info.name;
	m.list[<span class="number">0</span>].info.name = value;
	<span class="keyword">if</span> (! wasDef)
		<span class="keyword">this</span>._model.postMessage(<span class="string">".list[0].info.name"</span>,
			{ type: <span class="string">"added"</span>, newValue: value } );
	<span class="keyword">else</span> <span class="keyword">if</span> (old != value)
		<span class="keyword">this</span>._model.postMessage( <span class="string">".list[0].info.name"</span>,
			{ type: <span class="string">"changed"</span>, oldValue: old, newValue: value} );
}</pre></div></div>
            
        </li>
        
        
        <li id="section-263">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-263">&#182;</a>
              </div>
              <p><a name="model-path"></a></p>
<h3 id="model-path-utils">model path utils</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;


<span class="keyword">var</span> check = require(<span class="string">'../util/check'</span>)
	, Match = check.Match
	, _ = require(<span class="string">'mol-proto'</span>);

<span class="keyword">var</span> pathUtils = module.exports = {
	parseAccessPath: parseAccessPath,
	createRegexPath: createRegexPath,
	getPathNodeKey: getPathNodeKey,
	wrapMessengerMethods: wrapMessengerMethods
};


<span class="keyword">var</span> pathParsePattern = <span class="regexp">/\.[A-Za-z][A-Za-z0-9_]*|\[[0-9]+\]/g</span>
	, patternPathParsePattern = <span class="regexp">/\.[A-Za-z][A-Za-z0-9_]*|\[[0-9]+\]|\.\*|\[\*\]|\*/g</span>
	, pathNodeTypes = {
		<span class="string">'.'</span>: { syntax: <span class="string">'object'</span>, empty: <span class="string">'{}'</span> },
		<span class="string">'['</span>: { syntax: <span class="string">'array'</span>, empty: <span class="string">'[]'</span>},
		<span class="string">'*'</span>: { syntax: <span class="string">'star'</span>, empty: <span class="string">'{}'</span>}
	};

<span class="function"><span class="keyword">function</span> <span class="title">parseAccessPath</span><span class="params">(path, nodeParsePattern)</span> {</span>
	nodeParsePattern = nodeParsePattern || pathParsePattern;

	<span class="keyword">var</span> parsedPath = [];

	<span class="keyword">if</span> (! path)
		<span class="keyword">return</span> parsedPath;

	<span class="keyword">var</span> unparsed = path.replace(nodeParsePattern, <span class="function"><span class="keyword">function</span><span class="params">(nodeStr)</span> {</span>
		<span class="keyword">var</span> pathNode = { property: nodeStr };
		_.extend(pathNode, pathNodeTypes[nodeStr[<span class="number">0</span>]]); <span class="comment">// TODO maybe do some default value if not in map</span>
		parsedPath.push(pathNode);
		<span class="keyword">return</span> <span class="string">''</span>;
	});
	<span class="keyword">if</span> (unparsed)
		<span class="keyword">throw</span> <span class="keyword">new</span> ModelError(<span class="string">'incorrect model path: '</span> + path);

	<span class="keyword">return</span> parsedPath;
}


<span class="keyword">var</span> nodeRegex = {
	<span class="string">'.*'</span>: <span class="string">'\\.[A-Za-z][A-Za-z0-9_]*'</span>,
	<span class="string">'[*]'</span>: <span class="string">'\\[[0-9]+\\]'</span>
};
nodeRegex[<span class="string">'*'</span>] = nodeRegex[<span class="string">'.*'</span>] + <span class="string">'|'</span> + nodeRegex[<span class="string">'[*]'</span>];
<span class="function"><span class="keyword">function</span> <span class="title">createRegexPath</span><span class="params">(path)</span> {</span>
	check(path, Match.OneOf(String, RegExp));

	<span class="keyword">if</span> (path <span class="keyword">instanceof</span> RegExp || path.indexOf(<span class="string">'*'</span>) == -<span class="number">1</span>)
		<span class="keyword">return</span> path;

	<span class="keyword">var</span> parsedPath = pathUtils.parseAccessPath(path, patternPathParsePattern)
		, regexStr = <span class="string">'^'</span>
		, regexStrEnd = <span class="string">''</span>
		, patternsStarted = <span class="literal">false</span>;

	parsedPath.forEach(<span class="function"><span class="keyword">function</span><span class="params">(pathNode)</span> {</span>
		<span class="keyword">var</span> prop = pathNode.property
			, regex = nodeRegex[prop];
		
		<span class="keyword">if</span> (regex) {</pre></div></div>
            
        </li>
        
        
        <li id="section-264">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-264">&#182;</a>
              </div>
              <p>regexStr += &#39;(&#39; + regex;
regexStrEnd += &#39;|)&#39;;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			regexStr += <span class="string">'('</span> + regex + <span class="string">'|)'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-265">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-265">&#182;</a>
              </div>
              <p>regexStrEnd += &#39;|)&#39;;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			patternsStarted = <span class="literal">true</span>;
		} <span class="keyword">else</span> {
			<span class="keyword">if</span> (patternsStarted)
				<span class="keyword">throw</span> <span class="keyword">new</span> ModelError(<span class="string">'"*" path segment cannot be in the middle of the path: '</span> + path);
			regexStr += prop.replace(<span class="regexp">/(\.|\[|\])/g</span>, <span class="string">'\\$1'</span>);
		}
	});

	regexStr += <span class="comment">/* regexStrEnd + */</span> <span class="string">'$'</span>;

	<span class="keyword">try</span> {
		<span class="keyword">return</span> <span class="keyword">new</span> RegExp(regexStr);
	} <span class="keyword">catch</span> (e) {
		<span class="keyword">throw</span> <span class="keyword">new</span> ModelError(<span class="string">'can\'t construct regex for path pattern: '</span> + path);
	}
}


<span class="function"><span class="keyword">function</span> <span class="title">getPathNodeKey</span><span class="params">(pathNode)</span> {</span>
	<span class="keyword">var</span> prop = pathNode.property;
	<span class="keyword">return</span> pathNode.syntax == <span class="string">'array'</span>
		? prop.slice(<span class="number">1</span>, prop.length - <span class="number">1</span>)
		: prop.slice(<span class="number">1</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-266">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-266">&#182;</a>
              </div>
              <p>TODO allow for multiple messages in a string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">wrapMessengerMethods</span><span class="params">(methodsNames)</span> {</span>
	methodsNames.forEach(<span class="function"><span class="keyword">function</span><span class="params">(methodName)</span> {</span>
		<span class="keyword">var</span> origMethod = <span class="keyword">this</span>[methodName];</pre></div></div>
            
        </li>
        
        
        <li id="section-267">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-267">&#182;</a>
              </div>
              <p>replacing message subsribe/unsubscribe/etc. to convert &quot;*&quot; message patterns to regexps</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="keyword">this</span>[methodName] = <span class="function"><span class="keyword">function</span><span class="params">(path, subscriber)</span> {</span>
			<span class="keyword">var</span> regexPath = createRegexPath(path);
			origMethod.call(<span class="keyword">this</span>, regexPath, subscriber);
		};
	}, <span class="keyword">this</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-268">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-268">&#182;</a>
              </div>
              <p><a name="messenger"></a></p>
<h2 id="milo-messenger">milo messenger</h2>

            </div>
            
        </li>
        
        
        <li id="section-269">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-269">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> Mixin = require(<span class="string">'../abstract/mixin'</span>)
	, MessageSource = require(<span class="string">'./message_source'</span>)
	, _ = require(<span class="string">'mol-proto'</span>)
	, check = require(<span class="string">'../util/check'</span>)
	, Match = check.Match
	, MessengerError = require(<span class="string">'../util/error'</span>).Messenger;


<span class="keyword">var</span> Messenger = _.createSubclass(Mixin, <span class="string">'Messenger'</span>);

<span class="keyword">var</span> messagesSplitRegExp = Messenger.messagesSplitRegExp = <span class="regexp">/\s*(?:\,|\s)\s*/</span>;


_.extendProto(Messenger, {
	init: initMessenger, <span class="comment">// called by Mixin (superclass)</span>
	onMessage: registerSubscriber,
	offMessage: removeSubscriber,
	onMessages: registerSubscribers,
	offMessages: removeSubscribers,
	postMessage: postMessage,
	getSubscribers: getMessageSubscribers,
	_chooseSubscribersHash: _chooseSubscribersHash,
	_registerSubscriber: _registerSubscriber,
	_removeSubscriber: _removeSubscriber,
	_removeAllSubscribers: _removeAllSubscribers,
	_callPatternSubscribers: _callPatternSubscribers,
	_callSubscribers: _callSubscribers,
	_setMessageSource: _setMessageSource
});


Messenger.defaultMethods = {
	on: <span class="string">'onMessage'</span>,
	off: <span class="string">'offMessage'</span>,
	onMessages: <span class="string">'onMessages'</span>,
	offMessages: <span class="string">'offMessages'</span>,
	postMessage: <span class="string">'postMessage'</span>,
	getSubscribers: <span class="string">'getSubscribers'</span>
};


module.exports = Messenger;


<span class="function"><span class="keyword">function</span> <span class="title">initMessenger</span><span class="params">(hostObject, proxyMethods, messageSource)</span> {</span>
	check(messageSource, Match.Optional(MessageSource));</pre></div></div>
            
        </li>
        
        
        <li id="section-270">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-270">&#182;</a>
              </div>
              <p>hostObject and proxyMethods are used in Mixin
messenger data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre> 	Object.defineProperties(<span class="keyword">this</span>, {
 		_messageSubscribers: { value: {} },
 		_patternMessageSubscribers: { value: {} },
 		_messageSource: { value: messageSource, writable: <span class="literal">true</span> }
 	});

 	<span class="keyword">if</span> (messageSource)
 		messageSource.messenger = <span class="keyword">this</span>;
}


<span class="function"><span class="keyword">function</span> <span class="title">registerSubscriber</span><span class="params">(messages, subscriber)</span> {</span>
	check(messages, Match.OneOf(String, [String], RegExp));
	check(subscriber, Function); 

	<span class="keyword">if</span> (<span class="keyword">typeof</span> messages == <span class="string">'string'</span>)
		messages = messages.split(messagesSplitRegExp);

	<span class="keyword">var</span> subscribersHash = <span class="keyword">this</span>._chooseSubscribersHash(messages);

	<span class="keyword">if</span> (messages <span class="keyword">instanceof</span> RegExp)
		<span class="keyword">return</span> <span class="keyword">this</span>._registerSubscriber(subscribersHash, messages, subscriber);

	<span class="keyword">else</span> {
		<span class="keyword">var</span> wasRegistered = <span class="literal">false</span>;

		messages.forEach(<span class="function"><span class="keyword">function</span><span class="params">(message)</span> {</span>
			<span class="keyword">var</span> notYetRegistered = <span class="keyword">this</span>._registerSubscriber(subscribersHash, message, subscriber);			
			wasRegistered = wasRegistered || notYetRegistered;			
		}, <span class="keyword">this</span>);

		<span class="keyword">return</span> wasRegistered;
	}
}


<span class="function"><span class="keyword">function</span> <span class="title">_registerSubscriber</span><span class="params">(subscribersHash, message, subscriber)</span> {</span>
	<span class="keyword">if</span> (! (subscribersHash[message] &amp;&amp; subscribersHash[message].length)) {
		subscribersHash[message] = [];
		<span class="keyword">if</span> (message <span class="keyword">instanceof</span> RegExp)
			subscribersHash[message].pattern = message;
		<span class="keyword">var</span> noSubscribers = <span class="literal">true</span>;
		<span class="keyword">if</span> (<span class="keyword">this</span>._messageSource)
			<span class="keyword">this</span>._messageSource.onSubscriberAdded(message);
	}

	<span class="keyword">var</span> msgSubscribers = subscribersHash[message];
	<span class="keyword">var</span> notYetRegistered = noSubscribers || msgSubscribers.indexOf(subscriber) == -<span class="number">1</span>;

	<span class="keyword">if</span> (notYetRegistered)
		msgSubscribers.push(subscriber);

	<span class="keyword">return</span> notYetRegistered;
}


<span class="function"><span class="keyword">function</span> <span class="title">registerSubscribers</span><span class="params">(messageSubscribers)</span> {</span>
	check(messageSubscribers, Match.ObjectHash(Function));

	<span class="keyword">var</span> notYetRegisteredMap = _.mapKeys(messageSubscribers, <span class="function"><span class="keyword">function</span><span class="params">(subscriber, messages)</span> {</span>
		<span class="keyword">return</span> <span class="keyword">this</span>.onMessage(messages, subscriber);
	}, <span class="keyword">this</span>);

	<span class="keyword">return</span> notYetRegisteredMap;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-271">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-271">&#182;</a>
              </div>
              <p>removes all subscribers for the message if subscriber isn&#39;t supplied</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">removeSubscriber</span><span class="params">(messages, subscriber)</span> {</span>
	check(messages, Match.OneOf(String, [String], RegExp));
	check(subscriber, Match.Optional(Function)); 

	<span class="keyword">if</span> (<span class="keyword">typeof</span> messages == <span class="string">'string'</span>)
		messages = messages.split(messagesSplitRegExp);

	<span class="keyword">var</span> subscribersHash = <span class="keyword">this</span>._chooseSubscribersHash(messages);

	<span class="keyword">if</span> (messages <span class="keyword">instanceof</span> RegExp)
		<span class="keyword">return</span> <span class="keyword">this</span>._removeSubscriber(subscribersHash, messages, subscriber);

	<span class="keyword">else</span> {
		<span class="keyword">var</span> wasRemoved = <span class="literal">false</span>;

		messages.forEach(<span class="function"><span class="keyword">function</span><span class="params">(message)</span> {</span>
			<span class="keyword">var</span> subscriberRemoved = <span class="keyword">this</span>._removeSubscriber(subscribersHash, message, subscriber);			
			wasRemoved = wasRemoved || subscriberRemoved;			
		}, <span class="keyword">this</span>);

		<span class="keyword">return</span> wasRemoved;
	}
}


<span class="function"><span class="keyword">function</span> <span class="title">_removeSubscriber</span><span class="params">(subscribersHash, message, subscriber)</span> {</span>
	<span class="keyword">var</span> msgSubscribers = subscribersHash[message];
	<span class="keyword">if</span> (! msgSubscribers || ! msgSubscribers.length)
		<span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// nothing removed</span>

	<span class="keyword">if</span> (subscriber) {
		<span class="keyword">var</span> subscriberIndex = msgSubscribers.indexOf(subscriber);
		<span class="keyword">if</span> (subscriberIndex == -<span class="number">1</span>) 
			<span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// nothing removed</span>
		msgSubscribers.splice(subscriberIndex, <span class="number">1</span>);
		<span class="keyword">if</span> (! msgSubscribers.length)
			<span class="keyword">this</span>._removeAllSubscribers(subscribersHash, message);

	} <span class="keyword">else</span> 
		<span class="keyword">this</span>._removeAllSubscribers(subscribersHash, message);

	<span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// subscriber(s) removed</span>
}


<span class="function"><span class="keyword">function</span> <span class="title">_removeAllSubscribers</span><span class="params">(subscribersHash, message)</span> {</span>
	<span class="keyword">delete</span> subscribersHash[message];
	<span class="keyword">if</span> (<span class="keyword">this</span>._messageSource)
		<span class="keyword">this</span>._messageSource.onSubscriberRemoved(message);
}


<span class="function"><span class="keyword">function</span> <span class="title">removeSubscribers</span><span class="params">(messageSubscribers)</span> {</span>
	check(messageSubscribers, Match.ObjectHash(Function));

	<span class="keyword">var</span> subscriberRemovedMap = _.mapKeys(messageSubscribers, <span class="function"><span class="keyword">function</span><span class="params">(subscriber, messages)</span> {</span>
		<span class="keyword">return</span> <span class="keyword">this</span>.offMessages(messages, subscriber);
	}, <span class="keyword">this</span>);

	<span class="keyword">return</span> subscriberRemovedMap;	
}</pre></div></div>
            
        </li>
        
        
        <li id="section-272">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-272">&#182;</a>
              </div>
              <p>TODO - send event to messageSource</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">postMessage</span><span class="params">(message, data)</span> {</span>
	check(message, Match.OneOf(String, RegExp));

	<span class="keyword">var</span> subscribersHash = <span class="keyword">this</span>._chooseSubscribersHash(message);
	<span class="keyword">var</span> msgSubscribers = subscribersHash[message];

	<span class="keyword">this</span>._callSubscribers(message, data, msgSubscribers);

	<span class="keyword">if</span> (<span class="keyword">typeof</span> message == <span class="string">'string'</span>)
		<span class="keyword">this</span>._callPatternSubscribers(message, data);
}


<span class="keyword">var</span> regexpFlagsPattern = <span class="regexp">/\/((?:g|i|m|y)*)$/</span>;
<span class="function"><span class="keyword">function</span> <span class="title">_callPatternSubscribers</span><span class="params">(message, data)</span> {</span>
	_.eachKey(<span class="keyword">this</span>._patternMessageSubscribers, 
		<span class="function"><span class="keyword">function</span><span class="params">(patternSubscribers)</span> {</span>
			<span class="keyword">var</span> pattern = patternSubscribers.pattern;
			<span class="keyword">if</span> (pattern.test(message))
				<span class="keyword">this</span>._callSubscribers(message, data, patternSubscribers);
		}
	, <span class="keyword">this</span>);
}


<span class="function"><span class="keyword">function</span> <span class="title">_callSubscribers</span><span class="params">(message, data, msgSubscribers)</span> {</span>
	<span class="keyword">if</span> (msgSubscribers &amp;&amp; msgSubscribers.length)
		msgSubscribers.forEach(<span class="function"><span class="keyword">function</span><span class="params">(subscriber)</span> {</span>
			subscriber.call(<span class="keyword">this</span>._hostObject, message, data);
		}, <span class="keyword">this</span>);
}


<span class="function"><span class="keyword">function</span> <span class="title">getMessageSubscribers</span><span class="params">(message, includePatternSubscribers)</span> {</span>
	check(message, Match.OneOf(String, RegExp));

	<span class="keyword">var</span> subscribersHash = <span class="keyword">this</span>._chooseSubscribersHash(message);
	<span class="keyword">var</span> msgSubscribers = subscribersHash[message]
							? [].concat(subscribersHash[message])
							: [];</pre></div></div>
            
        </li>
        
        
        <li id="section-273">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-273">&#182;</a>
              </div>
              <p>pattern subscribers are incuded by default</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">if</span> (includePatternSubscribers !== <span class="literal">false</span> &amp;&amp; <span class="keyword">typeof</span> message == <span class="string">'string'</span>) {
		_.eachKey(<span class="keyword">this</span>._patternMessageSubscribers, 
			<span class="function"><span class="keyword">function</span><span class="params">(patternSubscribers, pattern)</span> {</span>
				<span class="keyword">if</span> (patternSubscribers &amp;&amp; patternSubscribers.length
						&amp;&amp; pattern.test(message))
					_.appendArray(msgSubscribers, patternSubscribers);
			}
		);
	}

	<span class="keyword">return</span> msgSubscribers.length
				? msgSubscribers
				: <span class="literal">undefined</span>;
}


<span class="function"><span class="keyword">function</span> <span class="title">_chooseSubscribersHash</span><span class="params">(message)</span> {</span>
	<span class="keyword">return</span> message <span class="keyword">instanceof</span> RegExp
				? <span class="keyword">this</span>._patternMessageSubscribers
				: <span class="keyword">this</span>._messageSubscribers;
}


<span class="function"><span class="keyword">function</span> <span class="title">_setMessageSource</span><span class="params">(messageSource)</span> {</span>
	check(messageSource, MessageSource);

 	Object.defineProperties(<span class="keyword">this</span>, {
 		_messageSource: { value: messageSource }
 	});
 	messageSource.messenger = <span class="keyword">this</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-274">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-274">&#182;</a>
              </div>
              <p><a name="messenger-source"></a></p>
<h3 id="messenger-source">messenger source</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> Mixin = require(<span class="string">'../abstract/mixin'</span>)
	, logger = require(<span class="string">'../util/logger'</span>)
	, toBeImplemented = require(<span class="string">'../util/error'</span>).toBeImplemented
	, _ = require(<span class="string">'mol-proto'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-275">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-275">&#182;</a>
              </div>
              <p>an abstract class for dispatching external to internal events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> MessageSource = _.createSubclass(Mixin, <span class="string">'MessageSource'</span>, <span class="literal">true</span>);

module.exports = MessageSource;


_.extendProto(MessageSource, {</pre></div></div>
            
        </li>
        
        
        <li id="section-276">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-276">&#182;</a>
              </div>
              <p>initializes messageSource - called by Mixin superclass</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	init: initMessageSource,</pre></div></div>
            
        </li>
        
        
        <li id="section-277">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-277">&#182;</a>
              </div>
              <p>called by Messenger to notify when the first subscriber for an internal message was added</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	onSubscriberAdded: onSubscriberAdded,</pre></div></div>
            
        </li>
        
        
        <li id="section-278">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-278">&#182;</a>
              </div>
              <p>called by Messenger to notify when the last subscriber for an internal message was removed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre> 	onSubscriberRemoved: onSubscriberRemoved,</pre></div></div>
            
        </li>
        
        
        <li id="section-279">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-279">&#182;</a>
              </div>
              <p>dispatches source message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre> 	dispatchMessage: dispatchSourceMessage,</pre></div></div>
            
        </li>
        
        
        <li id="section-280">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-280">&#182;</a>
              </div>
              <p>filters source message based on the data of the message - should be implemented in subclass</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	filterSourceMessage: dispatchAllSourceMessages,</pre></div></div>
            
        </li>
        
        
        <li id="section-281">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-281">&#182;</a>
              </div>
              <hr>
<p>Methods below must be implemented in subclass</p>

            </div>
            
        </li>
        
        
        <li id="section-282">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-282">&#182;</a>
              </div>
              <p>converts internal message type to external message type - should be implemented in subclass</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	translateToSourceMessage: toBeImplemented,</pre></div></div>
            
        </li>
        
        
        <li id="section-283">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-283">&#182;</a>
              </div>
              <p>adds listener to external message - should be implemented by subclass</p>

            </div>
            
            <div class="content"><div class='highlight'><pre> 	addSourceListener: toBeImplemented,</pre></div></div>
            
        </li>
        
        
        <li id="section-284">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-284">&#182;</a>
              </div>
              <p>removes listener from external message - should be implemented by subclass</p>

            </div>
            
            <div class="content"><div class='highlight'><pre> 	removeSourceListener: toBeImplemented,
});


<span class="function"><span class="keyword">function</span> <span class="title">initMessageSource</span><span class="params">()</span> {</span>
	Object.defineProperty(<span class="keyword">this</span>, <span class="string">'_internalMessages'</span>, { value: {} });
}


<span class="function"><span class="keyword">function</span> <span class="title">onSubscriberAdded</span><span class="params">(message)</span> {</span>
	<span class="keyword">var</span> sourceMessage = <span class="keyword">this</span>.translateToSourceMessage(message);

	<span class="keyword">if</span> (! sourceMessage) <span class="keyword">return</span>;

	<span class="keyword">if</span> (! <span class="keyword">this</span>._internalMessages.hasOwnProperty(sourceMessage)) {
		<span class="keyword">this</span>.addSourceListener(sourceMessage);
		<span class="keyword">this</span>._internalMessages[sourceMessage] = [];
	}
	<span class="keyword">var</span> internalMsgs = <span class="keyword">this</span>._internalMessages[sourceMessage];

	<span class="keyword">if</span> (internalMsgs.indexOf(message) == -<span class="number">1</span>)
		internalMsgs.push(message);
	<span class="keyword">else</span>
		logger.warn(<span class="string">'Duplicate notification received: for subscribe to internal message '</span> + message);
}


<span class="function"><span class="keyword">function</span> <span class="title">onSubscriberRemoved</span><span class="params">(message)</span> {</span>
	<span class="keyword">var</span> sourceMessage = <span class="keyword">this</span>.translateToSourceMessage(message);

	<span class="keyword">if</span> (! sourceMessage) <span class="keyword">return</span>;

	<span class="keyword">var</span> internalMsgs = <span class="keyword">this</span>._internalMessages[sourceMessage];

	<span class="keyword">if</span> (internalMsgs &amp;&amp; internalMsgs.length) {
		messageIndex = internalMsgs.indexOf(message);
		<span class="keyword">if</span> (messageIndex &gt;= <span class="number">0</span>) {
			internalMsgs.splice(messageIndex, <span class="number">1</span>);
			<span class="keyword">if</span> (internalMsgs.length == <span class="number">0</span>) {
				<span class="keyword">delete</span> <span class="keyword">this</span>._internalMessages[sourceMessage];
				<span class="keyword">this</span>.removeSourceListener(sourceMessage);
			}
		} <span class="keyword">else</span>
			unexpectedNotificationWarning();
	} <span class="keyword">else</span>
		unexpectedNotificationWarning();


	<span class="function"><span class="keyword">function</span> <span class="title">unexpectedNotificationWarning</span><span class="params">()</span> {</span>
		logger.warn(<span class="string">'notification received: un-subscribe from internal message '</span> + message
					 + <span class="string">' without previous subscription notification'</span>);
	}
}


<span class="function"><span class="keyword">function</span> <span class="title">dispatchSourceMessage</span><span class="params">(sourceMessage, data)</span> {</span>
	<span class="keyword">var</span> internalMsgs = <span class="keyword">this</span>._internalMessages[sourceMessage];

	<span class="keyword">if</span> (internalMsgs &amp;&amp; internalMsgs.length)
		internalMsgs.forEach(<span class="function"><span class="keyword">function</span><span class="params">(message)</span> {</span>
			<span class="keyword">if</span> (<span class="keyword">this</span>.filterSourceMessage
					&amp;&amp; <span class="keyword">this</span>.filterSourceMessage(sourceMessage, message, data))
				<span class="keyword">this</span>.messenger.postMessage(message, data);
		}, <span class="keyword">this</span>);
	<span class="keyword">else</span>
		logger.warn(<span class="string">'source message received for which there is no mapped internal message'</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-285">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-285">&#182;</a>
              </div>
              <p>can be overridden in subclass to implement filtering based on message data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">dispatchAllSourceMessages</span><span class="params">(sourceMessage, message, data)</span> {</span>
	<span class="keyword">return</span> <span class="literal">true</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-286">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-286">&#182;</a>
              </div>
              <p><a name="messenger-message"></a></p>
<h3 id="messenger-message-class">messenger message class</h3>
<p>Not currently used</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> check = require(<span class="string">'../util/check'</span>)
	, Match = check.Match;

module.exports = Message;

<span class="function"><span class="keyword">function</span> <span class="title">Message</span><span class="params">(message)</span> {</span>
	check(message, Object);
	check(message.type, Match.Where(IsNonEmptyString));
	check(message.sender, Match.Optional(Object));
	check(message.stack, Match.Optional([Object]));
	check(message.data, Match.Optional(Object));
	check(message.reciever, Match.Optional(Object));
	check(message.event, Match.Optional(Object));

	<span class="keyword">this</span>.type = message.type;
	<span class="keyword">this</span>.sender = message.sender;
	<span class="keyword">this</span>.stack = message.stack;
	<span class="keyword">this</span>.data = message.data;
	<span class="keyword">this</span>.reciever = message.reciever;
	<span class="keyword">this</span>.event = message.event;
}

<span class="function"><span class="keyword">function</span> <span class="title">IsNonEmptyString</span><span class="params">(str)</span> {</span>
	check(str, String);
	<span class="keyword">return</span> str.length &gt; <span class="number">0</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-287">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-287">&#182;</a>
              </div>
              <p><a name="attribute"></a></p>
<h2 id="attribute-class">attribute class</h2>

            </div>
            
        </li>
        
        
        <li id="section-288">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-288">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> _ = require(<span class="string">'mol-proto'</span>)
	, check = require(<span class="string">'../util/check'</span>)
	, Match = check.Match
	, toBeImplemented = require(<span class="string">'../util/error'</span>).toBeImplemented;</pre></div></div>
            
        </li>
        
        
        <li id="section-289">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-289">&#182;</a>
              </div>
              <p>an abstract attribute class for attribute parsing and validation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>module.exports = Attribute;

<span class="function"><span class="keyword">function</span> <span class="title">Attribute</span><span class="params">(el, name)</span> {</span>
	<span class="keyword">this</span>.name = name || <span class="keyword">this</span>.attrName();
	<span class="keyword">this</span>.el = el;
	<span class="keyword">this</span>.node = el.attributes[<span class="keyword">this</span>.name];
}

_.extendProto(Attribute, {
	get: get,
	set: set,</pre></div></div>
            
        </li>
        
        
        <li id="section-290">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-290">&#182;</a>
              </div>
              <p>should be defined in subclass</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	attrName: toBeImplemented,
	parse: toBeImplemented,
	validate: toBeImplemented,
	render: toBeImplemented,
	decorate: decorate
});</pre></div></div>
            
        </li>
        
        
        <li id="section-291">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-291">&#182;</a>
              </div>
              <p>get attribute value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">()</span> {</span>
	<span class="keyword">return</span> <span class="keyword">this</span>.el.getAttribute(<span class="keyword">this</span>.name);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-292">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-292">&#182;</a>
              </div>
              <p>set attribute value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">(value)</span> {</span>
	<span class="keyword">this</span>.el.setAttribute(<span class="keyword">this</span>.name, value);
}

<span class="function"><span class="keyword">function</span> <span class="title">decorate</span><span class="params">()</span> {</span>
	<span class="keyword">this</span>.set(<span class="keyword">this</span>.render());
}</pre></div></div>
            
        </li>
        
        
        <li id="section-293">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-293">&#182;</a>
              </div>
              <p><a name="attribute-bind"></a></p>
<h3 id="bind-attribute-class">bind attribute class</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> Attribute = require(<span class="string">'./index'</span>)
	, AttributeError = require(<span class="string">'../util/error'</span>).Attribute
	, config = require(<span class="string">'../config'</span>)
	, _ = require(<span class="string">'mol-proto'</span>)
	, check = require(<span class="string">'../util/check'</span>)
	, Match = check.Match;</pre></div></div>
            
        </li>
        
        
        <li id="section-294">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-294">&#182;</a>
              </div>
              <p>Matches;
:myView - only component name
View:myView - class and component name
[Events, Data]:myView - facets and component name
View[Events]:myView - class, facet(s) and component name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> attrRegExp= <span class="regexp">/^([^\:\[\]]*)(?:\[([^\:\[\]]*)\])?\:?([^:]*)$/</span>
	, facetsSplitRegExp = <span class="regexp">/\s*(?:\,|\s)\s*/</span>
	, attrTemplate = <span class="string">'%compClass%compFacets:%compName'</span>;


<span class="keyword">var</span> BindAttribute = _.createSubclass(Attribute, <span class="string">'BindAttribute'</span>, <span class="literal">true</span>);

_.extendProto(BindAttribute, {
	attrName: attrName,
	parse: parse,
	validate: validate,
	render: render
});


module.exports = BindAttribute;</pre></div></div>
            
        </li>
        
        
        <li id="section-295">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-295">&#182;</a>
              </div>
              <p>get attribute name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">attrName</span><span class="params">()</span> {</span>
	<span class="keyword">return</span> config.attrs[<span class="string">'bind'</span>];
}</pre></div></div>
            
        </li>
        
        
        <li id="section-296">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-296">&#182;</a>
              </div>
              <p>parse attribute</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">parse</span><span class="params">()</span> {</span>
	<span class="keyword">if</span> (! <span class="keyword">this</span>.node) <span class="keyword">return</span>;

	<span class="keyword">var</span> value = <span class="keyword">this</span>.get();

	<span class="keyword">if</span> (value)
		<span class="keyword">var</span> bindTo = value.match(attrRegExp);

	<span class="keyword">if</span> (! bindTo)
		<span class="keyword">throw</span> <span class="keyword">new</span> AttributeError(<span class="string">'invalid bind attribute '</span> + value);

	<span class="keyword">this</span>.compClass = bindTo[<span class="number">1</span>] || <span class="string">'Component'</span>;
	<span class="keyword">this</span>.compFacets = (bindTo[<span class="number">2</span>] &amp;&amp; bindTo[<span class="number">2</span>].split(facetsSplitRegExp)) || <span class="literal">undefined</span>;
	<span class="keyword">this</span>.compName = bindTo[<span class="number">3</span>] || <span class="literal">undefined</span>;

	<span class="keyword">return</span> <span class="keyword">this</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-297">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-297">&#182;</a>
              </div>
              <p>validate attribute</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">validate</span><span class="params">()</span> {</span>
	<span class="keyword">var</span> compName = <span class="keyword">this</span>.compName;
	check(compName, Match.Where(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
  		<span class="keyword">return</span> <span class="keyword">typeof</span> compName == <span class="string">'string'</span> &amp;&amp; compName != <span class="string">''</span>;
	}), <span class="string">'empty component name'</span>);

	<span class="keyword">if</span> (! <span class="keyword">this</span>.compClass)
		<span class="keyword">throw</span> <span class="keyword">new</span> AttributeError(<span class="string">'empty component class name '</span> + <span class="keyword">this</span>.compClass);

	<span class="keyword">return</span> <span class="keyword">this</span>;
}


<span class="function"><span class="keyword">function</span> <span class="title">render</span><span class="params">()</span> {</span>
	<span class="keyword">return</span> attrTemplate
				.replace(<span class="string">'%compClass'</span>, <span class="keyword">this</span>.compClass)
				.replace(<span class="string">'%compFacets'</span>, <span class="keyword">this</span>.compFacets
											? <span class="string">'['</span> + <span class="keyword">this</span>.compFacets.join(<span class="string">', '</span>) + <span class="string">']'</span>
											: <span class="string">''</span>)
				.replace(<span class="string">'%compName'</span>, <span class="keyword">this</span>.compName);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-298">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-298">&#182;</a>
              </div>
              <p><a name="attribute-load"></a></p>
<h3 id="load-attribute-class">load attribute class</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> Attribute = require(<span class="string">'./index'</span>)
	, AttributeError = require(<span class="string">'../util/error'</span>).Attribute
	, config = require(<span class="string">'../config'</span>)
	, _ = require(<span class="string">'mol-proto'</span>);


<span class="keyword">var</span> LoadAttribute = _.createSubclass(Attribute, <span class="string">'LoadAttribute'</span>, <span class="literal">true</span>);

_.extendProto(LoadAttribute, {
	attrName: getAttributeName,
	parse: parseAttribute,
	validate: validateAttribute
});

module.exports = LoadAttribute;


<span class="function"><span class="keyword">function</span> <span class="title">getAttributeName</span><span class="params">()</span> {</span>
	<span class="keyword">return</span> config.attrs.load;
}


<span class="function"><span class="keyword">function</span> <span class="title">parseAttribute</span><span class="params">()</span> {</span>
	<span class="keyword">if</span> (! <span class="keyword">this</span>.node) <span class="keyword">return</span>;

	<span class="keyword">var</span> value = <span class="keyword">this</span>.get();

	<span class="keyword">this</span>.loadUrl = value;

	<span class="keyword">return</span> <span class="keyword">this</span>;
}


<span class="function"><span class="keyword">function</span> <span class="title">validateAttribute</span><span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-299">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-299">&#182;</a>
              </div>
              <p>TODO url validation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">return</span> <span class="keyword">this</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-300">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-300">&#182;</a>
              </div>
              <p><a name="mixin"></a></p>
<h2 id="mixin-abstract-class">mixin abstract class</h2>

            </div>
            
        </li>
        
        
        <li id="section-301">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-301">&#182;</a>
              </div>
              <p>We also use Mixin pattern, but Mixin in milo is implemented as a separate object
that is stored on the property of the host object and can create proxy methods on
the host object if required. Classes Messenger, MessageSource and DataSource are
subclasses of Mixin abstract class.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> _ = require(<span class="string">'mol-proto'</span>)
	, check = require(<span class="string">'../util/check'</span>)
	, Match = check.Match
	, MixinError = require(<span class="string">'../util/error'</span>).Mixin;


module.exports = Mixin;</pre></div></div>
            
        </li>
        
        
        <li id="section-302">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-302">&#182;</a>
              </div>
              <p>an abstract class for mixin pattern - adding proxy methods to host objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">Mixin</span><span class="params">(hostObject, proxyMethods <span class="comment">/*, other args - passed to init method */</span>)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-303">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-303">&#182;</a>
              </div>
              <p>TODO - moce checks from Messenger here</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	check(hostObject, Match.Optional(Match.OneOf(Object, Function)));
	check(proxyMethods, Match.Optional(Match.ObjectHash(String)));

	Object.defineProperty(<span class="keyword">this</span>, <span class="string">'_hostObject'</span>, { value: hostObject });
	<span class="keyword">if</span> (proxyMethods)
		<span class="keyword">this</span>._createProxyMethods(proxyMethods);</pre></div></div>
            
        </li>
        
        
        <li id="section-304">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-304">&#182;</a>
              </div>
              <p>calling init if it is defined in the class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">if</span> (<span class="keyword">this</span>.init)
		<span class="keyword">this</span>.init.apply(<span class="keyword">this</span>, arguments);
}

_.extendProto(Mixin, {
	_createProxyMethod: _createProxyMethod,
	_createProxyMethods: _createProxyMethods
});


<span class="function"><span class="keyword">function</span> <span class="title">_createProxyMethod</span><span class="params">(mixinMethodName, proxyMethodName, hostObject)</span> {</span>
	hostObject = hostObject || <span class="keyword">this</span>._hostObject;

	<span class="keyword">if</span> (hostObject[proxyMethodName])
		<span class="keyword">throw</span> <span class="keyword">new</span> MixinError(<span class="string">'method '</span> + proxyMethodName +
								 <span class="string">' already defined in host object'</span>);

	check(<span class="keyword">this</span>[mixinMethodName], Function);</pre></div></div>
            
        </li>
        
        
        <li id="section-305">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-305">&#182;</a>
              </div>
              <p>Bind proxied messenger&#39;s method to messenger</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">var</span> boundMethod = <span class="keyword">this</span>[mixinMethodName].bind(<span class="keyword">this</span>);

	Object.defineProperty(hostObject, proxyMethodName,
		{ value: boundMethod, writable: <span class="literal">true</span> });
}


<span class="function"><span class="keyword">function</span> <span class="title">_createProxyMethods</span><span class="params">(proxyMethods, hostObject)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-306">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-306">&#182;</a>
              </div>
              <p>creating and binding proxy methods on the host object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	_.eachKey(proxyMethods, <span class="function"><span class="keyword">function</span><span class="params">(mixinMethodName, proxyMethodName)</span> {</span>
		<span class="keyword">this</span>._createProxyMethod(mixinMethodName, proxyMethodName, hostObject);
	}, <span class="keyword">this</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-307">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-307">&#182;</a>
              </div>
              <p><a name="registry"></a></p>
<h2 id="registry-abstract-class">registry abstract class</h2>

            </div>
            
        </li>
        
        
        <li id="section-308">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-308">&#182;</a>
              </div>
              <p><strong>Dependency inversion</strong></p>
<p>Components and Facets register themselves in registries that allows to avoid 
requiring them from one module. It prevents circular dependencies between modules.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">'use strict'</span>;

<span class="keyword">var</span> _ = require(<span class="string">'mol-proto'</span>)
	, check = require(<span class="string">'../util/check'</span>)
	, Match = check.Match;

module.exports = ClassRegistry;

<span class="function"><span class="keyword">function</span> <span class="title">ClassRegistry</span> <span class="params">(FoundationClass)</span> {</span>
	<span class="keyword">if</span> (FoundationClass)
		<span class="keyword">this</span>.setClass(FoundationClass);

	<span class="keyword">this</span>.__registeredClasses = {};
}

_.extendProto(ClassRegistry, {
	add: registerClass,
	get: getClass,
	remove: unregisterClass,
	clean: unregisterAllClasses,
	setClass: setFoundationClass
});


<span class="function"><span class="keyword">function</span> <span class="title">setFoundationClass</span><span class="params">(FoundationClass)</span> {</span>
	check(FoundationClass, Function);
	Object.defineProperty(<span class="keyword">this</span>, <span class="string">'FoundationClass'</span>, {
		enumerable: <span class="literal">true</span>,
		value: FoundationClass
	});
}

<span class="function"><span class="keyword">function</span> <span class="title">registerClass</span><span class="params">(aClass, name)</span> {</span>
	name = name || aClass.name;

	check(name, String, <span class="string">'class name must be string'</span>);
	check(name, Match.Where(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
		<span class="keyword">return</span> <span class="keyword">typeof</span> name == <span class="string">'string'</span> &amp;&amp; name != <span class="string">''</span>;
	}), <span class="string">'class name must be string'</span>);
	<span class="keyword">if</span> (<span class="keyword">this</span>.FoundationClass) {
		<span class="keyword">if</span> (aClass != <span class="keyword">this</span>.FoundationClass)
			check(aClass, Match.Subclass(<span class="keyword">this</span>.FoundationClass), <span class="string">'class must be a sub(class) of a foundation class'</span>);
	} <span class="keyword">else</span>
		<span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'foundation class must be set before adding classes to registry'</span>);

	<span class="keyword">if</span> (<span class="keyword">this</span>.__registeredClasses[name])
		<span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'is already registered'</span>);

	<span class="keyword">this</span>.__registeredClasses[name] = aClass;
};


<span class="function"><span class="keyword">function</span> <span class="title">getClass</span><span class="params">(name)</span> {</span>
	check(name, String, <span class="string">'class name must be string'</span>);
	<span class="keyword">return</span> <span class="keyword">this</span>.__registeredClasses[name];
};


<span class="function"><span class="keyword">function</span> <span class="title">unregisterClass</span><span class="params">(nameOrClass)</span> {</span>
	check(nameOrClass, Match.OneOf(String, Function), <span class="string">'class or name must be supplied'</span>);

	<span class="keyword">var</span> name = <span class="keyword">typeof</span> nameOrClass == <span class="string">'string'</span>
						? nameOrClass
						: nameOrClass.name;
						
	<span class="keyword">if</span> (! <span class="keyword">this</span>.__registeredClasses[name])
		<span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'class is not registered'</span>);

	<span class="keyword">delete</span> <span class="keyword">this</span>.__registeredClasses[name];
};


<span class="function"><span class="keyword">function</span> <span class="title">unregisterAllClasses</span><span class="params">()</span> {</span>
	<span class="keyword">this</span>.__registeredClasses = {};
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
